#LyX 2.2 created this file. For more info see http://www.lyx.org/
\lyxformat 508
\begin_document
\begin_header
\save_transient_properties true
\origin unavailable
\textclass article
\begin_preamble
\definecolor{fgcolor}{rgb}{0.345, 0.345, 0.345}\definecolor{messagecolor}{rgb}{0, 0, 0}\definecolor{warningcolor}{rgb}{1, 0, 1}\definecolor{errorcolor}{rgb}{1, 0, 0}\setlength{\headheight}{14.5pt}\usepackage{babel}


\definecolor{fgcolor}{rgb}{0.345, 0.345, 0.345}\definecolor{messagecolor}{rgb}{0, 0, 0}\definecolor{warningcolor}{rgb}{1, 0, 1}\definecolor{errorcolor}{rgb}{1, 0, 0}\usepackage{babel}
% macro for italic page numbers in the index
\newcommand{\IndexDef}[1]{\textit{#1}}
\newcommand{\IndexPrimary}[1]{\textbf{#1}}
% force a page break at the start of sections
\let\stdsection\section
\renewcommand{\section}{\newpage\stdsection}


% workaround for a makeindex bug,
% see sec. "Index Entry Order"
% only uncomment this when you are using makindex
%\let\OrgIndex\index 
%\renewcommand*{\index}[1]{\OrgIndex{#1}}
%\usepackage{splitidx}

% workaround for a makeindex bug,
% see sec. "Index Entry Order"
% only uncomment this when you are using makindex
\let\OrgIndex\index 
\renewcommand*{\index}[1]{\OrgIndex{#1}}
\usepackage{splitidx}
%\indexsetup{noclearpage}
\AtBeginDocument{
  \def\labelitemii{\(\circ\)}
  \def\labelitemiii{\(\triangleright\)}
}
\usepackage[font={normal,sl}]{caption}% set captions slanted

\IfFileExists{upquote.sty}{\usepackage{upquote}}{}

\newenvironment{lylist}[1]{\begin{list}{}
{\settowidth{\labelwidth}{#1}
\setlength{\leftmargin}{\labelwidth}
\addtolength{\leftmargin}{\labelsep}
\renewcommand{\makelabel}[1]{##1\hfil}}}{\end{list}}
\newcommand{\datetoday}{\number\day\space
     \ifcase\month\or January\or February\or March\or April\or May\or
     June\or July\or August\or September\or October\or November\or
     December\fi
     \space\number\year}
\newcommand{\EOLmemo}{\null \vskip-1.5truein
{\raggedright \textsf{\textsc{\large \textcolor{blue}{Earth Observing Laboratory}}}}\par
{\raggedright \textsf{\textsl{\textcolor{blue}{Memorandum:}}}} \par \vskip6pt
{\color{blue}{\hrule}}\par
\vskip0.3truein \leftline{\hskip \longindent \datetoday} \vskip0.2truein
\thispagestyle{empty}}
\newcommand{\attachm}[1]{\begin{lylist}{Attachments:00}
\item [Attachments:] {#1}
\end{lylist}}
\newcommand{\cc}[1]{\begin{lylist}{Attachments:00}
\item [cc:] {#1}
\end{lylist}}
\newcommand{\attach}[1]{\begin{lylist}{Attachments:00}
\item [Attachment:] {#1}
\end{lylist}}

\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\pagenumbering{gobble}
\end_preamble
\options 12pt,twoside,english
\use_default_options false
\begin_modules
knitr
\end_modules
\maintain_unincluded_children false
\language english
\language_package babel
\inputencoding auto
\fontencoding T1
\font_roman "times" "default"
\font_sans "helvet" "default"
\font_typewriter "lmtt" "default"
\font_math "auto" "auto"
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_osf false
\font_sf_scale 100 100
\font_tt_scale 100 100
\graphics default
\default_output_format pdf2
\output_sync 0
\bibtex_command bibtex
\index_command makeindex
\paperfontsize 12
\spacing single
\use_hyperref true
\pdf_title "Technical Note: Kalman Filter"
\pdf_author "William A. Cooper"
\pdf_subject "improvement of  wind measurements, GV"
\pdf_keywords "Kalman, wind,uncertainty, NCAR Research Aviation Facility, research aircraft, NCAR/EOL/RAF"
\pdf_bookmarks true
\pdf_bookmarksnumbered false
\pdf_bookmarksopen false
\pdf_bookmarksopenlevel 2
\pdf_breaklinks true
\pdf_pdfborder true
\pdf_colorlinks true
\pdf_backref section
\pdf_pdfusetitle false
\pdf_quoted_options " linkcolor=blue, citecolor={blue}"
\papersize letterpaper
\use_geometry true
\use_package amsmath 2
\use_package amssymb 0
\use_package cancel 0
\use_package esint 2
\use_package mathdots 0
\use_package mathtools 0
\use_package mhchem 0
\use_package stackrel 0
\use_package stmaryrd 0
\use_package undertilde 0
\cite_engine natbib
\cite_engine_type authoryear
\biblio_style plainnat
\use_bibtopic false
\use_indices true
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 0
\backgroundcolor #ffffff
\boxbgcolor #f7f7f7
\index Index
\shortcut idx
\color #008000
\end_index
\index Variable Names and Acronyms
\shortcut var
\color #00aaff
\end_index
\index List of Symbols
\shortcut lis
\color #ff0000
\end_index
\leftmargin 1.2in
\topmargin 1in
\rightmargin 1in
\bottommargin 1in
\secnumdepth 3
\tocdepth 2
\paragraph_separation skip
\defskip medskip
\quotes_language english
\papercolumns 1
\papersides 2
\paperpagestyle fancy
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Title
A Kalman Filter
\begin_inset Newline newline
\end_inset

to Improve Measurements of Wind
\begin_inset Newline newline
\end_inset

from NSF/NCAR Research Aircraft
\end_layout

\begin_layout Author
William A.
 Cooper
\end_layout

\begin_layout Date

\color red
DRAFT
\color inherit
 3/6/2017
\begin_inset Newline newline
\end_inset

(title page to be replaced by NCAR library template)
\end_layout

\begin_layout Standard
National Center for Atmospheric Research
\begin_inset Newline newline
\end_inset

Earth Observing Laboratory
\begin_inset Newline newline
\end_inset

Research Aviation Facility
\end_layout

\begin_layout Standard
\begin_inset VSpace vfill
\end_inset


\begin_inset Newpage cleardoublepage
\end_inset

 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
pagenumbering{roman}
\end_layout

\end_inset


\begin_inset CommandInset toc
LatexCommand tableofcontents

\end_inset

 
\begin_inset VSpace vfill
\end_inset


\begin_inset ERT
status collapsed

\begin_layout Plain Layout


\backslash
eject
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%% LyX 2.2.2 created this file.
  For more info, see http://www.lyx.org/.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\backslash
phantomsection 
\backslash
addcontentsline{toc}{section}{List of Figures}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset FloatList figure

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
clearpage %
\backslash
phantomsection 
\backslash
addcontentsline{toc}{section}{List of Tables}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset FloatList table

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Newpage clearpage
\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
renewcommand{
\backslash
abstractname}{Prefix and Abstract}
\end_layout

\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
thispagestyle{plain}
\end_layout

\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
begin{abstract}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
To improve the measurements of wind made from NSF/NCAR aircraft, a Kalman
 filter is developed and applied to archived data files from research projects.
 The filter is an error-state Kalman filter, and the emphasis is on improving
 the measurements of pitch and heading because they are usually the dominating
 source of uncertainty in measured wind.
 The NSF/NCAR Gulfstream V research aircraft is emphasized in the development,
 but the filter as developed can be applied to data from other present and
 past NCAR aircraft as well.
 So that the resulting filter can be applied in cases where the primary
 measurements from the inertial reference system were not recorded in the
 data file, a method is developed for retrieving those measurements by different
iating the recorded variables representing attitude angles and aircraft-velocity
 components.
 In addition, some new algorithms are introduced for estimating the rate
 of climb of the aircraft from the measured accelerations and for estimating
 the angle of attack from pressure measurements made at ports on the radome.
 In addition, simplified methods for estimating the errors in pitch and
 heading without the full complexity and processing requirements of the
 Kalman filter are documented.
 The result is that standard uncertainties in pitch and heading are reduced
 to about 0.01
\begin_inset Formula $^{\circ}$
\end_inset

, so that they no longer dominate the uncertainty in the wind measurements.
 Some examples illustrate the effects of the Kalman filter on measured wind
 and on variance spectra.
 The processing technique is incorporated into an R script that can add
 the improved variables to a standard netCDF data archive so that they can
 be made available for community use.
 Documents that are accessible via links in this technical document provide
 information on the workflow that generated the document, the details of
 the processing algorithms, and instructions for use and modification of
 the processing script.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
end{abstract}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Newpage clearpage
\end_inset


\end_layout

\begin_layout Section*
Acknowledgments
\end_layout

\begin_layout Standard
\begin_inset CommandInset label
LatexCommand label
name "sec:acknowledgements"

\end_inset


\end_layout

\begin_layout Standard
The research aircraft discussed in this technical note, the NSF/NCAR 
\begin_inset Index idx
status open

\begin_layout Plain Layout
aircraft!NSF/NCAR GV
\end_layout

\end_inset

Gulfstream V often called "HIAPER", was the result of an extensive effort
 both within and outside of NCAR, and at the National Science Foundation.
 Chris Webster's development and maintenance of the software used for data
 processing was a very important contribution to this effort.
 The technical staff of the NCAR Earth Observing Laboratory were involved
 in all stages of the development and operation of this research platform,
 and the project management staff, operations staff, and computing and data
 management groups of that Laboratory conducted the projects that produced
 the data used in this document.
 Without all these contributions, the measurements characterized in this
 document would not have been available to the community.
 NCAR is sponsored by the National Science Foundation (NSF), and the NSF
 also supported the experiments that collected the data used in this technical
 note.
\end_layout

\begin_layout Standard
The data used in the examples presented are from the 
\begin_inset Index var
status open

\begin_layout Plain Layout
DEEPWAVE=Deep Propagating Gravity Wave Experiment
\end_layout

\end_inset

DEEPWAVE
\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset

 project (Deep Propagating Gravity Wave Experiment over New Zealand), described
 at
\begin_inset Newline newline
\end_inset


\begin_inset CommandInset href
LatexCommand href
target "https://www.eol.ucar.edu/field_projects/deepwave"

\end_inset

.
 [NEED A DATA CITATION HERE] Measurements were collected by the DEEPWAVE
 experiment team, and flight operations and data acquisition and processing
 were performed by the Research Aviation Facility, Earth Observing Laboratory,
 National Center for Atmospheric Research (NCAR).
 The analyses reported here were mostly performed using R
\begin_inset CommandInset citation
LatexCommand citet
key "Rlanguage"

\end_inset

, with 
\begin_inset Index idx
status open

\begin_layout Plain Layout
RStudio
\end_layout

\end_inset

RStudio 
\begin_inset CommandInset citation
LatexCommand citet
key "RStudio2012"

\end_inset

 and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
knitr
\end_layout

\end_inset

knitr 
\begin_inset CommandInset citation
LatexCommand citet
key "Xie2014a,Xie2014b"

\end_inset

.
 Substantial use also was made of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
ggplot2
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!package!ggplot2
\end_layout

\end_inset

ggplot2 package 
\begin_inset CommandInset citation
LatexCommand citet
key "wickham2009"

\end_inset

 for R.
 The code used for the Kalman filter relies on the Jacobian function
\begin_inset Index idx
status open

\begin_layout Plain Layout
function!Jacobian
\end_layout

\end_inset

 in the R 
\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!package!numDeriv
\end_layout

\end_inset

package 
\begin_inset Quotes eld
\end_inset

numDeriv
\begin_inset Quotes erd
\end_inset

 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Jacobian!numerical evaluation
\end_layout

\end_inset

version 2016.8-1; cf.
\begin_inset space ~
\end_inset


\begin_inset CommandInset citation
LatexCommand citet
key "numDeriv"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
thispagestyle{plain}
\end_layout

\end_inset


\begin_inset Newpage clearpage
\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
thispagestyle{empty}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Newpage cleardoublepage
\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
pagenumbering{arabic}
\end_layout

\end_inset


\end_layout

\begin_layout Section
Introduction
\end_layout

\begin_layout Subsection
Overview
\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
overview!this document
\end_layout

\end_inset

A recent technical note (
\begin_inset CommandInset citation
LatexCommand citet
key "Cooper2016ncartn"

\end_inset

) discussed the uncertainty
\begin_inset Index idx
status open

\begin_layout Plain Layout
uncertainty!wind
\end_layout

\end_inset

 associated with 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!measurement
\end_layout

\end_inset

measurements of wind from the NSF/NCAR Gulfstream V
\begin_inset Index idx
status open

\begin_layout Plain Layout
aircraft!NSF/NCAR GV
\end_layout

\end_inset


\begin_inset Index var
status open

\begin_layout Plain Layout
GV=NSF/NCAR Gulfstream V
\end_layout

\end_inset

 research aircraft, hereafter called the GV.
\begin_inset Index idx
status open

\begin_layout Plain Layout
GV|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

aircraft!NSF/NCAR GV
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
NSF/NCAF GV|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

aircraft!NSF/NCAR GV
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

 The aircraft is owned by the 
\begin_inset Index var
status open

\begin_layout Plain Layout
NSF=National Science Foundation
\end_layout

\end_inset

National Science Foundation (NSF) and operated by the Research Aviation
 Facility
\begin_inset Index var
status open

\begin_layout Plain Layout
RAF=Research Aviation Facility
\end_layout

\end_inset

 (RAF), Earth Observing Laboratory (EOL), National Center for Atmospheric
 Research
\begin_inset Index var
status open

\begin_layout Plain Layout
NCAR=National Center for Atmospheric Research
\end_layout

\end_inset

 (NCAR).
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
aircraft!NSF/NCAR GV
\end_layout

\end_inset

 The components and algorithms
\begin_inset Index idx
status open

\begin_layout Plain Layout
algorithm!wind
\end_layout

\end_inset

 that comprise the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!**
\end_layout

\end_inset

wind-measuring system on the GV
\begin_inset Index idx
status open

\begin_layout Plain Layout
uncertainty!wind!technical note
\end_layout

\end_inset

 were documented in that reference, so that information will not be repeated
 here.
 The central content of that technical note was a detailed analysis of uncertain
ty
\begin_inset Index idx
status open

\begin_layout Plain Layout
uncertainty!analysis for wind
\end_layout

\end_inset

 for the wind measurements.
 The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
uncertainty!standard
\end_layout

\end_inset

standard uncertainty was estimated to be about 0.1
\begin_inset space ~
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-1}$
\end_inset

 for vertical wind
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!vertical!**
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!vertical!uncertainty
\end_layout

\end_inset

 and 0.4
\begin_inset space ~
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-1}$
\end_inset

 for each component of the horizontal 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!horizontal!uncertainty
\end_layout

\end_inset

wind.
 These estimates
\begin_inset Index idx
status open

\begin_layout Plain Layout
uncertainty!wind!estimate
\end_layout

\end_inset

 were based on the analyzed performance of the inertial navigation 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

system, and are lower than would be expected from direct specifications
 for that system.
 The largest contributions to uncertainty
\begin_inset Index idx
status open

\begin_layout Plain Layout
uncertainty!wind!largest sources
\end_layout

\end_inset

 were associated with the measurements
\begin_inset Index idx
status open

\begin_layout Plain Layout
pitch
\end_layout

\end_inset

 of pitch and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading
\end_layout

\end_inset

heading, for respectively the vertical and horizontal wind components.
 Improvement in the measurements of these 
\begin_inset Index idx
status open

\begin_layout Plain Layout
angle, attitude|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

attitude angle
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle
\end_layout

\end_inset

attitude angles therefore is the indicated step toward improved measurements
 of wind.
\end_layout

\begin_layout Standard
Two approaches are taken in the present technical note to improve the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
pitch
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
heading
\end_layout

\end_inset

key measurements.
 The first uses a simplified analysis of the strong coupling
\begin_inset Index idx
status open

\begin_layout Plain Layout
coupling!strong
\end_layout

\end_inset

 represented by the Schuler oscillation
\begin_inset Index idx
status open

\begin_layout Plain Layout
Schuler oscillation
\end_layout

\end_inset

 to evaluate errors in pitch
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading
\end_layout

\end_inset

 and combines this with a related analysis to find the correction in heading.
 The second implements a full error-state Kalman filter
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!error-state
\end_layout

\end_inset

 to produce adjusted measurements of the attitude angles
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle
\end_layout

\end_inset

 and also the ground-speed
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset

 components
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity
\end_layout

\end_inset

 and rate-of-climb of the aircraft.
 The agreement between these two methods then supports the validity of each,
 while the first provides a much simpler method for determining the corrections.
\end_layout

\begin_layout Standard
This introduction will discuss the steps involved in using an error-state
 Kalman filter to update 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from INS
\end_layout

\end_inset

measurements from the inertial systems
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
INS|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

navigation system, inertial
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

 on the aircraft
\begin_inset Index idx
status open

\begin_layout Plain Layout
aircraft!instrumentation!INS
\end_layout

\end_inset

 (which do not have internal Kalman filters) using reference 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS
\end_layout

\end_inset

measurements from a 
\begin_inset Index idx
status open

\begin_layout Plain Layout
GPS|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

navigation sysem, GPS
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

Global Positioning System
\begin_inset Index idx
status open

\begin_layout Plain Layout
aircraft!instrumentation!GPS
\end_layout

\end_inset

 (GPS) 
\begin_inset Index var
status open

\begin_layout Plain Layout
GPS=global positioning system
\end_layout

\end_inset

receiver.
 The measurements from the GPS receiver are very good for aircraft position
 and velocity, so the Kalman filter adds little to these measurements.
 The primary value of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!primary value
\end_layout

\end_inset

Kalman filter presented here is that it improves the measurements of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
pitch
\end_layout

\end_inset

pitch and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading
\end_layout

\end_inset

heading.
\begin_inset Index idx
status open

\begin_layout Plain Layout
global positioning system|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

navigation system, GPS
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Section
\begin_inset space ~
\end_inset

2 next will develop expressions for the derivatives
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
derivative!state vector|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

state vector, derivative
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

 of a nine-component 
\begin_inset Quotes eld
\end_inset

state vector
\begin_inset Quotes erd
\end_inset

 of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from INS
\end_layout

\end_inset

measurements
\begin_inset Index var
status open

\begin_layout Plain Layout
INS=inertial navigation system
\end_layout

\end_inset

 from the inertial navigation 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

system (INS), representing aircraft position, velocity, and attitude, and
 will show that these derivatives provide a reasonable basis for mechanization,
\begin_inset Index idx
status open

\begin_layout Plain Layout
mechanization!definition
\end_layout

\end_inset

 i.e., calculating the history of the state vector
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle
\end_layout

\end_inset

 of the aircraft from the basic 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU
\end_layout

\end_inset

measurements provided by the inertial reference 
\begin_inset Index var
status open

\begin_layout Plain Layout
IRU=inertial reference unit
\end_layout

\end_inset

unit
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial reference unit
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
IRU|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

inertial reference unit
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

 (IRU).
\begin_inset Index idx
status open

\begin_layout Plain Layout
body acceleration|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

acceleration
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
body rotation rate!see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

rotation rate of aircraft
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Foot
status open

\begin_layout Plain Layout
In this document, IRU will refer to the portion of the instrument that produces
 the basic measurements
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU
\end_layout

\end_inset

 of body acceleration and body rotation rate, while INS
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

 will refer to the full system that uses those basic 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from INS
\end_layout

\end_inset

measurements to propagate the position, velocity, and attitude angles
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle
\end_layout

\end_inset

 of the aircraft forward in time from an initial state determined during
 alignment
\begin_inset Index idx
status open

\begin_layout Plain Layout
alignment!INS
\end_layout

\end_inset

 of the instrument.
\end_layout

\end_inset

 Those basic measurements
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
aircraft!instrumentation!IRU
\end_layout

\end_inset

 are the vector rotation rate and vector acceleration
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset

 of the aircraft in an inertial 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!inertial
\end_layout

\end_inset

frame, so the test of the calculated derivatives
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

 is that the results for the sequence of state vectors
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!definition
\end_layout

\end_inset

 should be in reasonable agreement with the values provided by the INS.
 The importance of this step is that the validated state-vector derivative
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

 then will be used in implementation of the error-state Kalman 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!error-state
\end_layout

\end_inset

filter.
\end_layout

\begin_layout Standard
Section
\begin_inset space ~
\end_inset

3 is a diversion from the main development of this technical note.
 It discussed several ancillary topics:
\end_layout

\begin_layout Enumerate
\begin_inset Argument item:1
status open

\begin_layout Plain Layout
i.
\end_layout

\end_inset

 a new variable representing the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
rate of climb
\end_layout

\end_inset

rate of climb of the aircraft that is an improvement over the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
rate of climb
\end_layout

\end_inset

measurement provided by the INS; 
\end_layout

\begin_layout Enumerate
\begin_inset Argument item:1
status open

\begin_layout Plain Layout
ii.
\end_layout

\end_inset

a method for finding the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial reference unit
\end_layout

\end_inset

IRU-provided 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU!surrogate for
\end_layout

\end_inset

measurements
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial reference unit!surrogate for measurement
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
IRU|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

inertial reference unit
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

 of rotation and acceleration by differentiating the recorded attitude angles;
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle
\end_layout

\end_inset

 
\end_layout

\begin_layout Enumerate
\begin_inset Argument item:1
status open

\begin_layout Plain Layout
iii.
\end_layout

\end_inset

simplified algorithms
\begin_inset Index idx
status open

\begin_layout Plain Layout
algorithm!correct pitch
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
algorithm!correct heading
\end_layout

\end_inset

 for finding the errors
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading
\end_layout

\end_inset

 in pitch and heading; and 
\end_layout

\begin_layout Enumerate
\begin_inset Argument item:1
status open

\begin_layout Plain Layout
iv.
\end_layout

\end_inset

a revised empirical representation of angle of attack
\begin_inset Index idx
status open

\begin_layout Plain Layout
angle of attack!empirical representation
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
attack|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

angle of attack
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

.
 
\end_layout

\begin_layout Standard
The first is useful because the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial!rate of climb
\end_layout

\end_inset

INS internally updates the variable representing the vertical speed of the
 aircraft by comparison
\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!altitude
\end_layout

\end_inset

 to the pressure
\begin_inset Index idx
status open

\begin_layout Plain Layout
altitude of aircraft!pressure
\end_layout

\end_inset

 altitude, while the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!measurement
\end_layout

\end_inset

measurement of wind needs a variable representing the rate of change in
 geometric
\begin_inset Index idx
status open

\begin_layout Plain Layout
altitude of aircraft!geometric
\end_layout

\end_inset

 altitude.
 The second topic is needed because, for many of the early research projects
 using the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
aircraft!NSF/NCAR GV
\end_layout

\end_inset

GV, the body rotation rates
\begin_inset Index idx
status open

\begin_layout Plain Layout
rotation rate of aircraft!measurement
\end_layout

\end_inset

 and body accelerations
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!acceleration
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!rotation rate
\end_layout

\end_inset

  were not recorded, yet they are needed by the Kalman filter.
 Reconstructing them makes it possible to process those older 
\begin_inset Index idx
status open

\begin_layout Plain Layout
processing from archives
\end_layout

\end_inset

projects or to process from the standard data archives, 
\begin_inset Index idx
status open

\begin_layout Plain Layout
data!standard archive
\end_layout

\end_inset

which normally do not include the body rotations
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!rotation rate
\end_layout

\end_inset

 even if they were present in the original recorded file.
 The third topic provides a complementary approach to finding the same errors
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!attitude angle
\end_layout

\end_inset

 in attitude angles
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle
\end_layout

\end_inset

 that the Kalman filter will produce.
 It will provide a useful test of the results from that filter.
 Finally, Sect.
\begin_inset space ~
\end_inset

3.4 extends the discussion of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
sensitivity coefficient|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

angle of attack, empirical representation
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

sensitivity coefficients
\begin_inset Index idx
status open

\begin_layout Plain Layout
angle of attack!empirical representation
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
angle of attack!empirical representation
\end_layout

\end_inset

 contained in 
\begin_inset CommandInset citation
LatexCommand citet
key "Cooper2016ncartn"

\end_inset

 by presenting a new empirical representation that has advantages over the
 method used previously.
 Improved pitch 
\begin_inset Index idx
status open

\begin_layout Plain Layout
pitch
\end_layout

\end_inset

measurements lead to improved coefficients used in this empirical representation
, so that is an added benefit of the Kalman filter.
 These will find important uses in the implementation of the Kalman filter
 or the new calculation of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!measurement
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!**
\end_layout

\end_inset

wind that is based on the corrections it provides.
\end_layout

\begin_layout Standard
Section
\begin_inset space ~
\end_inset

4 then discusses the details of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!processing script
\end_layout

\end_inset

Kalman filter.
 A script based on the R programming language
\begin_inset Index idx
status open

\begin_layout Plain Layout
R language
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!program
\end_layout

\end_inset

 has been developed to calculate the estimated errors
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!estimate from Kalman filter
\end_layout

\end_inset

 from the Kalman filter, apply the indicated corrections to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!corrected
\end_layout

\end_inset

measured 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

state vector, and add those new variables to the standard netCDF
\begin_inset Index idx
status open

\begin_layout Plain Layout
netCDF!create new file
\end_layout

\end_inset

 data 
\begin_inset Index idx
status open

\begin_layout Plain Layout
file!data
\end_layout

\end_inset

file.
 This section includes discussion of the aspects of that code that represent
 the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!coding
\end_layout

\end_inset

Kalman filter.
 The results are shown and compared to reference results and to the alternate
 methods of determining the pitch and heading corrections as discussed in
 Sect.
\begin_inset space ~
\end_inset

3.
 
\end_layout

\begin_layout Standard
Section 5 shows examples of the measurements of wind
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!corrected, Kalman filter
\end_layout

\end_inset

 based on the corrected state vector.
 The conclusion of this section and the closing section summarize the value
 of the Kalman filter.
 At the end, there is also a list of netCDF variable names referred to in
 the text, with definitions, and an index.
\end_layout

\begin_layout Standard
A goal of this project has been to make this work internally documented
 and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reproducibility
\end_layout

\end_inset

reproducible, as discussed in the Appendix.
 The program
\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!interactive processing script
\end_layout

\end_inset

 that produces this document (via 
\begin_inset Index idx
status open

\begin_layout Plain Layout
LaTeX
\end_layout

\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
LaTeX
\end_layout

\end_inset

), named KalmanFilterTechNote.Rnw,
\begin_inset Index idx
status open

\begin_layout Plain Layout
program!file
\end_layout

\end_inset

 also performs all the calculations,
\begin_inset Index idx
status open

\begin_layout Plain Layout
program!for calculations
\end_layout

\end_inset

 generates the quoted results and figures (with a few exceptions), and produces
 the new archive
\begin_inset Index idx
status open

\begin_layout Plain Layout
data!new archive
\end_layout

\end_inset

 
\begin_inset Index idx
status open

\begin_layout Plain Layout
netCDF!create new file
\end_layout

\end_inset

file, so that program file contains everything needed to reproduce this
 work.
 Subsets of the data 
\begin_inset Index idx
status open

\begin_layout Plain Layout
file!data
\end_layout

\end_inset

files are also preserved and archived.
 Another document called the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
workflow document
\end_layout

\end_inset

workflow document (KalmanFilterWorkflow.pdf) accompanies this technical note
 and the generating program file.
 It serves several purposes, primarily to elaborate upon the material in
 the present document.
 Some of the derivations
\begin_inset Index idx
status open

\begin_layout Plain Layout
derivations!in workflow
\end_layout

\end_inset

 are justified in more detail, and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
instructions!R script
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!interactive processing script!instructions
\end_layout

\end_inset

instructions are provided for running the R script to add the corrected
 variables to a 
\begin_inset Index idx
status open

\begin_layout Plain Layout
netCDF
\end_layout

\end_inset

netCDF
\begin_inset Index var
status open

\begin_layout Plain Layout
netCDF=network common data format
\end_layout

\end_inset

 file.
 Some details of how that modification of an existing file is done are included
 in the workflow document, and there is also some discussion of methods
 that were explored but abandoned in the course of this work.
 The workflow document
\begin_inset Index idx
status open

\begin_layout Plain Layout
workflow document
\end_layout

\end_inset

 should provide valuable information to anyone wanting to modify the R script
 or use it to process archival
\begin_inset Index idx
status open

\begin_layout Plain Layout
data!standard archive
\end_layout

\end_inset

 data 
\begin_inset Index idx
status open

\begin_layout Plain Layout
file!data
\end_layout

\end_inset

files.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<initialization, echo=FALSE,include=FALSE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## This chunk loads some needed R packages, specifies the file used for
 the illustration
\end_layout

\begin_layout Plain Layout

## of mechanization, specifies the variables needed from the archive file,
 and
\end_layout

\begin_layout Plain Layout

## specifies some time shifts.
 The data file used here is not part of the standard
\end_layout

\begin_layout Plain Layout

## archives.
 It was produced specially to provide high-rate values of the measured
\end_layout

\begin_layout Plain Layout

## variables, and it is therefore preserved in .Rdata format so that file
 can be
\end_layout

\begin_layout Plain Layout

## archived and re-used to ensure reproducibility.
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

library(knitr)
\end_layout

\begin_layout Plain Layout

opts_chunk$set(echo=FALSE, include=FALSE, fig.lp="fig:")
\end_layout

\begin_layout Plain Layout

# note that fig.pos="center" gave errors, changed to fig.align
\end_layout

\begin_layout Plain Layout

opts_chunk$set(fig.width=6, fig.height=5, fig.align="center", digits=4)
\end_layout

\begin_layout Plain Layout

thisFileName <- "KalmanFilterTechNote"
\end_layout

\begin_layout Plain Layout

require(Ranadu, quietly = TRUE, warn.conflicts=FALSE)
\end_layout

\begin_layout Plain Layout

require(numDeriv)    ## needed for the jacobian() function
\end_layout

\begin_layout Plain Layout

library(signal)      ## used for filtering
\end_layout

\begin_layout Plain Layout

library(reshape2)    ## used with ggplot facet plots
\end_layout

\begin_layout Plain Layout

library(grid)
\end_layout

\begin_layout Plain Layout

options(stringsAsFactors=FALSE)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

CACHE <- TRUE
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## temporary; remove once Ranadu is updated
\end_layout

\begin_layout Plain Layout

source ('~/RStudio/Ranadu/R/theme_WAC.R')
\end_layout

\begin_layout Plain Layout

source ('~/RStudio/Ranadu/R/getNetCDF.R')
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

setwd ('~/RStudio/Ranadu/KalmanFilter')
\end_layout

\begin_layout Plain Layout

Directory <- DataDirectory ()
\end_layout

\begin_layout Plain Layout

Flight <- "rf15HR" 			
\end_layout

\begin_layout Plain Layout

Project = "DWIRU"     		
\end_layout

\begin_layout Plain Layout

ProjectDir <- "DEEPWAVE"
\end_layout

\begin_layout Plain Layout

fname = sprintf("%s%s/%s%s.nc", Directory, ProjectDir, Project, Flight)
\end_layout

\begin_layout Plain Layout

VarList <- c('BLATA', 'BLONGA', 'BNORMA', 'BPITCHR', 'BROLLR', 'BYAWR')
\end_layout

\begin_layout Plain Layout

VarList <- c(VarList, 'LAT', 'LON', 'ALT', 'GGLAT', 'GGLON', 'GGALT')
\end_layout

\begin_layout Plain Layout

VarList <- c(VarList, 'VEW', 'VNS', 'VSPD', 'GGVEW', 'GGVNS', 'GGVSPD')
\end_layout

\begin_layout Plain Layout

VarList <- c(VarList, 'PITCH', 'ROLL', 'THDG')
\end_layout

\begin_layout Plain Layout

ReloadData <- FALSE
\end_layout

\begin_layout Plain Layout

# ReloadData <- TRUE
\end_layout

\begin_layout Plain Layout

SaveRData <- sprintf("%s.Rdata", thisFileName)
\end_layout

\begin_layout Plain Layout

if (ReloadData) {
\end_layout

\begin_layout Plain Layout

  Data <- getNetCDF (fname, VarList, Start=31000, End=40000)
\end_layout

\begin_layout Plain Layout

  ## remove heading adjustments if added during initial processing
\end_layout

\begin_layout Plain Layout

  Z <- data.frame(getAttributes(Data$THDG, .print=FALSE))
\end_layout

\begin_layout Plain Layout

  if ('CalibrationCoefficients' %in% names(Z)) {
\end_layout

\begin_layout Plain Layout

    THDGoffset <- Z$CalibrationCoefficients[1]
\end_layout

\begin_layout Plain Layout

  } else {
\end_layout

\begin_layout Plain Layout

    THDGoffset <- 0
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

  ## re signs: assumed lag has been corrected, so use - sign to remove
\end_layout

\begin_layout Plain Layout

  if ('TimeLag' %in% names(Z)) {
\end_layout

\begin_layout Plain Layout

    Data$THDG <- ShiftInTime(Data$THDG, .rate=25, .shift=-Z$TimeLag[1])
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

  Data$THDG <- (Data$THDG - THDGoffset) %% 360
\end_layout

\begin_layout Plain Layout

  save (Data, file=SaveRData)
\end_layout

\begin_layout Plain Layout

} else {
\end_layout

\begin_layout Plain Layout

  load (file=SaveRData)
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

Cradeg <- pi/180
\end_layout

\begin_layout Plain Layout

## Remove time lags imposed during processing:
\end_layout

\begin_layout Plain Layout

for (V in VarList) {
\end_layout

\begin_layout Plain Layout

  if (V == 'THDG') {next}
\end_layout

\begin_layout Plain Layout

  Z <- data.frame(getAttributes(Data[, V], .print=FALSE))
\end_layout

\begin_layout Plain Layout

  ## re signs: assumed lag has been corrected, so use - sign to remove
\end_layout

\begin_layout Plain Layout

  if ('TimeLag' %in% names(Z)) {
\end_layout

\begin_layout Plain Layout

    Data[, V] <- ShiftInTime(Data[, V], .rate=25, .shift=-Z$TimeLag[1])
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

VV <- c('BLONGA', 'BLATA', 'BNORMA')
\end_layout

\begin_layout Plain Layout

.shift <- c(-50,-50,-50)
\end_layout

\begin_layout Plain Layout

names(.shift) <- VV
\end_layout

\begin_layout Plain Layout

for (V in VV) {
\end_layout

\begin_layout Plain Layout

  Data[, V] <- ShiftInTime (Data[, V], 25, .shift[V])
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

# Data[, 'VSPD'] <- ShiftInTime (Data[, 'VSPD'], 25, 40)
\end_layout

\begin_layout Plain Layout

# Data[, 'VEW'] <- ShiftInTime (Data[, 'VEW'], 25, 60)
\end_layout

\begin_layout Plain Layout

# Data[, 'VNS'] <- ShiftInTime (Data[, 'VNS'], 25, 60)
\end_layout

\begin_layout Plain Layout

Data[, 'PITCH'] <- ShiftInTime (Data[, 'PITCH'], 25, 20)
\end_layout

\begin_layout Plain Layout

Data[, 'ROLL'] <- ShiftInTime (Data[, 'ROLL'], 25, 20)
\end_layout

\begin_layout Plain Layout

.shift = 60
\end_layout

\begin_layout Plain Layout

## Get some derivatives used later (but better value are obtained later
\end_layout

\begin_layout Plain Layout

## via Savitzky-Golay polynomials.)
\end_layout

\begin_layout Plain Layout

Rate <- attr (Data, 'Rate')
\end_layout

\begin_layout Plain Layout

Data$pdot <- c(0, diff (Data$PITCH)) * Rate
\end_layout

\begin_layout Plain Layout

Data$rdot <- c(0, diff (Data$ROLL)) * Rate
\end_layout

\begin_layout Plain Layout

Data$hdot <- c(0, diff (Data$THDG))
\end_layout

\begin_layout Plain Layout

Data$hdot <- (Data$hdot + 540) %% 360 - 180
\end_layout

\begin_layout Plain Layout

Data$hdot <- Data$hdot * Rate
\end_layout

\begin_layout Plain Layout

shift <- -500 / Rate
\end_layout

\begin_layout Plain Layout

Data$pdot <- ShiftInTime (Data$pdot, Rate, shift)
\end_layout

\begin_layout Plain Layout

Data$rdot <- ShiftInTime (Data$rdot, Rate, shift)
\end_layout

\begin_layout Plain Layout

Data$hdot <- ShiftInTime (Data$hdot, Rate, shift)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Brief summary of the Kalman filter
\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
overview!Kalman filter
\end_layout

\end_inset

A 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!summary
\end_layout

\end_inset

Kalman filter provides a means of updating a sequence of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

state vectors (consisting, in the present case, of INS-provided 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from INS
\end_layout

\end_inset

measurements of position, velocity, and attitude angles
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle
\end_layout

\end_inset

) by comparison
\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!INS to GPS
\end_layout

\end_inset

 to an independent set of measurements (e.g., 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS
\end_layout

\end_inset

measurements of position and velocity).
 The updated 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

state vector obtained by this process consists of an appropriately weighted
 combination of the state vector projected forward using normal mechanization
\begin_inset Index idx
status open

\begin_layout Plain Layout
mechanization
\end_layout

\end_inset

 and the independent measurements from the GPS receiver.
 Because errors in the state vector
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!error in
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
error!state vector|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

state vector, error in
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

 are coupled,
\begin_inset Index idx
status open

\begin_layout Plain Layout
coupling!strong
\end_layout

\end_inset

 the update procedure can estimate errors in the attitude angles
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!attitude angle
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle!errors
\end_layout

\end_inset

 as well as in the components of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

state vector that are measured directly by the GPS receiver.
 This 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!corrected
\end_layout

\end_inset

correction to attitude angles
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle!correction
\end_layout

\end_inset

 is the primary reason for using a Kalman filter to improve the wind measurement
s.
\end_layout

\begin_layout Standard
The weighting of the projected-forward state vs.
\begin_inset space ~
\end_inset

new 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS
\end_layout

\end_inset

measurements from the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS receiver depends on estimates of the covariance
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!covariance
\end_layout

\end_inset

 matrix
\begin_inset Index idx
status open

\begin_layout Plain Layout
covariance|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

matrix, covariance
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

 describing the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

state vector as well as estimates of the noise
\begin_inset Index idx
status open

\begin_layout Plain Layout
noise
\end_layout

\end_inset

 contaminating the measurements from the GPS receiver and the accelerations
 and rotation rates from the IRU\SpecialChar endofsentence
 With proper weighting, the result should
 combine the good high-frequency response of the INS
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

 with the good long-term stability of the GPS-based measurements.
 The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!covariance
\end_layout

\end_inset

covariance matrix characterizing the state vector is updated as the 
\begin_inset Index var
status open

\begin_layout Plain Layout
KF=Kalman filter
\end_layout

\end_inset

filter is applied, but appropriate weighting depends on reasonable estimation
 of the other error terms.
\end_layout

\begin_layout Standard
The operation of the filter
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!matrices
\end_layout

\end_inset

 depends on sequential use of a set of matrices, so it is useful to define
 those as follows, where the variable names following the symbols are the
 R variable
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable names!in R code
\end_layout

\end_inset

 names used in the R code:
\end_layout

\begin_layout Labeling
\labelwidthstring 00.00.0000
\begin_inset Formula $\delta\mathbf{x}_{k}$
\end_inset


\begin_inset space ~
\end_inset

[SVE] The error-state vector
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-state vector
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!error-|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

error-state vector
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

 at time index 
\begin_inset Formula $k$
\end_inset

.
 In the present case, this consists of these 15 components:
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!estimated error
\end_layout

\end_inset

 estimated errors in position, aircraft velocity
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!**
\end_layout

\end_inset

, aircraft attitude, 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial reference unit
\end_layout

\end_inset

IRU-measured rotation rate
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!rotation rate
\end_layout

\end_inset

, and IRU-measured accelerations.
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!acceleration
\end_layout

\end_inset

 
\end_layout

\begin_layout Labeling
\labelwidthstring 00.00.0000
\begin_inset Formula $\mathbf{T}_{k|k-1}$
\end_inset


\begin_inset space ~
\end_inset

[dcm] The 15
\begin_inset Formula $\times$
\end_inset

15 state transition matrix
\begin_inset Index idx
status open

\begin_layout Plain Layout
state transition matrix|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

matrix, state transition
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!state transition
\end_layout

\end_inset

 based on the derivatives used for INS mechanization
\begin_inset Index idx
status open

\begin_layout Plain Layout
mechanization
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial!mechanization
\end_layout

\end_inset

, for the change from time 
\begin_inset Formula $k-1$
\end_inset

 to time 
\begin_inset Formula $k$
\end_inset

.
 Then 
\begin_inset Formula $\delta\mathbf{x}_{k}=\mathbf{T}_{k|k-1}\delta\mathbf{x}_{k-1}$
\end_inset

 where 
\begin_inset Formula $\mathbf{T}$
\end_inset

 combines the unit diagonal matrix with the time step
\begin_inset Index idx
status open

\begin_layout Plain Layout
time step
\end_layout

\end_inset

 multiplied by the derivative
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

  matrix describing the state transition.
 As applied to the state vector, a state transition vector would involve
 the derivatives used for normal mechanization to advance the state vector
 and so would duplicate the action of the internal INS data processing.
 As interpreted for an error-state Kalman 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!error-state
\end_layout

\end_inset

filter, the matrix 
\begin_inset Formula $\mathbf{T}$
\end_inset

 is obtained by calculating the Jacobian of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Jacobian!of derivative function
\end_layout

\end_inset

function
\begin_inset Index idx
status open

\begin_layout Plain Layout
function!producing the derivative vector
\end_layout

\end_inset

 of the state vector
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

 that produces that derivative
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

 vector, as a function of the error-state 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-state vector
\end_layout

\end_inset

components; i.e., 
\begin_inset Formula $T[i,\,j]$
\end_inset

 is the derivative of the 
\begin_inset Formula $i$
\end_inset

 component of that derivative function with respect to change in the 
\begin_inset Formula $j$
\end_inset

 component.
\end_layout

\begin_layout Labeling
\labelwidthstring 00.00.0000
\begin_inset Formula $\mathbf{V}$
\end_inset


\begin_inset space ~
\end_inset

[CV] The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!covariance
\end_layout

\end_inset

15
\begin_inset Formula $\times$
\end_inset

15 covariance matrix
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!covariance
\end_layout

\end_inset

 that applies to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

state vector 
\begin_inset Formula $\delta\mathbf{x}$
\end_inset

.
\end_layout

\begin_layout Labeling
\labelwidthstring 00.00.0000
\begin_inset Formula $\mathbf{K}$
\end_inset


\begin_inset space ~
\end_inset

[K] The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman-gain matrix
\end_layout

\end_inset

Kalman-gain matrix
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!Kalman gain
\end_layout

\end_inset

 representing how the error-state vector
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-state vector
\end_layout

\end_inset

 is updated using the current error state and the new 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS
\end_layout

\end_inset

measurements.
\end_layout

\begin_layout Labeling
\labelwidthstring 00.00.0000
\begin_inset Formula $\delta\mathbf{z}$
\end_inset


\begin_inset space ~
\end_inset

[DZ] The 6-component error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!measured INS-GPS
\end_layout

\end_inset

 vector containing the measured differences between the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

INS and GPS-based 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

measurements
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from INS
\end_layout

\end_inset

 of position and velocity.
 
\end_layout

\begin_layout Labeling
\labelwidthstring 00.00.0000
\begin_inset Formula $\mathbf{H}$
\end_inset


\begin_inset space ~
\end_inset

[H] The 15
\begin_inset Formula $\times$
\end_inset

6-component observation 
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!observation
\end_layout

\end_inset

matrix representing how the measured differences 
\begin_inset Formula $\delta\mathbf{z}$
\end_inset

 correspond to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-state vector
\end_layout

\end_inset

error-state vector.
 
\end_layout

\begin_layout Labeling
\labelwidthstring 00.00.0000
\begin_inset Formula $\mathbf{Q},\,\mathbf{R}$
\end_inset


\begin_inset space ~
\end_inset

[Q,
\begin_inset space ~
\end_inset

R] Matrices
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!noise
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!measurement noise
\end_layout

\end_inset

 representing respectively the noise contributions (15
\begin_inset Formula $\times$
\end_inset

15) characterizing the forward propagation of the error-
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-state vector
\end_layout

\end_inset

state vector and the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!noise in
\end_layout

\end_inset

measurements from the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS receiver (6
\begin_inset Formula $\times$
\end_inset

6).
\begin_inset Index idx
status open

\begin_layout Plain Layout
noise!measurement
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The approach taken here will be to use the error-
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-state vector
\end_layout

\end_inset

state vector that represents the difference between the best-estimate measuremen
ts and those originally provided by the INS.
 The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from INS
\end_layout

\end_inset

INS integration does not need to be duplicated; the reference integration
 is already available.
 However, the Kalman filter does need the derivative vector that leads to
 that forward 
\begin_inset Index idx
status open

\begin_layout Plain Layout
mechanization
\end_layout

\end_inset

integration, so the first step in this analysis was to develop a function
 for the derivative vector and validate it by comparing the mechanization
 that uses it to the available INS
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

-provided variables, as described in Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Mechanization"

\end_inset

.
 The Jacobian
\begin_inset Index idx
status open

\begin_layout Plain Layout
Jacobian!of derivative function
\end_layout

\end_inset

 of that derivative 
\begin_inset Index idx
status open

\begin_layout Plain Layout
function!derivative
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
derivative function
\end_layout

\end_inset

function, evaluated at current values for the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

state vector including 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU
\end_layout

\end_inset

measurements from the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial reference unit
\end_layout

\end_inset

IRU, then provides the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!state transition
\end_layout

\end_inset

matrix 
\begin_inset Formula $\mathbf{T}$
\end_inset

 used in this filter.
 The implementation of the Kalman filter outlined here then follows in Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "sec:The-Kalman-filter"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<utility-functions, include=TRUE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## check the rate of the file
\end_layout

\begin_layout Plain Layout

# ATT <- getAttributes(Data, .print=FALSE)
\end_layout

\begin_layout Plain Layout

# Rate <- DataFileInfo (fname)$Rate  ## only rates 1 and 25 supported
\end_layout

\begin_layout Plain Layout

dt <- 1/Rate               
\end_layout

\begin_layout Plain Layout

DL <- nrow(Data)
\end_layout

\begin_layout Plain Layout

OmegaE <- StandardConstant ('Omega')  ## Earth's rotation rate
\end_layout

\begin_layout Plain Layout

OmegaE <- 15*Cradeg/3600              ## better match to INS?
\end_layout

\begin_layout Plain Layout

Ree <- 6378137                        ## for radii of curvature
\end_layout

\begin_layout Plain Layout

Ecc <- 0.08181919
\end_layout

\begin_layout Plain Layout

Data$Grav <- Gravity (Data$LAT, Data$GGALT)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

source ('chunks/RotationCorrection.R')
\end_layout

\begin_layout Plain Layout

source ('chunks/STMFV.R')
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<INS-data, include=TRUE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

r <- setRange (Data, 31000, 35500)
\end_layout

\begin_layout Plain Layout

Data <- Data[r,]
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Section
The derivative of the state vector
\end_layout

\begin_layout Subsection
The procedure to be used
\begin_inset CommandInset label
LatexCommand label
name "subsec:mech-procedures"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

 The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

state vector used in this section will consist of the three components of
 position, three components of aircraft velocity
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!**
\end_layout

\end_inset

 relative to the Earth, and three attitude angles (pitch, roll and heading).
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle
\end_layout

\end_inset

 In later sections a different vector, the error-state 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-state vector
\end_layout

\end_inset

vector, will be used for the Kalman 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter
\end_layout

\end_inset

filter, and in that case three components of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU
\end_layout

\end_inset

measured rotation rate
\begin_inset Index idx
status open

\begin_layout Plain Layout
rotation rate of aircraft!measurement
\end_layout

\end_inset

 and three components of measured acceleration
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset

  will be added to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

state vector so that the Kalman filter can treat the possibility of error
 in the latter six components as well as the first nine.
 However, the purpose of this section is to develop expressions for the
 derivatives of the nine-component state vector in terms of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial reference unit
\end_layout

\end_inset

IRU-measured 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!rotation rate
\end_layout

\end_inset

rotation rates and accelerations and to demonstrate that the calculated
 derivatives lead to a reasonable mechanization
\begin_inset Index idx
status open

\begin_layout Plain Layout
mechanization
\end_layout

\end_inset

 that approximately duplicates the original calculations from the INS.
 It is not necessary or expected that this mechanization will produce an
 exact duplicate of the INS
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial!mechanization
\end_layout

\end_inset

 mechanization because the INS has high-rate data and timing information
 not available to this new calculation.
 However, if the results are reasonably close to those from the INS then
 that provides some evidence that the derivatives being calculated are reasonabl
y close to the correct values.
 These derivatives will then be used in the implementation of the Kalman
 filter, where the filter will adjust to compensate for any errors remaining
 in these derivatives.
 
\end_layout

\begin_layout Standard
The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
mechanization!outline
\end_layout

\end_inset

procedure used to produce variables corresponding to position, velocity,
 and attitude angles
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle
\end_layout

\end_inset

 for this test is as follows:
\end_layout

\begin_layout Enumerate
Initialize a 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

state vector 
\begin_inset Formula $\mathbf{x}$
\end_inset

 having these components:
\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Enumerate
\begin_inset Index idx
status open

\begin_layout Plain Layout
latitude
\end_layout

\end_inset

latitude, 
\begin_inset Index idx
status open

\begin_layout Plain Layout
longitude
\end_layout

\end_inset

longitude, altitude
\begin_inset Index idx
status open

\begin_layout Plain Layout
altitude of aircraft
\end_layout

\end_inset

 in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame!definition
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout

\emph on
l-
\emph default
frame|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

reference frame, 
\emph on
l-
\emph default
frame
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\emph on
l-
\emph default
frame, the local-level reference frame that rotates wiith the Earth and
 has axes pointing east, north, and upward at the location of the aircraft;
 .
 This reference frame, also called the local-level or ENU 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

reference frame, has axes pointing 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Earth!reference frame
\end_layout

\end_inset

east, north, and upward at the location of the aircraft;
\end_layout

\begin_layout Enumerate
east, north, and upward velocity in the 
\emph on
l-
\emph default
frame
\end_layout

\begin_layout Enumerate
\begin_inset Index idx
status open

\begin_layout Plain Layout
pitch!**
\end_layout

\end_inset

pitch, 
\begin_inset Index idx
status open

\begin_layout Plain Layout
roll!**
\end_layout

\end_inset

roll, heading
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!**
\end_layout

\end_inset

 in the 
\begin_inset Index idx
status collapsed

\begin_layout Plain Layout

\emph on
a-
\emph default
frame|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

reference frame, 
\emph on
a-
\emph default
frame
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\emph on
a-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame!definition
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset


\begin_inset Foot
status collapsed

\begin_layout Plain Layout
With appropriate transformations these calculations of attitude angles
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle
\end_layout

\end_inset

 can be performed in the 
\emph on
l-
\emph default
frame instead, and there are some advantages because the 
\emph on
l-
\emph default
frame values of errors
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
error!roll
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
error!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 in pitch and roll, respectively representing southward and westward tilts
 of the virtual inertial platform, are not mixed together when the heading
 changes as they are in the 
\emph on
a-
\emph default
frame.
 This was not done in the calculations presented here.
\end_layout

\end_inset

 (the reference frame of the aircraft; cf.
\begin_inset space ~
\end_inset

Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:deriv-array"

\end_inset

 item 2).
\end_layout

\end_deeper
\begin_layout Enumerate
For each time increment:
\begin_inset Separator latexpar
\end_inset


\end_layout

\begin_deeper
\begin_layout Enumerate
Calculate the time derivative of the state vector.
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

  In the case of the attitude angles,
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle!derivative
\end_layout

\end_inset

 this is done by calculating the derivative
\begin_inset Index idx
status open

\begin_layout Plain Layout
transformation matrix!derivative
\end_layout

\end_inset

 of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
transformation!beween reference frames|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

reference 
\begin_inset Newline newline
\end_inset

frame, transformation
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transformation 
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!coordinate transformation
\end_layout

\end_inset

matrix from the 
\emph on
a-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset

 to the 
\emph on
l-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 and then using the definition of components of that matrix to find the
 derivative of the attitude angles.
\end_layout

\begin_layout Enumerate
Use that derivative vector
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

  to increment the state vector, compensating for possible wrap-around of
 the heading at 0 and 360 deg so that values stay within that range.
\end_layout

\begin_layout Enumerate
save the nine components of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

state vector in a new tabulation that represents an independent 
\begin_inset Index idx
status open

\begin_layout Plain Layout
mechanization
\end_layout

\end_inset

mechanization of the IRU-provided 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU
\end_layout

\end_inset

measurements.
 These new results should then be in reasonable agreement with the INS integrati
on.
\end_layout

\end_deeper
\begin_layout Subsection
Components of the derivative array
\begin_inset CommandInset label
LatexCommand label
name "subsec:deriv-array"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

The derivatives are calculated as follows:
\end_layout

\begin_layout Enumerate
The position
\begin_inset Index idx
status open

\begin_layout Plain Layout
position!derivative
\end_layout

\end_inset

 derivatives are determined from the components of the velocity, {
\begin_inset Formula $v_{e},\,v_{n},\,v_{z}$
\end_inset

}.
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft
\end_layout

\end_inset

 The changes in latitude
\begin_inset Index idx
status open

\begin_layout Plain Layout
latitude
\end_layout

\end_inset

 and longitude
\begin_inset Index idx
status open

\begin_layout Plain Layout
longitude
\end_layout

\end_inset

 depend on the normal and meridional 
\begin_inset Index idx
status open

\begin_layout Plain Layout
radius of curvature!normal
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
radius of curvature!meridional
\end_layout

\end_inset

radii of curvature of the Earth
\begin_inset Index idx
status open

\begin_layout Plain Layout
Earth!radius|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

radius of curvature
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

, respectively denoted 
\begin_inset Formula $R_{n}$
\end_inset

 and 
\begin_inset Formula $R_{m}$
\end_inset

.
 
\begin_inset CommandInset citation
LatexCommand citet
key "noureldin2013fundamentals"

\end_inset

, pp.
\begin_inset space ~
\end_inset

4748, provide definitions of these radii and a detailed derivation.
 The derivatives of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
latitude!symbol
\end_layout

\end_inset

latitude 
\begin_inset Formula $\lambda$
\end_inset

 and longitude
\begin_inset Index idx
status open

\begin_layout Plain Layout
longitude!symbol
\end_layout

\end_inset

 
\begin_inset Formula $\Phi$
\end_inset

 are then
\begin_inset Newline newline
\end_inset


\begin_inset Formula 
\begin{eqnarray}
\dot{\lambda} & = & \frac{v_{n}}{R_{m}+z}\label{eq:dlat}\\
\dot{\Phi} & = & \frac{v_{e}}{(R_{n}+z)\cos\lambda}\label{eq:dlong}
\end{eqnarray}

\end_inset

where 
\begin_inset Formula $z$
\end_inset

 is the altitude of the aircraft,
\begin_inset Index idx
status open

\begin_layout Plain Layout
altitude of aircraft
\end_layout

\end_inset

 with the derivative
\begin_inset Newline newline
\end_inset


\begin_inset Formula 
\begin{eqnarray}
\dot{z} & = & v_{z}\label{eq:dz}
\end{eqnarray}

\end_inset

where dots over quantities denote the time derivatives.
\begin_inset Newline newline
\end_inset


\end_layout

\begin_layout Enumerate
The velocity
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!derivative
\end_layout

\end_inset

 derivatives are determined from the measured 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!acceleration
\end_layout

\end_inset

accelerations,
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset

  but the accelerations are measured in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame!definition
\end_layout

\end_inset


\emph on
a-
\emph default
frame, with axes such that the unit coordinate vectors
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame!unit vectors
\end_layout

\end_inset

 are 
\begin_inset Formula $\hat{x}$
\end_inset

 forward along the longitudinal axis of the aircraft,
\begin_inset Index idx
status open

\begin_layout Plain Layout
aircraft!coordinate system
\end_layout

\end_inset

 
\begin_inset Formula $\hat{y}$
\end_inset

 in the direction of the starboard wing, and 
\begin_inset Formula $\hat{z}$
\end_inset

 along the direction determined by their cross product and generally downward.
 These measurements of acceleration must be 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transformed to the 
\emph on
l-
\emph default
frame using the attitude angles
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle
\end_layout

\end_inset

 for 
\begin_inset Index idx
status open

\begin_layout Plain Layout
pitch!**
\end_layout

\end_inset

pitch, 
\begin_inset Index idx
status open

\begin_layout Plain Layout
roll!**
\end_layout

\end_inset

roll, and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!**
\end_layout

\end_inset

heading, denoted {
\begin_inset Formula $\theta,\,\phi,\,\psi$
\end_inset

}, because the components of velocity are defined in that frame.
 In addition, because the accelerations are measured in an inertial 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!inertial
\end_layout

\end_inset

frame, corrections must be made for the inertial forces
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial corrections
\end_layout

\end_inset

 that arise because the 
\emph on
l-
\emph default
frame is moving relative to the Earth and so is changing orientation, and
 because the rotation of the Earth
\begin_inset Index idx
status open

\begin_layout Plain Layout
Earth!rotation rate
\end_layout

\end_inset

 introduces additional Coriolis
\begin_inset Index idx
status open

\begin_layout Plain Layout
Coriolis|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

inertial corrections
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!Coriolis|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

inertial corrections
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

 accelerations relative to an inertial 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!inertial
\end_layout

\end_inset

frame.
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial corrections
\end_layout

\end_inset

 The coordinate
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!coordinate transformation
\end_layout

\end_inset

 transformation matrix that 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transforms a vector from the 
\emph on
a-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset

 to the 
\emph on
l-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 will be denoted 
\begin_inset Formula $\mathbf{R}_{a}^{l}$
\end_inset

 and consists of four sequential transformations, first a rotation by 
\begin_inset Formula $\phi$
\end_inset

 about the roll axis, then a rotation by 
\begin_inset Formula $\theta$
\end_inset

 about the pitch axis, then a rotation by 
\begin_inset Formula $\psi$
\end_inset

 about the resulting 
\begin_inset Formula $\hat{z}$
\end_inset

 axis, and finally exchange of the 
\begin_inset Formula $\hat{x}$
\end_inset

 and 
\begin_inset Formula $\hat{y}$
\end_inset

 components and reversal of the sign of the 
\begin_inset Formula $\hat{z}$
\end_inset

 component to change to the 
\emph on
l-
\emph default
frame reference
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame
\end_layout

\end_inset

 frame.
 The transformation was presented in detail by 
\begin_inset CommandInset citation
LatexCommand citet
key "Bulletin23"

\end_inset

, and is also specified and developed in the workflow document
\begin_inset Index idx
status open

\begin_layout Plain Layout
workflow document
\end_layout

\end_inset

 that accompanies this technical note.
 The 
\emph on
a-
\emph default
frame measurements of acceleration are 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transformed to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!acceleration!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\emph on
l-
\emph default
frame using this transformation 
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!coordinate transformation
\end_layout

\end_inset

matrix after the acceleration of gravity
\begin_inset Index idx
status open

\begin_layout Plain Layout
gravity
\end_layout

\end_inset

 is added to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!normal component
\end_layout

\end_inset

normal component because the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial reference unit
\end_layout

\end_inset

IRU reports the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU!normal acceleration
\end_layout

\end_inset

normal component of gravity as that with the acceleration of gravity subtracted.
 Then the transformed accelerations are corrected for apparent 
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial corrections
\end_layout

\end_inset

forces generated by the inertial forces.
 
\begin_inset CommandInset citation
LatexCommand citet
key "noureldin2013fundamentals"

\end_inset

, pp.
\begin_inset space ~
\end_inset

178179, give the equations used, and these are repeated in the workflow
 document.
\end_layout

\begin_layout Enumerate
Calculating the derivatives
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle!derivative
\end_layout

\end_inset

 of the attitude angles
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle!derivative
\end_layout

\end_inset

 is more involved.
 The attitude angles can be found if the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transformation matrix
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!coordinate transformation
\end_layout

\end_inset

 
\begin_inset Formula $\mathbf{R}_{a}^{l}$
\end_inset

 is known by using the definitions of the components of that matrix in terms
 of the attitude angles.
 For example, the [3, 1] component of that matrix is 
\begin_inset Formula $-\sin\theta$
\end_inset

, so 
\begin_inset Formula $\theta=-\arcsin(R_{a}^{l}[3,1])$
\end_inset

.
 The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!rotation rate!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

measured rotation rates, 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transformed to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\emph on
l-
\emph default
frame, give the derivative of the transformation matrix,
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!coordinate transformation!derivative
\end_layout

\end_inset

 except that again corrections for inertial effects
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial corrections
\end_layout

\end_inset

 arising from the Earth's 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Earth!rotation rate
\end_layout

\end_inset

rotation and the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame!motion of
\end_layout

\end_inset

motion of the 
\emph on
l-
\emph default
frame are needed.
 
\begin_inset CommandInset citation
LatexCommand citet
key "noureldin2013fundamentals"

\end_inset

, pp.
\begin_inset space ~
\end_inset

179180, also provide the required correction for the derivative of the
 transformation matrix, as documented further in the workflow 
\begin_inset Index idx
status open

\begin_layout Plain Layout
workflow document
\end_layout

\end_inset

document and the code.
 These corrections also are discussed in more detail in Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Rotations"

\end_inset

, equations (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Rla-dot"

\end_inset

)(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:Omega2-iaa"

\end_inset

).
\end_layout

\begin_layout Standard
The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative!function
\end_layout

\end_inset

function 
\begin_inset Quotes eld
\end_inset

STMFV
\begin_inset Quotes erd
\end_inset

 returns these 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

 derivatives, given the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

state vector and the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU
\end_layout

\end_inset

measurements from the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial reference unit
\end_layout

\end_inset

IRU\SpecialChar endofsentence
 The algorithms and code are complicated enough that validation is important,
 so several tests are made of the results in the remainder of this section.
\end_layout

\begin_layout Subsection
Tests of the derivatives
\end_layout

\begin_layout Subsubsection
Validating the transformed accelerations
\begin_inset CommandInset label
LatexCommand label
name "subsec:Checking-accelerations"

\end_inset

 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<check-accelerations, include=TRUE, digits=4, cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

options(scipen = 1, digits = 4)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

D1 <- Data  ## temporary; avoid making changes to the reference data.frame
\end_layout

\begin_layout Plain Layout

D1$Rn <- Ree / (1 - (Ecc*sin(D1$GGLAT*Cradeg))^2)^0.5
\end_layout

\begin_layout Plain Layout

D1$Rm <- D1$Rn * (1-Ecc^2) / (1-(Ecc*sin(D1$GGLAT*Cradeg))^2) + D1$GGALT
\end_layout

\begin_layout Plain Layout

D1$Rn <- D1$Rn + D1$GGALT
\end_layout

\begin_layout Plain Layout

D1$Grav <- Gravity (D1$LAT, D1$GGALT)
\end_layout

\begin_layout Plain Layout

PC <- CorrectPitch (D1)
\end_layout

\begin_layout Plain Layout

# D1$PITCH <- D1$PITCH - PC[, 1]
\end_layout

\begin_layout Plain Layout

# D1$ROLL <- D1$ROLL - PC[, 2]
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## adjust GPS velocity components for GPS antenna location
\end_layout

\begin_layout Plain Layout

LG <- -4.30 
\end_layout

\begin_layout Plain Layout

# D1$GGVEW <- D1$GGVEW - LG * D1$hdot * cos(D1$ROLL*Cradeg) * cos(D1$THDG*Cradeg
) * Cradeg
\end_layout

\begin_layout Plain Layout

# D1$GGVNS <- D1$GGVNS + LG * D1$hdot * cos(D1$ROLL*Cradeg) * sin(D1$THDG*Cradeg
) * Cradeg
\end_layout

\begin_layout Plain Layout

# D1$GGVSPD <- D1$GGVSPD - LG * (D1$pdot + D1$hdot * sin(D1$ROLL*Cradeg))
 * Cradeg
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

#interpolate if necessary: otherwise later filters fail
\end_layout

\begin_layout Plain Layout

MaxGap <- 1000
\end_layout

\begin_layout Plain Layout

for (V in c('GGVNS', 'GGVEW', 'GGVSPD', 'VNS', 'VEW', 'VSPD')) {
\end_layout

\begin_layout Plain Layout

  D1[, V] <- zoo::na.approx (as.vector (D1[, V]), maxgap=MaxGap, na.rm=FALSE)
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## smooth the measurements when determining derivatives
\end_layout

\begin_layout Plain Layout

.span <- 25    
\end_layout

\begin_layout Plain Layout

## The following are accelerations determined from derivatives of the INS
 and GPS velocities.
\end_layout

\begin_layout Plain Layout

## These should match the measured accelerations after transformation to
 the l-frame
\end_layout

\begin_layout Plain Layout

## and application of the rotation correction:
\end_layout

\begin_layout Plain Layout

D1$vndot <- signal::sgolayfilt (D1$GGVNS, 3, .span, m=1) * Rate  # m=1 for
 first deriv.
\end_layout

\begin_layout Plain Layout

D1$vedot <- signal::sgolayfilt (D1$GGVEW, 3, .span, m=1) * Rate
\end_layout

\begin_layout Plain Layout

D1$vudot <- signal::sgolayfilt (D1$GGVSPD, 3, .span, m=1) * Rate
\end_layout

\begin_layout Plain Layout

D1$vndot2 <- signal::sgolayfilt (D1$VNS, 3, .span, m=1) * Rate  # m=1 for
 first deriv.
\end_layout

\begin_layout Plain Layout

D1$vedot2 <- signal::sgolayfilt (D1$VEW, 3, .span, m=1) * Rate
\end_layout

\begin_layout Plain Layout

D1$vudot2 <- signal::sgolayfilt (D1$VSPD, 3, .span, m=1) * Rate
\end_layout

\begin_layout Plain Layout

## transform to the a-frame for comparison to the IRU:
\end_layout

\begin_layout Plain Layout

G <- D1$Grav
\end_layout

\begin_layout Plain Layout

VL <- matrix(c(D1$GGVEW, D1$GGVNS, D1$GGVSPD), ncol=3)
\end_layout

\begin_layout Plain Layout

VL2 <- matrix(c(D1$VEW, D1$VNS, D1$VSPD), ncol=3)
\end_layout

\begin_layout Plain Layout

LA <- matrix (c(D1$vedot, D1$vndot, -D1$vudot - G), ncol=3) + RotationCorrection
 (D1, VL) 
\end_layout

\begin_layout Plain Layout

LA2 <- matrix (c(D1$vedot2, D1$vndot2, -D1$vudot2 - G), ncol=3) + RotationCorrec
tion (D1, VL2)
\end_layout

\begin_layout Plain Layout

AA <- XformLA (D1, LA, .inverse=TRUE)
\end_layout

\begin_layout Plain Layout

AA2 <- XformLA (D1, LA2, .inverse=TRUE)
\end_layout

\begin_layout Plain Layout

AA[,3] <- AA[,3] - G
\end_layout

\begin_layout Plain Layout

AA2[,3] <- AA2[,3] - G
\end_layout

\begin_layout Plain Layout

fa1 <- lm(AA[, 1] ~ D1$BLONGA)
\end_layout

\begin_layout Plain Layout

fa2 <- lm(AA[, 2] ~ D1$BLATA)
\end_layout

\begin_layout Plain Layout

fa3 <- lm(AA[, 3] ~ D1$BNORMA)
\end_layout

\begin_layout Plain Layout

fb1 <- lm(AA2[, 1] ~ D1$BLONGA)
\end_layout

\begin_layout Plain Layout

fb2 <- lm(AA2[, 2] ~ D1$BLATA)
\end_layout

\begin_layout Plain Layout

fb3 <- lm(AA2[, 3] ~ D1$BNORMA)
\end_layout

\begin_layout Plain Layout

cfa1 <- coef(fa1); cfa2 <- coef(fa2); cfa3 <- coef(fa3)
\end_layout

\begin_layout Plain Layout

D1$BLONGA <- cfa1[1] + cfa1[2] * Data$BLONGA
\end_layout

\begin_layout Plain Layout

D1$BLATA  <- cfa2[1] + cfa2[2] * Data$BLATA
\end_layout

\begin_layout Plain Layout

D1$BNORMA <- cfa3[1] + cfa3[2] * Data$BNORMA
\end_layout

\begin_layout Plain Layout

AB <- matrix(c(D1$BLONGA, D1$BLATA, D1$BNORMA+G), ncol=3) #a-frame 
\end_layout

\begin_layout Plain Layout

AL <- XformLA (D1, AB)                                    #l-frame
\end_layout

\begin_layout Plain Layout

## now corrected for angular effects
\end_layout

\begin_layout Plain Layout

## See Noureldin et al, 2013, Eq.
 (5.55)
\end_layout

\begin_layout Plain Layout

RC <- RotationCorrection (D1, VL)
\end_layout

\begin_layout Plain Layout

AL <- AL - RC  ##### note this sign and prev call above -- checked!
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

## the resulting l-frame accelerations
\end_layout

\begin_layout Plain Layout

D1$LACCX <- AL[, 1]
\end_layout

\begin_layout Plain Layout

D1$LACCY <- AL[, 2]
\end_layout

\begin_layout Plain Layout

D1$LACCZ <- AL[, 3] + G
\end_layout

\begin_layout Plain Layout

D1$LACCZ <- -D1$LACCZ
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

## smooth to match GPS-velocity derivatives
\end_layout

\begin_layout Plain Layout

D1$LACCX <- signal::sgolayfilt (D1$LACCX, 3, .span, m=0)
\end_layout

\begin_layout Plain Layout

D1$LACCY <- signal::sgolayfilt (D1$LACCY, 3, .span, m=0)
\end_layout

\begin_layout Plain Layout

D1$LACCZ <- signal::sgolayfilt (D1$LACCZ, 3, .span, m=0)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

fm1 <- lm (D1$vedot ~ D1$LACCX)
\end_layout

\begin_layout Plain Layout

fm2 <- lm (D1$vndot ~ D1$LACCY)
\end_layout

\begin_layout Plain Layout

fm3 <- lm (D1$vudot ~ D1$LACCZ)
\end_layout

\begin_layout Plain Layout

fn1 <- lm (D1$vedot2 ~ D1$LACCX)
\end_layout

\begin_layout Plain Layout

fn2 <- lm (D1$vndot2 ~ D1$LACCY)
\end_layout

\begin_layout Plain Layout

fn3 <- lm (D1$vudot2 ~ D1$LACCZ)
\end_layout

\begin_layout Plain Layout

c01 <- summary(fm1)$coef[1]
\end_layout

\begin_layout Plain Layout

c11 <- summary(fm1)$coef[2]
\end_layout

\begin_layout Plain Layout

s1 <- summary(fm1)$sigma
\end_layout

\begin_layout Plain Layout

r1 <- summary(fm1)$r.squared
\end_layout

\begin_layout Plain Layout

c02 <- summary(fm2)$coef[1]
\end_layout

\begin_layout Plain Layout

c12 <- summary(fm2)$coef[2]
\end_layout

\begin_layout Plain Layout

s2 <- summary(fm2)$sigma
\end_layout

\begin_layout Plain Layout

r2 <- summary(fm2)$r.squared
\end_layout

\begin_layout Plain Layout

c03 <- summary(fm3)$coef[1]
\end_layout

\begin_layout Plain Layout

c13 <- summary(fm3)$coef[2]
\end_layout

\begin_layout Plain Layout

s3 <- summary(fm3)$sigma
\end_layout

\begin_layout Plain Layout

r3 <- summary(fm3)$r.squared
\end_layout

\begin_layout Plain Layout

c04 <- summary(fn1)$coef[1]
\end_layout

\begin_layout Plain Layout

c14 <- summary(fn1)$coef[2]
\end_layout

\begin_layout Plain Layout

s4 <- summary(fn1)$sigma
\end_layout

\begin_layout Plain Layout

r4 <- summary(fn1)$r.squared
\end_layout

\begin_layout Plain Layout

c05 <- summary(fn2)$coef[1]
\end_layout

\begin_layout Plain Layout

c15 <- summary(fn2)$coef[2]
\end_layout

\begin_layout Plain Layout

s5 <- summary(fn2)$sigma
\end_layout

\begin_layout Plain Layout

r5 <- summary(fn2)$r.squared
\end_layout

\begin_layout Plain Layout

c06 <- summary(fn3)$coef[1]
\end_layout

\begin_layout Plain Layout

c16 <- summary(fn3)$coef[2]
\end_layout

\begin_layout Plain Layout

s6 <- summary(fn3)$sigma
\end_layout

\begin_layout Plain Layout

r6 <- summary(fn3)$r.squared
\end_layout

\begin_layout Plain Layout

options(digits=5)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

The components of acceleration
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset

  expressed in the 
\emph on
l-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 can be compared to the accelerations determined by differentiating either
 the INS-provided or the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based measurements of aircraft velocity.
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft
\end_layout

\end_inset

 The former is a test of the calculation; the latter is a test of the calibratio
n
\begin_inset Index idx
status open

\begin_layout Plain Layout
calibration!accelerometer
\end_layout

\end_inset

 of the accelerometers.
 The derivatives of the velocity
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!derivative
\end_layout

\end_inset

 were determined by taking differences between consecutive measurements,
 although it was useful to 
\begin_inset Index idx
status open

\begin_layout Plain Layout
smoothing
\end_layout

\end_inset

smooth the result using a Savitzky-Golay
\begin_inset Index idx
status open

\begin_layout Plain Layout
polynomial!Savitzky-Golay
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!Savitzky-Golay
\end_layout

\end_inset

 third-order polynomial spanning 11 25-Hz samples to reduce noise arising
 from the limited resolution of the differences.
 
\end_layout

\begin_layout Standard
Relative timing among the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!time lag
\end_layout

\end_inset

measurements can influence these results.
 Many of the variables have corrections applied for assumed time-lags during
 measurement, so in this test of accelerations those lags
\begin_inset Index idx
status open

\begin_layout Plain Layout
time lag
\end_layout

\end_inset

 were first removed.
 Then there were additional lags apparent among variables provided by the
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

INS, even when tagged with the same times.
 To determine these lags, a pitch 
\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver!pitch
\end_layout

\end_inset

maneuver (where the pilots induce rapid changes in pitch with associated
 climbs and descents during straight flight) from DEEPWAVE
\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project!full name
\end_layout

\end_inset

 (
\begin_inset Quotes eld
\end_inset

Deep Propagating Gravity Wave Experiment over New Zealand
\begin_inset Quotes erd
\end_inset

) research flight 15, 3 July 2014, 3:16:003:18:00 UTC was used.
 Shifting among the measurements from the INS was explored to see what provided
 the best agreement between measured accelerations (variables 
\begin_inset Index var
status open

\begin_layout Plain Layout
BLONGA: body-longitudinal acceleration
\end_layout

\end_inset

BLONGA, 
\begin_inset Index var
status open

\begin_layout Plain Layout
BLATA: body-lateral acceleration
\end_layout

\end_inset

BLATA, 
\begin_inset Index var
status open

\begin_layout Plain Layout
BNORMA: body-normal acceleration
\end_layout

\end_inset

BNORMA)
\begin_inset Index idx
status open

\begin_layout Plain Layout
file!data!variable|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

netCDF Variable Names
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files|seealso 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

 netCDF Variable Names
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!BLONGA
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!BLATA
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!BNORMA
\end_layout

\end_inset

 and the accelerations determined by differentiating the INS variables for
 aircraft velocity
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft
\end_layout

\end_inset

 (
\begin_inset Index var
status open

\begin_layout Plain Layout
VEW: ground speed eastward, INS
\end_layout

\end_inset

VEW, 
\begin_inset Index var
status open

\begin_layout Plain Layout
VNS: ground speed northward, INS
\end_layout

\end_inset

VNS, 
\begin_inset Index var
status open

\begin_layout Plain Layout
VSPD: rate of climb, INS
\end_layout

\end_inset

VSPD)
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!VEW
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!VNS
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!VSPD
\end_layout

\end_inset

 and then transforming
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

 the resulting accelerations to the 
\emph on
a-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset

 (where the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial reference unit
\end_layout

\end_inset

IRU 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU
\end_layout

\end_inset

measures accelerations).
 That transformation must include correction for inertial effects
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial corrections
\end_layout

\end_inset

  as discussed in Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:deriv-array"

\end_inset

, item 2.
 The standard deviation
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!acceleration
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
standard deviation|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

deviation, standard
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

 of the difference between the measured acceleration and that determined
 by differentiating the measured aircraft velocity was minimized if the
 measurements of acceleration were moved 50
\begin_inset space ~
\end_inset

ms earlier in time, the measurements of pitch and roll were shifted 20
\begin_inset space ~
\end_inset

ms later in time, and no shift was applied to the measurements of aircraft
 velocity.
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!time lag
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
time lag
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
time lag
\end_layout

\end_inset

 These shifts are all important only in relation to each other; the same
 result was obtained if the accelerations were moved earlier by 70
\begin_inset space ~
\end_inset

ms, measurements of velocity moved earlier by 20
\begin_inset space ~
\end_inset

ms, and measurements of pitch and roll left unshifted.
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!time lag
\end_layout

\end_inset

According to the specifications for the INS, there may be lags in the times
 when variables are transmitted from the unit of up to about 70
\begin_inset space ~
\end_inset

ms for accelerations and attitude angles
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle!lag
\end_layout

\end_inset

 and up to 110
\begin_inset space ~
\end_inset

ms for velocity components, so these shifts are within the approximate range
 expected.
 For the purpose of comparing accelerations, the optimal shifts were applied
 to the measurements for this pitch maneuver.
\begin_inset Foot
status open

\begin_layout Plain Layout
There is no assurance that these shifts will be constant.
\end_layout

\end_inset


\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="5" columns="5">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\emph on
fit
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $c_{0}$
\end_inset

 [m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

]
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $c_{1}$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $\sigma$
\end_inset

 [m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

]
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $R^{2}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
GPS east
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{c01}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{c11}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{s1}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{r1}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
GPS north
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{c02}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{c12}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{s2}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{r2}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
INS east
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{c04}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{c14}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{s4}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{r4}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
INS north
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{c05}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{c15}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{s5}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{r5}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Results
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

 of regression fitting the 
\emph on
l-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from INS
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS
\end_layout

\end_inset

acceleration
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset

  as a function of the derivative
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!derivative
\end_layout

\end_inset

 of the variable listed in the 
\begin_inset Quotes eld
\end_inset

fit
\begin_inset Quotes erd
\end_inset

 column.
 The coefficients
\begin_inset Index idx
status open

\begin_layout Plain Layout
calibration!accelerometer!fit coefficients
\end_layout

\end_inset

 represent, for example, 
\begin_inset Formula $\dot{v}_{e}\sim c_{0}+c_{1}a_{e}^{l}$
\end_inset

 where 
\begin_inset Formula $a_{e}^{l}$
\end_inset

 is the eastward component of acceleration after 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transformation to the 
\emph on
l-
\emph default
frame.
 The residual standard deviation
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!fit residual
\end_layout

\end_inset

 is tabulated as 
\begin_inset Formula $\sigma,$
\end_inset

 and the square of the correlation coefficient is 
\begin_inset Formula $R^{2}$
\end_inset

.
\begin_inset CommandInset label
LatexCommand label
name "tab:accel-fits"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="4" columns="3">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\emph on
Component
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $c_{0}$
\end_inset

 [m
\begin_inset space ~
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

 ]
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $c_{1}$
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
BLONGA
\begin_inset Index var
status open

\begin_layout Plain Layout
BLONGA: body-longitudinal acceleration
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{summary(fa1)$coef[1]}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{summary(fa1)$coef[2]}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
BLATA
\begin_inset Index var
status open

\begin_layout Plain Layout
BLATA: body-lateral acceleration
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{summary(fa2)$coef[1]}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{summary(fa2)$coef[2]}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Index var
status open

\begin_layout Plain Layout
BNORMA: body-normal acceleration
\end_layout

\end_inset

BNORMA
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{summary(fa3)$coef[1]}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{summary(fa3)$coef[2]}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Results like those in the preceding table but for 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU!calibration
\end_layout

\end_inset

accelerations
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset

  in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset


\emph on
a-
\emph default
frame.
\begin_inset CommandInset label
LatexCommand label
name "tab:a-frame-fits"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Table 
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:accel-fits"

\end_inset

 shows the results of linear 
\begin_inset Index idx
status open

\begin_layout Plain Layout
fit!regression!acceleration
\end_layout

\end_inset

fits of the measured accelerations
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!fits
\end_layout

\end_inset

 after 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transformation to the 
\emph on
l-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 (with inertial corrections) to the derivatives
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!derivative
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!from velocity derivative
\end_layout

\end_inset

 determined by differentiation.
 The GPS
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

 measurements provide independent measurements of the accelerations, so
 the first two fits can be considered tests of the calibrations
\begin_inset Index idx
status open

\begin_layout Plain Layout
calibration!accelerometer
\end_layout

\end_inset

 of the accelerometers as well as a test of the algorithms and code.
 They indicate only small offsets and near-unity slopes.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
The third is an indication that the calibration of the normal component
 needs adjustment, because the slope is only about 0.95.
 
\end_layout

\end_inset

The last two fits compare only INS-provided values, so they test the validity
 of the transformations and protect against any unknown calibration adjustments
 that might have been applied by the INS without affecting the reported
 accelerations.
 
\end_layout

\begin_layout Standard
A better direct estimate of accelerometer 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU!calibration
\end_layout

\end_inset

calibration can be obtained by 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transforming the 
\emph on
l-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

accelerations determined by differentiating the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based velocity to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!
\emph on
a-
\emph default
frame
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset


\emph on
a-
\emph default
frame, where they can be compared directly to the components of the measured
 accelerations.
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!fits
\end_layout

\end_inset

 When this is done, the calibrations
\begin_inset Index idx
status open

\begin_layout Plain Layout
calibration!accelerometer
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
accelerometer!calibration|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

calibration, accelerometer
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

 in Table
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "tab:a-frame-fits"

\end_inset

 result from linear fits.
 Lateral accelerations
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!lateral
\end_layout

\end_inset

 are usually small, so the second calibration is not as reliable as the
 other two, but all show reasonable agreement between the calibrations in
 use and those indicated by these fits.
 Although the small adjustments have little effect, the calibrations indicated
 in this table will be applied to the measured accelerations in the remainder
 of this technical note.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<plot-acc, include=TRUE, fig.height=6, fig.scap="Comparison of IRU-measured
 accelerations  to the accelerations determined by differentiating the velocity
 components measured by the GPS receiver.", fig.cap='Comparison of measured
 accelerations (BLONGA, BLATA, BNORMA, blue lines) to the accelerations
 determined by differentiating the velocity components measured by the GPS
 receiver and then transforming these to the a-frame (dashed red lines),
 from a portion of DEEPWAVE flight 15 that included a pitch maneuver, a
 speed run and a yaw maneuver at the times corresponding to the plot annotations.
', cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# source ('chunks/multiplot.R')
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# layout(matrix(1:3, ncol = 1), widths = 1,  heights = c(5,5,6))
\end_layout

\begin_layout Plain Layout

# op <- par (mar=c(2,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout

# r <- setRange(D1, 33330, 33515)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

source ('~/RStudio/Ranadu/R/ggplotWAC.R')
\end_layout

\begin_layout Plain Layout

# grid.newpage()
\end_layout

\begin_layout Plain Layout

D1$AA1 <- AA[,1]
\end_layout

\begin_layout Plain Layout

D1$AA2 <- AA[,2]
\end_layout

\begin_layout Plain Layout

D1$AA3 <- AA[,3]
\end_layout

\begin_layout Plain Layout

t1 <- D1$Time[getIndex(D1, 31700)]
\end_layout

\begin_layout Plain Layout

t2 <- D1$Time[getIndex(D1, 32535)]
\end_layout

\begin_layout Plain Layout

t3 <- D1$Time[getIndex(D1, 33320)]
\end_layout

\begin_layout Plain Layout

PanelGroup <- gl (3, 3, labels=c('longitudinal', 'lateral', 'normal'))
\end_layout

\begin_layout Plain Layout

label.df <- data.frame (t=c(t1,t2,t3), y=c(-0.4,1.7,0.3), 
\end_layout

\begin_layout Plain Layout

                        PanelGroup, label=c('pitch', 'speed-run', 'yaw'))
\end_layout

\begin_layout Plain Layout

d <- with (D1[setRange(D1, 31300, 33600), ], data.frame(Time, BLONGA, AA1,
 BLATA, AA2, BNORMA, AA3))
\end_layout

\begin_layout Plain Layout

suppressWarnings (print (
\end_layout

\begin_layout Plain Layout

ggplotWAC(d, col=c('blue', 'red'), lwd=c(0.8,0.6), lty=c(1,42), panels=3,
\end_layout

\begin_layout Plain Layout

          ylab=expression(paste('acceleration [m ',s^2,']')),
\end_layout

\begin_layout Plain Layout

          labelL=c('IRU', 'GPS'), labelP=c('longitudinal', 'lateral', 'normal'),
 
\end_layout

\begin_layout Plain Layout

          legend.position=c(0.8, 0.94), theme.version=1) 
\end_layout

\begin_layout Plain Layout

        + geom_label (aes(x=t, y=y, label=label), data=label.df[4,], inherit.aes=F
ALSE)
\end_layout

\begin_layout Plain Layout

        + geom_label (aes(x=t, y=y, label=label), data=label.df[2,], inherit.aes=F
ALSE)
\end_layout

\begin_layout Plain Layout

        + geom_label (aes(x=t, y=y, label=label), data=label.df[6,], inherit.aes=F
ALSE)
\end_layout

\begin_layout Plain Layout

))
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## use the calibration determined by comparison to GPS:
\end_layout

\begin_layout Plain Layout

cfa1 <- coef(fa1); cfa2 <- coef(fa2); cfa3 <- coef(fa3)
\end_layout

\begin_layout Plain Layout

Data$BLONGA <- cfa1[1] + cfa1[2] * Data$BLONGA
\end_layout

\begin_layout Plain Layout

Data$BLATA  <- cfa2[1] + cfa2[2] * Data$BLATA
\end_layout

\begin_layout Plain Layout

Data$BNORMA <- cfa3[1] + cfa3[2] * Data$BNORMA
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Figure 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:plot-acc}
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!acceleration
\end_layout

\end_inset

  shows a short flight segment comparing the measured 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU!surrogate for
\end_layout

\end_inset

accelerations and the accelerations determined by differentiating the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based velocity and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transforming to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset


\emph on
a-
\emph default
frame.
 There were three 
\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver
\end_layout

\end_inset

maneuvers that introduced accelerations: (i) a pitch maneuver
\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver!pitch
\end_layout

\end_inset

 near 3:17:00 UTC where pilots varied the pitch rapidly, causing periodic
 accelerations normal to the aircraft; (ii) a speed run
\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver!speed run
\end_layout

\end_inset

 centered near 3:25:00 UTC where the airspeed
\begin_inset Index idx
status open

\begin_layout Plain Layout
airspeed
\end_layout

\end_inset

 was varied through the flight envelope of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
aircraft!NSF/NCAR GV
\end_layout

\end_inset

GV, producing large changes in pitch and resulting resolution of the acceleratio
n of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
gravity
\end_layout

\end_inset

gravity into varying contributions to the longitudinal and normal components
 of acceleration; and (iii) a yaw maneuver
\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver!yaw
\end_layout

\end_inset

 near 3:34:00 UTC where lateral accelerations
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!lateral
\end_layout

\end_inset

 were induced by rudder action.
 The good agreement and the near-identity calibrations tabulated above support
 that the accelerations are being treated properly in the calculations and
 also that the calibrations of the accelerometers
\begin_inset Index idx
status open

\begin_layout Plain Layout
calibration!accelerometer
\end_layout

\end_inset

 are good.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<mechanization, include=TRUE, fig.lp='fig:', cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## These very small adjustments prevent gradual ramping during the flight.
\end_layout

\begin_layout Plain Layout

D1$BROLLR <- D1$BROLLR + 0.00026
\end_layout

\begin_layout Plain Layout

D1$BPITCHR <- D1$BPITCHR + 0.00026
\end_layout

\begin_layout Plain Layout

stm <- STMFV (D1, .components=9)  ## get the whole-flight derivative matrix
\end_layout

\begin_layout Plain Layout

DXN <- c('VEW', 'VNS', 'VSPD', 'PITCH', 'ROLL', 'THDG')
\end_layout

\begin_layout Plain Layout

CRF <- c(rep(1,3), rep(Cradeg,3))
\end_layout

\begin_layout Plain Layout

for (j in 1:6) {
\end_layout

\begin_layout Plain Layout

  D1[, gsub ('$', 'X', DXN[j])] <- CRF[j] * D1[1, DXN[j]] + dt * cumsum
 (stm[, j+3])
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

D1$THDGX <- (D1$THDGX + 10 * pi) %% (2*pi)
\end_layout

\begin_layout Plain Layout

D1$PITCHX <- D1$PITCHX / Cradeg
\end_layout

\begin_layout Plain Layout

D1$ROLLX <- D1$ROLLX / Cradeg
\end_layout

\begin_layout Plain Layout

D1$THDGX <- D1$THDGX / Cradeg
\end_layout

\begin_layout Plain Layout

DTHDG <- D1$THDG - D1$THDGX
\end_layout

\begin_layout Plain Layout

DTHDG[DTHDG < -180] <- DTHDG[DTHDG < -180] + 360
\end_layout

\begin_layout Plain Layout

DTHDG[DTHDG > 180] <- DTHDG[DTHDG > 180] - 360
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## these are remnants of previous code, saved here temporarily as comments
\end_layout

\begin_layout Plain Layout

## feedback coefficients for baro loop:
\end_layout

\begin_layout Plain Layout

# C0 <- 0.15; C1 <- 0.0075; C2 <- 0.000125
\end_layout

\begin_layout Plain Layout

# wp3F <- 0;
\end_layout

\begin_layout Plain Layout

# hxF <- hxxF <- 0
\end_layout

\begin_layout Plain Layout

# hi3F <- SP$GGALT[1]
\end_layout

\begin_layout Plain Layout

# RK <- TRUE    ## use Runge-Kutta integration if true
\end_layout

\begin_layout Plain Layout

# RK <- FALSE
\end_layout

\begin_layout Plain Layout

# DL <- nrow(SP)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

#   if (RK) {
\end_layout

\begin_layout Plain Layout

#     stmf1 <- c(STMFV (sv, .components=9), rep(0,6))
\end_layout

\begin_layout Plain Layout

#     sv1 <- sv + stmf1 * dt/2
\end_layout

\begin_layout Plain Layout

#     stmf2 <- c(STMFV (sv1, .components=9), rep(0,6))
\end_layout

\begin_layout Plain Layout

#     sv2 <- sv + stmf2 * dt/2
\end_layout

\begin_layout Plain Layout

#     stmf3 <- c(STMFV (sv2, .components=9), rep(0,6))
\end_layout

\begin_layout Plain Layout

#     sv3 <- sv + stmf3 * dt
\end_layout

\begin_layout Plain Layout

#     stmf4 <- c(STMFV (sv3, .components=9), rep(0,6))
\end_layout

\begin_layout Plain Layout

#     stmf <- (stmf1 + stmf4 + 2*(stmf2+stmf3))/6
\end_layout

\begin_layout Plain Layout

#   } 
\end_layout

\begin_layout Plain Layout

#   wp3F <- wp3F + (stmf[6] - C1*hxF - C2 * hxxF) * dt
\end_layout

\begin_layout Plain Layout

#   hi3F <- hi3F + (wp3F - C0 * hxF) * dt
\end_layout

\begin_layout Plain Layout

#   hxF <- hi3F - SP$GGALT[i]
\end_layout

\begin_layout Plain Layout

#   hxxF <- hxxF + hxF * dt
\end_layout

\begin_layout Plain Layout

#   sv[6] <- 0.5 * (sv[6] + wp3F)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Validating the rotation rates
\begin_inset CommandInset label
LatexCommand label
name "subsec:Checking-the-rotation"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!rotation rate!validating
\end_layout

\end_inset

Independent measurements of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU
\end_layout

\end_inset

rotation rates are not available as they are for accelerations, so similar
 direct tests and calibrations are not possible.
 However, if the wind remains constant, a flight maneuver consisting of
 a circular pattern
\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver!circle
\end_layout

\end_inset

 should produce a 360
\begin_inset Formula $^{\circ}$
\end_inset

change in heading, and the start and end points can be identified from 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based measurements by finding the times when the groundspeed components
 return to their original values.
 DEEPWAVE
\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset

 flight 15 included several circle
\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver!circle
\end_layout

\end_inset

 patterns in the flight plan, including four from 3:38:00 to 3:55:00 UTC,
 two counterclockwise and then two clockwise.
 Without inertial corrections, which are very small integrated over the
 circles, the rate of change in heading
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!rate of change
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!BYAWR
\end_layout

\end_inset


\begin_inset Index var
status open

\begin_layout Plain Layout
BYAWR: body yaw rate, inertial
\end_layout

\end_inset

 should be 
\begin_inset Formula $\dot{\psi}$
\end_inset

=BYAWR/
\begin_inset Formula $\cos\phi$
\end_inset

 where BYAWR is the rotation rate about the yaw axis as reported by the
 IRU and 
\begin_inset Formula $\phi$
\end_inset

 is the roll angle, so comparing this to the change in heading tests that
 the reported rotation rates are correct.
 The total heading change from 3:38:50 to 3:46:40 is 
\begin_inset Formula $-$
\end_inset

718.2
\begin_inset Formula $^{\circ}$
\end_inset

, while the sum of BYAWR/
\begin_inset Formula $\cos\phi$
\end_inset

 for the same time interval is 
\begin_inset Formula $-720.1^{\circ}$
\end_inset

, so these agree to within 0.2%.
 For the two clockwise turns from 3:46:40 to 3:54:30, the corresponding
 sums are 720.1 and 720.6, in still better agreement.
 This only tests for consistency, because the INS
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial!mechanization
\end_layout

\end_inset

 mechanization should produce the same result as that obtained by the difference
 in output variables, but one significant conclusion is that the inertial
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial corrections
\end_layout

\end_inset

 corrections have only a very small net effect on the rotation rate about
 the heading or yaw axis.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<psi-dot, include=TRUE, cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

A <- atan2(D1$vedot, D1$vndot)/Cradeg
\end_layout

\begin_layout Plain Layout

r1 <- setRange(D1, 33938, 34610)
\end_layout

\begin_layout Plain Layout

r2 <- setRange (D1, 34730, 35348)
\end_layout

\begin_layout Plain Layout

dA <- c(0, diff(A))
\end_layout

\begin_layout Plain Layout

dA[dA > 180] <- dA[dA > 180] - 360
\end_layout

\begin_layout Plain Layout

dA[dA < -180] <- dA[dA < -180] + 360
\end_layout

\begin_layout Plain Layout

mdh1 <- mean(D1$hdot[r1])
\end_layout

\begin_layout Plain Layout

mda1 <- mean(dA[r1]) * Rate
\end_layout

\begin_layout Plain Layout

mdh2 <- mean(D1$hdot[r2])
\end_layout

\begin_layout Plain Layout

mda2 <- mean(dA[r2]) * Rate
\end_layout

\begin_layout Plain Layout

sdmh1 <- sd(D1$hdot[r1]) / sqrt(length(r1)-1)
\end_layout

\begin_layout Plain Layout

sdmh2 <- sd(D1$hdot[r1]) / sqrt(length(r2)-1)
\end_layout

\begin_layout Plain Layout

sdma1 <- sd(dA[r1]) * Rate / sqrt(length(r1)-1)
\end_layout

\begin_layout Plain Layout

sdma2 <- sd(dA[r1]) * Rate / sqrt (length(r2)-1)
\end_layout

\begin_layout Plain Layout

cfydot <- coef(lm (c(mda1, mda2) ~ c(mdh1, mdh2)))
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Another test of the rotation rate about the yaw axis can be obtained by
 comparing 
\begin_inset Formula $\dot{\psi}$
\end_inset

 in steady turns to the rate of change in the orientation of the acceleration
 vector determined from the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS.
 In circle
\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver!circle
\end_layout

\end_inset

 maneuvers, the horizontal component of the acceleration vector should rotate
 at a rate equal to 
\begin_inset Formula $\dot{\psi}$
\end_inset

, so this provides a test of the calibration
\begin_inset Index idx
status open

\begin_layout Plain Layout
calibration!rotation rate
\end_layout

\end_inset

 of the rotation rate provided by the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial reference unit
\end_layout

\end_inset

IRU 
\begin_inset Index idx
status open

\begin_layout Plain Layout
gyro
\end_layout

\end_inset

gyros.
 Table
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "tab:hrot-comparison"

\end_inset

 shows the comparison
\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!rotation rate
\end_layout

\end_inset

 of rotation rates obtained in these two independent ways.
 The consistency between turn rates is remarkable, and a calibration representin
g both turn directions is 
\begin_inset Formula $\dot{\psi}_{cal}=a_{0}+a_{1}\dot{\psi}$
\end_inset

 where 
\begin_inset Formula $a_{0}=$
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(cfydot[1], 3)}
\end_layout

\end_inset


\begin_inset Formula $^{\circ}\mathrm{s^{-1}}$
\end_inset

 and 
\begin_inset Formula $a_{1}$
\end_inset

=
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(cfydot[2],3)}
\end_layout

\end_inset

.
 Because the cosine of the mean roll angle was steady at 0.89
\begin_inset Formula $_{4}$
\end_inset

, the corresponding calibration
\begin_inset Index idx
status open

\begin_layout Plain Layout
calibration!rotation rate
\end_layout

\end_inset

 of 
\begin_inset Index var
status open

\begin_layout Plain Layout
BYAWR: body yaw rate, inertial
\end_layout

\end_inset

BYAWR
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!BYAWR
\end_layout

\end_inset

 would use the first coefficient multiplied by 0.89
\begin_inset Formula $_{4}$
\end_inset

; i.e., 
\begin_inset Formula $\mathrm{BYAWR}{}_{cal}=a_{0}^{*}+a_{1}\mathrm{BYAWR}$
\end_inset

 where 
\begin_inset Formula $a_{0}^{*}=$
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(cfydot[1]*0.894,3)}
\end_layout

\end_inset


\begin_inset Formula $^{\circ}\mathrm{s^{-1}}$
\end_inset

.
 This confirms that the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!rotation rate!offset
\end_layout

\end_inset

offset in the measured 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU!calibration
\end_layout

\end_inset

rotation rate about the heading
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!rate of change
\end_layout

\end_inset

 axis is small and the slope coefficient is indistinguishable from unity
 in this test.
\end_layout

\begin_layout Standard
\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="3" columns="5">
<features tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
turn direction
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
mean, 
\begin_inset Formula $\left\langle \dot{\psi}\right\rangle $
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
std.
 dev.
 in 
\begin_inset Formula $\left\langle \dot{\psi}\right\rangle $
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
mean, 
\begin_inset Formula $\left\langle \dot{\psi}^{*}\right\rangle $
\end_inset

 
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
std.
 dev.
 in 
\begin_inset Formula $\left\langle \dot{\psi}^{*}\right\rangle $
\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
left
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(mdh1,3)}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(sdmh1,3)}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(mda1,3)}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(sdma1,3)}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
right
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(mdh2,3)}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(sdmh2,3)}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(mda2,3)}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(sdma2,3)}
\end_layout

\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Comparison
\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!heading rate of change
\end_layout

\end_inset

 of the rate of change in 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!rate of change
\end_layout

\end_inset

heading (
\begin_inset Formula $\dot{\psi}$
\end_inset

) to the rate of change in the direction of the acceleration vector determined
 from differentiation of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based velocity components (
\begin_inset Formula $\dot{\psi}^{*}$
\end_inset

).
 All units are [
\begin_inset Formula $^{\circ}\mathrm{s}^{-1}]$
\end_inset

.
 The listed standard deviations
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!turn rate
\end_layout

\end_inset

 are those estimated for the mean 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU!calibration
\end_layout

\end_inset

measurement.
\begin_inset CommandInset label
LatexCommand label
name "tab:hrot-comparison"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
Inertial effects are expected to be more significant for the pitch and roll
 angles, so similar tests applied to those angles are useful checks of the
 analytical formulas for the derivatives.
 To first order and without inertial corrections, the expected relationships
 are
\begin_inset Newline newline
\end_inset


\begin_inset Formula 
\begin{eqnarray*}
\mathrm{BPITCHR} & = & \dot{\theta}+\dot{\psi}\sin\phi\\
\mathrm{BROLLR} & = & \dot{\phi}-\dot{\psi}\sin\theta
\end{eqnarray*}

\end_inset

where 
\begin_inset Formula $\theta,$
\end_inset

 
\begin_inset Formula $\phi$
\end_inset

 and 
\begin_inset Formula $\psi$
\end_inset

 are respectively the pitch, roll, and heading angles and dots over the
 symbols denote time derivatives.
 For roll, the sum of the left side for the counterclockwise turns is 
\begin_inset Formula $37.2^{\circ}$
\end_inset

, while the sum of the right side is 
\begin_inset Formula $37.5^{\circ}$
\end_inset

.
 For the clockwise turns, the corresponding sums are 
\begin_inset Formula $-36.3^{\circ}$
\end_inset

 and 
\begin_inset Formula $-35.9^{\circ}$
\end_inset

.
 The actual change in roll is near zero, but in the 
\emph on
a-
\emph default
frame and with the aircraft pitched slightly upward during the turn the
 rate of rotation about the yaw axis has an effect on the measured rotation
 rate about the roll axis.
 Similarly, for pitch the sum of the left side for the counterclockwise
 turns is 
\begin_inset Formula $321.3^{\circ}$
\end_inset

, while the sum of the right side is 
\begin_inset Formula $322.9^{\circ}$
\end_inset

.
 For the clockwise turns, the corresponding sums are 
\begin_inset Formula $324.7^{\circ}$
\end_inset

 and 
\begin_inset Formula $325.0^{\circ}$
\end_inset

.
 As for roll, the actual change in pitch from start to end of the two periods
 of circular flight is near zero, but in the 
\emph on
a-
\emph default
frame and with a significant roll angle the rotation about the yaw axis
 makes a contribution to the measured rotation rate about the pitch axis.
 In addition, the difference for clockwise vs counterclockwise turns is
 attributable to the need for corrections for inertial effects.
 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Similar tests of the pitch and roll angles based on the GPS measurements
 are not possible.
 However, the critical test of the angle derivatives
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle!derivative
\end_layout

\end_inset

 is to transform
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

 the measured derivatives
\begin_inset Index idx
status open

\begin_layout Plain Layout
derivative!transformation to 
\emph on
a-
\emph default
frame
\end_layout

\end_inset

 for pitch, roll, and heading to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset


\emph on
a-
\emph default
frame, with appropriate correction for inertial 
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial corrections
\end_layout

\end_inset

effects, and verify that the results match the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU
\end_layout

\end_inset

measured 
\begin_inset Index idx
status open

\begin_layout Plain Layout
rotation rate of aircraft!
\emph on
a-
\emph default
frame
\end_layout

\end_inset

rotation rates.
 The retrieval algorithm is discussed in a following section (Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Rotations"

\end_inset

) because it is also useful for obtaining surrogates for the body rotation
 rates
\begin_inset Index idx
status open

\begin_layout Plain Layout
rotation rate of aircraft!surrogate for measurement
\end_layout

\end_inset

 in cases where they were not recorded or were not in the archive 
\begin_inset Index idx
status open

\begin_layout Plain Layout
file!data
\end_layout

\end_inset

files.
\begin_inset Index idx
status open

\begin_layout Plain Layout
data!standard archive
\end_layout

\end_inset

 Plots and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
fit!regression!rotation rate
\end_layout

\end_inset

fits confirm that the transformed rotation rates
\begin_inset Index idx
status open

\begin_layout Plain Layout
rotation rate of aircraft
\end_layout

\end_inset

 obtained in this way match the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU
\end_layout

\end_inset

measured rotation rates to within very small tolerances.
 For example, for the yaw rotation rate, a linear fit gives coefficients
 (-0.0003, 1.000001) for a fit
\begin_inset Index idx
status open

\begin_layout Plain Layout
fit!coefficients!rotation rate
\end_layout

\end_inset

 of the transformed values to the measured values, with 
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!turn rate
\end_layout

\end_inset

standard deviation smaller than 0.01
\begin_inset space ~
\end_inset


\begin_inset Formula $^{\circ}$
\end_inset


\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-1}$
\end_inset

 and correlation coefficient 0.99997.
 Similar agreement was obtained for the pitch and roll angles.
 This is evidence that, as formulated in the code of the present document,
 the coordinate
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

 transformations and inertial corrections match those applied by the INS
 during the original mechanization.
 
\end_layout

\begin_layout Standard
As argued in Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:mech-procedures"

\end_inset

, integration
\begin_inset Index idx
status open

\begin_layout Plain Layout
integration!duplicating INS
\end_layout

\end_inset

 using the calculated 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

derivatives and comparison
\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!to INS mechanization
\end_layout

\end_inset

 to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

INS-provided variables is the crucial test of the derivatives that the derivativ
e function
\begin_inset Index idx
status open

\begin_layout Plain Layout
function!derivative
\end_layout

\end_inset

 must pass if it is to be used in the Kalman filter.
 That is the topic of the next subsection.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<find-rotation-correction, include=TRUE, cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

DL <- nrow(D1)
\end_layout

\begin_layout Plain Layout

OmegaE <- StandardConstant ('Omega')
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## the derivative of the transformation matrix in terms of hdot etc.
\end_layout

\begin_layout Plain Layout

with (D1, {
\end_layout

\begin_layout Plain Layout

  ch <- cos(THDG*Cradeg)
\end_layout

\begin_layout Plain Layout

  sh <- sin(THDG*Cradeg)
\end_layout

\begin_layout Plain Layout

  cp <- cos(PITCH*Cradeg)
\end_layout

\begin_layout Plain Layout

  sp <- sin(PITCH*Cradeg)
\end_layout

\begin_layout Plain Layout

  cr <- cos(ROLL*Cradeg)
\end_layout

\begin_layout Plain Layout

  sr <- sin(ROLL*Cradeg)
\end_layout

\begin_layout Plain Layout

  Rd <<- c(hdot*ch*cp-pdot*sh*sp,    ## note <<- assignment to get out of
 with() environment
\end_layout

\begin_layout Plain Layout

           hdot*(ch*sp*sr-sh*cr)  + pdot*sh*cp*sr    + rdot*(sh*sp*cr-ch*sr),
\end_layout

\begin_layout Plain Layout

           hdot*(-sh*sr-ch*sp*cr) + pdot*(-sh*cp*cr) + rdot*(ch*cr+sh*sp*sr),
\end_layout

\begin_layout Plain Layout

           hdot*(-sh*cp)          + pdot*(-ch*sp),
\end_layout

\begin_layout Plain Layout

           hdot*(-sh*sp*sr-ch*cr) + pdot*ch*cp*sr    + rdot*(ch*sp*cr+sh*sr),
\end_layout

\begin_layout Plain Layout

           hdot*(sh*sp*cr-ch*sr)  + pdot*(-ch*cp*cr) + rdot*(ch*sp*sr-sh*cr),
\end_layout

\begin_layout Plain Layout

           - pdot*cp,
\end_layout

\begin_layout Plain Layout

           pdot*(-sp*sr)    + rdot*cp*cr,
\end_layout

\begin_layout Plain Layout

           pdot*sp*cr       + rdot*cp*sr)
\end_layout

\begin_layout Plain Layout

})
\end_layout

\begin_layout Plain Layout

RdM <- aperm(array (Rd, dim=c(nrow(D1),3,3)))
\end_layout

\begin_layout Plain Layout

OmegaA <- array (0, dim=c(nrow(D1),3,3))
\end_layout

\begin_layout Plain Layout

rlmA <- XformLA (D1)
\end_layout

\begin_layout Plain Layout

lat <- D1$LAT * Cradeg
\end_layout

\begin_layout Plain Layout

sinLat <- sin(lat); cosLat <- cos(lat); tanLat <- sinLat / cosLat
\end_layout

\begin_layout Plain Layout

omega1 <- matrix (c (rep(0, DL), OmegaE * cosLat, OmegaE * sinLat), ncol=3)
\end_layout

\begin_layout Plain Layout

omega2 <- with(D1, matrix (c (-VNS / Rm,  VEW / Rn, VEW * tanLat / Rn),
 ncol=3))
\end_layout

\begin_layout Plain Layout

omega <- omega1 + omega2
\end_layout

\begin_layout Plain Layout

zro <- c(rep(0, DL))
\end_layout

\begin_layout Plain Layout

SRRI <- array(c(zro, omega[,3], omega[,2],
\end_layout

\begin_layout Plain Layout

                -omega[,3], zro, -omega[,1],
\end_layout

\begin_layout Plain Layout

                -omega[,2], omega[,1], zro), dim=c(DL,3,3))
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

for (i in 1:nrow(D1)) {
\end_layout

\begin_layout Plain Layout

  OmegaA[i,,] <- t(rlmA[,,i]) %*% (RdM[,,i] + SRRI[i,,] %*% rlmA[,,i])
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

D1$BP <- -OmegaA[,1,3]
\end_layout

\begin_layout Plain Layout

D1$BR <- OmegaA[,2,3]
\end_layout

\begin_layout Plain Layout

D1$BY <- -OmegaA[,1,2]
\end_layout

\begin_layout Plain Layout

D1$DBP <- SmoothInterp(D1$BPITCHR-D1$BP, .Length=60*Rate+1)
\end_layout

\begin_layout Plain Layout

D1$DBR <- SmoothInterp(D1$BROLLR-D1$BR, .Length=60*Rate+1)
\end_layout

\begin_layout Plain Layout

D1$DBY <- SmoothInterp(D1$BYAWR-D1$BY, .Length=60*Rate+1)
\end_layout

\begin_layout Plain Layout

D15 <- D1[2:nrow(D1),]  ## save it for plotting later, and modify it to
 avoid deletion
\end_layout

\begin_layout Plain Layout

## remove some large arrays
\end_layout

\begin_layout Plain Layout

rm (stm, rlmA, OmegaA, RdM, omega, omega1, omega2, zro, lat, sinLat, cosLat,
 tanLat, Rd)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Mechanization using the derivatives
\begin_inset CommandInset label
LatexCommand label
name "subsec:Mechanization"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<plot-mechanization, include=TRUE, fig.height=c(7,5), fig.lp='fig:', fig.scap=c("C
omparison of INS-provided and integration-derived attitude angles.", "Comparison
 of INS-provided and integration-derived components of the aircraft velocity."),
 fig.cap=c('Comparison of INS-provided and integration-derived attitude angles,
 labeled "original" and "new", the latter plotted as dashed lines.
 The differences, multiplied by 10, are plotted as green lines.', 'Comparison
 of INS-provided and integration-derived components of the aircraft velocity,
 the latter plotted as dashed red lines.
 The former are {VEW, VNS} and the latter {VEWX, VNSX}, for respectively
 the northbound and eastbound components of the aircraft velocity.'), cache=CACHE
>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# r <- setRange (Data, 31000, 35500)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

D1$DPITCH <- D1$PITCHX-D1$PITCH
\end_layout

\begin_layout Plain Layout

D1$DROLL <- (D1$ROLLX-D1$ROLL)
\end_layout

\begin_layout Plain Layout

D1$DTHDG <- (180+(D1$THDGX-D1$THDG)) %% 360 - 180
\end_layout

\begin_layout Plain Layout

D1$ZERO <- rep(0, nrow(D1))
\end_layout

\begin_layout Plain Layout

D1$PI <- rep(180, nrow(D1))
\end_layout

\begin_layout Plain Layout

#layout(matrix(1:3, ncol = 1), widths = 1,  heights = c(5,5,6))
\end_layout

\begin_layout Plain Layout

#op <- par (mar=c(2,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout

r <- setRange(D1, 32000, 35500)
\end_layout

\begin_layout Plain Layout

d <- with(D1[r, ], data.frame(Time, PITCH, PITCHX, 10*DPITCH, ROLL, ROLLX,
 10*DROLL,
\end_layout

\begin_layout Plain Layout

                               THDG, THDGX, 10*DTHDG))
\end_layout

\begin_layout Plain Layout

ggplotWAC(d, col=c('blue', 'red', 'forestgreen'), 
\end_layout

\begin_layout Plain Layout

          ylab=expression(paste('attitude angles [',degree,']')),
\end_layout

\begin_layout Plain Layout

          lwd=c(1.4,0.8,1), lty=c(1,42,1), panels=3,
\end_layout

\begin_layout Plain Layout

          labelL=c('original', 'new', '10*diff'),
\end_layout

\begin_layout Plain Layout

          labelP=c('pitch', 'roll', 'heading'),
\end_layout

\begin_layout Plain Layout

          legend.position=c(0.8, 0.97), theme.version=1)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

d <- with(D1[r,], data.frame(Time, VEW, VEWX, VNS, VNSX))
\end_layout

\begin_layout Plain Layout

ggplotWAC(d, col=c('blue', 'red'), lwd=c(1.4,0.8), lty=c(1,42),
\end_layout

\begin_layout Plain Layout

          ylab=expression(paste('velocity component [m ',s^-2,']')),
\end_layout

\begin_layout Plain Layout

          panels=2,
\end_layout

\begin_layout Plain Layout

          labelL=c('original', 'new'),
\end_layout

\begin_layout Plain Layout

          labelP=c('eastward', 'northward'),
\end_layout

\begin_layout Plain Layout

          legend.position=c(0.2, 0.97), theme.version=1)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# plotWAC (D1[r, c('Time', 'VSPD', 'VSPDX')])
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

op <- par (mfrow=c(1,1), mar=c(5,5,2,2)+0.1)  # reset
\end_layout

\begin_layout Plain Layout

# SP <- SPR    ## restore to state before integration
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
mechanization
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
integration!duplicating INS
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

The flight segment to be used to test the derivative 
\begin_inset Index idx
status open

\begin_layout Plain Layout
function!derivative
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
derivative function|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

function, derivative
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

function, from DEEPWAVE
\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset

 flight 15 3:20:00 to 3:55:00 UTC, included a 
\begin_inset Quotes eld
\end_inset

speed run
\begin_inset Quotes erd
\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver!speed run
\end_layout

\end_inset

 during which the aircraft
\begin_inset Index idx
status open

\begin_layout Plain Layout
airspeed
\end_layout

\end_inset

 airspeed varied from near-minimum to near-maximum (centered on 3:25:00
 UTC), a maneuver with variation in sideslip angle,
\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver!yaw
\end_layout

\end_inset

 and four complete circles,
\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver!circle
\end_layout

\end_inset

 two flown counterclockwise and two flown clockwise.
 To produce the right values of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

state vector through these maneuvers is therefore a good test of the mechanizati
on.
 Figure
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:plot-mechanization1}
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle!new mechanization
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!plot!attitude angles
\end_layout

\end_inset

 shows that there is very good agreement for heading and roll, and pitch
 tracks well through a pitch maneuver (not shown) and the speed run, but
 there are some small deviations between INS-provided values and the new
 values for pitch during the prolonged turns.
 The cause of this difference is not known, but it may be the result of
 residual timing differences or an internal calibration used by the INS
 or some difference in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial corrections
\end_layout

\end_inset

inertial-correction terms, which become important in the turns.
 However, even after 5 min of turning, the accumulated difference is smaller
 than 0.1
\begin_inset Formula $^{\circ}$
\end_inset

, so this is not a serious weakness, especially because wind 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!measurement
\end_layout

\end_inset

measurements from the GV
\begin_inset Index idx
status open

\begin_layout Plain Layout
aircraft!NSF/NCAR GV
\end_layout

\end_inset

 are usually considered to have increased uncertainty in turns.
 Figure
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:plot-mechanization2}
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!plot!velocity components
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!**
\end_layout

\end_inset

 shows that the ground-speed
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset

 components tracked the INS values very closely through all the maneuvers.
 The key result is thus that as implemented above the derivatives of components
 of the state vector are approximately correct and integrate to values very
 close to those originally produced by the INS.
 The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
function!derivative
\end_layout

\end_inset

function providing those 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

derivatives is therefore a reasonable basis for the Kalman
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter
\end_layout

\end_inset

 filter that follows in Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "sec:The-Kalman-filter"

\end_inset

.
\end_layout

\begin_layout Section
Ancillary topics
\end_layout

\begin_layout Subsection
A new variable for rate of climb
\begin_inset CommandInset label
LatexCommand label
name "subsec:ROC"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<new-data, include=TRUE, cache=FALSE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

Flight <- "16" 			
\end_layout

\begin_layout Plain Layout

Project = "DEEPWAVE"     		
\end_layout

\begin_layout Plain Layout

ProjectDir <- "DEEPWAVE"
\end_layout

\begin_layout Plain Layout

fname = sprintf("%s%s/%srf%s.nc", Directory, ProjectDir, Project, Flight)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

ReloadData <- TRUE
\end_layout

\begin_layout Plain Layout

SaveRData2 <- sprintf("%s2.Rdata", thisFileName)
\end_layout

\begin_layout Plain Layout

if (ReloadData) {
\end_layout

\begin_layout Plain Layout

  source ('chunks/AcquireData.R')
\end_layout

\begin_layout Plain Layout

  ## add ROC variable
\end_layout

\begin_layout Plain Layout

  source ('chunks/ROC.R')
\end_layout

\begin_layout Plain Layout

  ## need to save lots more here -- check environment
\end_layout

\begin_layout Plain Layout

  save (Data, file=SaveRData2)
\end_layout

\begin_layout Plain Layout

} else {
\end_layout

\begin_layout Plain Layout

  load(file=SaveRData2)
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

D1 <- Data  ## make adjustments to a copy; avoid changing original
\end_layout

\begin_layout Plain Layout

## adjustments:
\end_layout

\begin_layout Plain Layout

source ('chunks/AdjustCal.R')
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## GPS shifted vs INS in AdjustCal.R
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## transform to the a-frame for comparison to the IRU:
\end_layout

\begin_layout Plain Layout

VL <- matrix(c(D1$VEW, D1$VNS, D1$VSPD), ncol=3) 
\end_layout

\begin_layout Plain Layout

LA <- matrix (c(D1$vedot, D1$vndot, -D1$vudot - D1$Grav), ncol=3) + RotationCorr
ection (D1, VL)
\end_layout

\begin_layout Plain Layout

AA <- XformLA (D1, LA, .inverse=TRUE)
\end_layout

\begin_layout Plain Layout

AA[,3] <- AA[,3] - D1$Grav
\end_layout

\begin_layout Plain Layout

fa1 <- lm(D1$BLONGA ~ AA[, 1])
\end_layout

\begin_layout Plain Layout

fa2 <- lm(D1$BLATA ~ AA[, 2])
\end_layout

\begin_layout Plain Layout

fa3 <- lm(D1$BNORMA ~ AA[, 3])  
\end_layout

\begin_layout Plain Layout

fm1 <- lm (D1$vedot ~ D1$LACCX)
\end_layout

\begin_layout Plain Layout

fm2 <- lm (D1$vndot ~ D1$LACCY)
\end_layout

\begin_layout Plain Layout

fm3 <- lm (D1$vudot ~ D1$LACCZ)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The integration
\begin_inset Index idx
status open

\begin_layout Plain Layout
integration!INS!rate of climb
\end_layout

\end_inset

 provided by the INS
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

 includes variables for rate of climb (
\begin_inset Index var
status open

\begin_layout Plain Layout
VSPD: rate of climb, INS
\end_layout

\end_inset

VSPD)
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!VSPD
\end_layout

\end_inset

 and altitude
\begin_inset Index idx
status open

\begin_layout Plain Layout
integration!INS!altitude
\end_layout

\end_inset

 (ALT
\begin_inset Index var
status open

\begin_layout Plain Layout
ALT: altitude, INS
\end_layout

\end_inset

),
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!ALT
\end_layout

\end_inset

 but both are updated using an algorithm that adjusts the altitude
\begin_inset Index idx
status open

\begin_layout Plain Layout
altitude of aircraft!pressure
\end_layout

\end_inset

 to the pressure altitude.
 This is not the variable needed for calculation of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!vertical!calculation
\end_layout

\end_inset

vertical wind, and in baroclinic regions it is easy to detect the false
 variations that arise in rate of climb because of this updating scheme.
 The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based variable 
\begin_inset Index var
status open

\begin_layout Plain Layout
GGVSPD: rate of climb, GPS
\end_layout

\end_inset

GGVSPD
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!GGVSPD
\end_layout

\end_inset

 can be used instead, but it is likely that the INS can produce a better
 representation of the high-frequency component, so it is useful to consider
 another variable based on the INS-provided 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from INS!new rate of climb
\end_layout

\end_inset

measurements that can then be updated to GGVSPD via the Kalman filter.
 
\end_layout

\begin_layout Standard
The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
hydrostatic equation
\end_layout

\end_inset

hydrostatic equation provides a basis for updating that is independent of
 the GPS: 
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\frac{dz}{dp}=-\frac{R_{a}T}{pg}\label{eq:hydrostatic-equation}
\end{equation}

\end_inset

where 
\begin_inset Formula $z$
\end_inset

 is the geometric altitude,
\begin_inset Index idx
status open

\begin_layout Plain Layout
altitude of aircraft!geometric
\end_layout

\end_inset

 
\begin_inset Formula $p$
\end_inset

 the pressure, 
\begin_inset Formula $R_{a}$
\end_inset

 the gas constant
\begin_inset Index idx
status open

\begin_layout Plain Layout
gas constant
\end_layout

\end_inset

 for air, 
\begin_inset Formula $T$
\end_inset

 the absolute 
\begin_inset Index idx
status open

\begin_layout Plain Layout
temperature
\end_layout

\end_inset

temperature, and 
\begin_inset Formula $g$
\end_inset

 the acceleration of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
gravity
\end_layout

\end_inset

gravity.
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!gravity|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

gravity
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
gravity
\end_layout

\end_inset

 Then 
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
w_{p}=\frac{dz}{dt}=-\frac{R_{d}T}{pg}\frac{dp}{dt}\label{eq:w-hydro}
\end{equation}

\end_inset

is the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
rate of climb!integrated acceleration
\end_layout

\end_inset

rate of climb in terms of geometric altitude.
 The random component of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
pressure!uncertainty
\end_layout

\end_inset

uncertainty in the pressure 
\begin_inset Index idx
status open

\begin_layout Plain Layout
pressure
\end_layout

\end_inset

measurements makes this 
\begin_inset Index idx
status open

\begin_layout Plain Layout
rate of climb!hydrostatic equation
\end_layout

\end_inset

estimate too noisy to use directly, but it can be used to update the integrated
 vertical acceleration from the INS.
 Define these variables: 
\begin_inset Formula $w_{p}^{\prime}$
\end_inset

 as provided by (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:w-hydro"

\end_inset

) and 
\begin_inset Formula $w_{p}^{*}=\int_{0}^{t}a(t)dt$
\end_inset

 where 
\begin_inset Formula $a$
\end_inset

 is the vertical acceleration (ACINS
\begin_inset Index var
status open

\begin_layout Plain Layout
ACINS: vertical acceleration, INS
\end_layout

\end_inset

)
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!ACINS
\end_layout

\end_inset

 as provided by the INS.
 Define 
\begin_inset Formula $\Delta w_{p}=w_{p}^{\prime}-w_{p}^{*}$
\end_inset

 and the same variable after low-pass filtering to be 
\begin_inset Formula $\overline{\Delta w_{p}}$
\end_inset

.
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!low pass
\end_layout

\end_inset

Then estimate the rate of climb of the aircraft
\begin_inset Index idx
status open

\begin_layout Plain Layout
rate of climb
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
rate of climb!new variable
\end_layout

\end_inset

 from 
\begin_inset Formula $w_{p}=w_{p}^{*}+\overline{\Delta w_{p}}$
\end_inset

.
 The resulting rate of climb can then be integrated again, starting from
 a reference value provided by the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS, to obtain a 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!altitude!new
\end_layout

\end_inset

measure of altitude that, except for the initial reference, is independent
 of the GPS and is a useful representation of geometric altitude.
\begin_inset Index idx
status open

\begin_layout Plain Layout
altitude of aircraft!geometric
\end_layout

\end_inset

 
\end_layout

\begin_layout Standard
Implementation uses a Butterworth filter
\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!Butterworth
\end_layout

\end_inset

 to find 
\begin_inset Formula $\overline{\Delta w_{p}}$
\end_inset

, as follows:
\end_layout

\begin_layout LyX-Code
DIF <- WPPRIME - WPSTAR  ## WPPRIME from hydrostatic equation, 
\end_layout

\begin_layout LyX-Code
                         ## WPSTAR from integrating ACINS
\end_layout

\begin_layout LyX-Code
DIF <- zoo::na.approx (as.vector(DIF), maxgap=1000, na.rm = FALSE)
\end_layout

\begin_layout LyX-Code
DIFW <- signal::filtfilt (signal::butter(3, 2/tau), DIF)
\end_layout

\begin_layout LyX-Code
ROC <- WPSTAR + DIFW
\end_layout

\begin_layout Standard
\begin_inset Index var
status open

\begin_layout Plain Layout
ROC: rate of climb, INS new
\end_layout

\end_inset

where the second statement removes missing values by interpolation
\begin_inset Index idx
status open

\begin_layout Plain Layout
interpolation
\end_layout

\end_inset

 and is needed to avoid an error exception in the third statement.
 The period of the filter
\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!cutoff frequency
\end_layout

\end_inset

 cut-off is tau, here selected after some exploration to be 300
\begin_inset space ~
\end_inset

s.
 The 
\begin_inset Quotes eld
\end_inset

filtfilt()
\begin_inset Quotes erd
\end_inset

 
\begin_inset Index idx
status open

\begin_layout Plain Layout
function!Butterworth filter
\end_layout

\end_inset

function filters by averaging two passes, forward and backward in time,
 to minimize phase-shift distortion
\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!phase-shift
\end_layout

\end_inset

 of the filtered signal.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<ROC-plot, include=TRUE, fig.height=6, fig.scap="Comparison of a new variable
 representing rate of climb to the corresponding GPS-based measurement and
 the INS-provided measurement.", fig.cap='Comparison of a new variable representin
g rate of climb (ROC) to the GPS-based measurement (GGVSPD) and, in the
 bottom panel, the measurement provided by the INS (VSPD).
 The time covered in the bottom panel is a small segment from the time interval
 used for the top two panels.', cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

grid.newpage()
\end_layout

\begin_layout Plain Layout

vp1 <- viewport(width=1, height=0.6, x=0.5, y=0.7)
\end_layout

\begin_layout Plain Layout

vp2 <- viewport(width=1, height=0.4, x=0.5, y=0.2)
\end_layout

\begin_layout Plain Layout

g1 <- ggplotWAC(
\end_layout

\begin_layout Plain Layout

  with(D1[setRange(D1, 74000, 80000), ], 
\end_layout

\begin_layout Plain Layout

       data.frame (Time, ROC, GGVSPD, "DROC"=ROC-GGVSPD, 'SKIP'=ROC*0)),
\end_layout

\begin_layout Plain Layout

       col=c('blue', 'red'), lwd=c(1.4,0.8,1,0), lty=c(1,42),
\end_layout

\begin_layout Plain Layout

       ylab=expression(paste('rate of climb [m ', s^-1, ']')),
\end_layout

\begin_layout Plain Layout

       panels=2,
\end_layout

\begin_layout Plain Layout

       labelL=c('ROC', 'GGVSPD'),
\end_layout

\begin_layout Plain Layout

       labelP=c('variables', 'difference'),
\end_layout

\begin_layout Plain Layout

       legend.position=c(0.8,0.94), theme.version=1
\end_layout

\begin_layout Plain Layout

)
\end_layout

\begin_layout Plain Layout

print (g1, vp=vp1)
\end_layout

\begin_layout Plain Layout

g2 <- ggplotWAC(
\end_layout

\begin_layout Plain Layout

  with(D1[setRange(D1, 75500, 75900), ],
\end_layout

\begin_layout Plain Layout

       data.frame (Time, ROC, GGVSPD, VSPD)),
\end_layout

\begin_layout Plain Layout

  ylab=expression(paste('rate of climb [m ', s^-1, ']')), theme.version=1
\end_layout

\begin_layout Plain Layout

)
\end_layout

\begin_layout Plain Layout

g2 <- g2 + theme(axis.title.y=element_text(size=12),
\end_layout

\begin_layout Plain Layout

                 axis.text.y=element_text(size=12),
\end_layout

\begin_layout Plain Layout

                 axis.text.x=element_text(size=12),
\end_layout

\begin_layout Plain Layout

                 axis.title.x=element_text(size=12))
\end_layout

\begin_layout Plain Layout

print (g2, vp=vp2)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

meanROC <- with(D1[setRange(D1, 70000, 122000), ], mean (ROC-GGVSPD, na.rm=TRUE))
\end_layout

\begin_layout Plain Layout

sdROC <- with(D1[setRange(D1, 70000, 122000), ], sd (ROC-GGVSPD, na.rm=TRUE))
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The resulting 
\begin_inset Index idx
status open

\begin_layout Plain Layout
ROC=rate of climb
\end_layout

\end_inset

variable
\begin_inset Index var
status open

\begin_layout Plain Layout
ROC: rate of climb, INS new
\end_layout

\end_inset

 
\begin_inset Quotes eld
\end_inset

ROC
\begin_inset Quotes erd
\end_inset

 is plotted in Fig.
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:ROC-plot}
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!plot!rate of climb
\end_layout

\end_inset

 for comparison to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based variable 
\begin_inset Index var
status open

\begin_layout Plain Layout
GGVSPD: rate of climb, GPS
\end_layout

\end_inset

GGVSPD.
 The bottom panel also shows the 
\begin_inset Index var
status open

\begin_layout Plain Layout
VSPD: rate of climb, INS
\end_layout

\end_inset

variable 
\begin_inset Quotes eld
\end_inset

VSPD
\begin_inset Quotes erd
\end_inset

 that is provided directly by the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from INS!VSPD
\end_layout

\end_inset

INS.
 The latter departs significantly from the other two variables, so using
 ROC as input to the Kalman filter
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!Kalman|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

Kalman filter
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

 appears preferable to using VSPD.
 The mean difference ROC
\begin_inset Formula $-$
\end_inset

GGVSPD is 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(meanROC, 2)}
\end_layout

\end_inset

, with standard deviation 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(sdROC, 2)}
\end_layout

\end_inset

.
 ROC appears to vary more smoothly than GGVSPD, so Kalman-filter updating
 of ROC to GGVSPD may provide a better representation of aircraft rate-of-climb
 than GGVSPD.
 This will be considered further in Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "sec:KF-variables"

\end_inset

, where the measurements of wind produced by the Kalman filter are discussed.
\end_layout

\begin_layout Subsection
Retrieving IRU measurements by differentiation
\end_layout

\begin_layout Subsubsection
Rotation rates
\begin_inset CommandInset label
LatexCommand label
name "subsec:Rotations"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!rotation rate!surrogate for
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement! from IRU!surrogate for
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial reference unit
\end_layout

\end_inset

It is usually the case that the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU
\end_layout

\end_inset

IRU variables for body rotation rate
\begin_inset Index idx
status open

\begin_layout Plain Layout
rotation rate of aircraft!measurement
\end_layout

\end_inset

 and body acceleration
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset

 are not part of the data archives.
\begin_inset Index idx
status open

\begin_layout Plain Layout
data!standard archive
\end_layout

\end_inset

 Indeed, for all except recent projects and for all C-130 projects, these
 variables from the IRU were not even recorded in the original data tapes.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
Mechanization as in Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Mechanization"

\end_inset

 needs high-rate files, but the Kalman filter developed in the next section
 provides a slow update to the error state vector and therefore works adequately
 with low-rate data files.
 
\end_layout

\end_inset

Therefore, it is useful to be able to 
\begin_inset Index idx
status open

\begin_layout Plain Layout
retrieval!of measurements from IRU
\end_layout

\end_inset

retrieve the accelerations and rotation rates from the measured variables
 present in those archive 
\begin_inset Index idx
status open

\begin_layout Plain Layout
file!data
\end_layout

\end_inset

files.
 Differentiating the measured angles
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle!derivative
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

 and velocity and then 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transforming the derivatives to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset


\emph on
a-
\emph default
frame, with correction for the inertial 
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial corrections
\end_layout

\end_inset

effects as was discussed for the derivative of the state vector in Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:deriv-array"

\end_inset

, can provide retrieved values for the measurements.
 Then the Kalman 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter
\end_layout

\end_inset

filter can proceed using these surrogates for the original measurements.
\end_layout

\begin_layout Standard
For the rotation rates, the calculation proceeds as follows: (For additional
 detail, see the code is in the R program chunk named find-rotation-correction.
 )
\end_layout

\begin_layout Enumerate
Start with an analytical expression for the derivative
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!coordinate transformation!derivative
\end_layout

\end_inset

 of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transformation matrix 
\begin_inset Formula $R_{a}^{l}$
\end_inset

 in terms of attitude angles
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle
\end_layout

\end_inset

 (
\begin_inset Formula $\theta,\,\phi,\,\psi$
\end_inset

, pitch, roll, and heading) and their time 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

derivatives 
\begin_inset Formula $\dot{\theta}$
\end_inset

, 
\begin_inset Formula $\dot{\phi}$
\end_inset

, and 
\begin_inset Formula $\dot{\psi}$
\end_inset

.
\end_layout

\begin_layout Enumerate
Use differences between sequential 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from INS
\end_layout

\end_inset

measurements of the attitude angles to find values for these time 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

derivatives.
 Use these with the analytical expressions for the derivatives from step
 1 to find the derivative of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transformation matrix from the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset


\emph on
a-
\emph default
frame to the 
\emph on
l-
\emph default
frame.
 
\end_layout

\begin_layout Enumerate
Calculate the (minor) correction for inertial 
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial corrections
\end_layout

\end_inset

effects and 
\emph on
add
\emph default
 it to the derivative matrix of the transformation from the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\emph on
l-
\emph default
frame to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset


\emph on
a-
\emph default
frame.
 (Normally this is subtracted during the forward transformation.)
\end_layout

\begin_layout Enumerate
Multiply the result by the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\emph on
l-
\emph default
frame-to-
\emph on
a-
\emph default
frame 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transformation 
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!coordinate transformation
\end_layout

\end_inset

matrix.
 The result is a skew-symmetric
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!skew-symmetric
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
skew-symmetric matrix
\end_layout

\end_inset

 representation of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU!surrogate for
\end_layout

\end_inset

measured rotation rates, 
\begin_inset Formula $\boldsymbol{\Omega}_{ia}^{a}$
\end_inset

, from which the surrogate for the measurements can be extracted.
 
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
vfill
\backslash
eject
\end_layout

\end_inset


\end_layout

\begin_layout Standard
A mathematical expression of this algorithm, with 
\begin_inset Formula $\Omega_{il}^{a}$
\end_inset

 representing the corrections for inertial effects, 
\begin_inset Formula $R_{l}^{a}$
\end_inset

 the inverse of 
\begin_inset Formula $R_{a}^{l}$
\end_inset

, 
\begin_inset Formula $\Omega_{ie}^{l}$
\end_inset

 the effect of the rotation of the Earth, and 
\begin_inset Formula $\Omega_{el}^{l}$
\end_inset

 the effect of translation of the 
\emph on
l-
\emph default
frame, is as follows:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\dot{R}_{a}^{l}=R_{a}^{l}\Omega_{la}^{a}=R_{a}^{l}(\Omega_{ia}^{a}-\Omega_{il}^{a})\label{eq:Rla-dot}
\end{equation}

\end_inset


\begin_inset Formula 
\begin{equation}
\Omega_{ia}^{a}=R_{l}^{a}\dot{R}_{a}^{l}+\Omega_{il}^{a}\label{eq:Omega-iaa}
\end{equation}

\end_inset


\begin_inset Formula 
\begin{eqnarray}
\Omega_{ia}^{a} & = & R_{l}^{a}\dot{R}_{a}^{l}+R_{l}^{a}(\Omega_{ie}^{l}+\Omega_{el}^{l})R_{a}^{l}\label{eq:Omega2-iaa}
\end{eqnarray}

\end_inset

(
\begin_inset CommandInset citation
LatexCommand citet
key "noureldin2013fundamentals"

\end_inset

) where the left side of the last equation is the desired skew-symmetric
 representation of the rotation rate
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!rotation rate!retrieval of
\end_layout

\end_inset

 and all components of the right side are known, the time 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

derivative from the differentiated measurements
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!differentiated
\end_layout

\end_inset

 and the last term because it is the same correction for inertial 
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial corrections
\end_layout

\end_inset

effects used to find the attitude-angle derivatives
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle!derivative
\end_layout

\end_inset

 from the measurements.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<plot-retrieved-rotations, include=TRUE, fig.scap="Comparison of measured
 body rotation rates and those determined by differentiating the attitude
 angles, for a flight segment with various maneuvers.", fig.cap='Comparison
 of measured body rotation rates and those determined by differentiating
 the attitude angles.
 The red lines denoted as "delta*10" show the difference between the two
 rates after multiplication by 10 to make the small differences visible.
 The measurements are from DEEPWAVE flight 15, from a portion of the flight
 that included, chronologically in the plot, maneuvers with rapid pitch
 variations, a speed run with slow pitch variations, a maneuver with rapid
 changes in sideslip, and two full left-turn circles.', cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

suppressWarnings (print (    ## this avoids printed warning about attribute
 differences
\end_layout

\begin_layout Plain Layout

ggplotWAC (with(D15[setRange(D15, 31200, 34630),], 
\end_layout

\begin_layout Plain Layout

                data.frame(Time, BPITCHR, BP, 10*DBP, BROLLR, BR, 10*DBR,
\end_layout

\begin_layout Plain Layout

                                BYAWR, BY, 10*DBY)),
\end_layout

\begin_layout Plain Layout

           ylab=expression(paste('rotation rate [',degree,' ',s^-1,']')),
\end_layout

\begin_layout Plain Layout

           lwd=c(0.7,0.5,1), lty=c(1,93,1),
\end_layout

\begin_layout Plain Layout

           panels=3,
\end_layout

\begin_layout Plain Layout

           labelL=c('measured', 'from differentiation', 'delta*10'),
\end_layout

\begin_layout Plain Layout

           labelP=c('pitch', 'roll', 'yaw'),
\end_layout

\begin_layout Plain Layout

           legend.position=c(0.5,0.96), theme.version=1
\end_layout

\begin_layout Plain Layout

  )
\end_layout

\begin_layout Plain Layout

))
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# + geom_label(mapping=aes(x=D15$Time[getIndex(D15,31300)], y=0.2, label='maneuve
rs:'), 
\end_layout

\begin_layout Plain Layout

#              show.legend=FALSE, color='black')
\end_layout

\begin_layout Plain Layout

# layout(matrix(1:3, ncol = 1), widths = 1,  heights = c(5,5,6))
\end_layout

\begin_layout Plain Layout

# op <- par (mar=c(2,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout

# with(D15, plotWAC(data.frame(Time, BPITCHR, BP, 10*DBP), ylim=c(-2,2)))
\end_layout

\begin_layout Plain Layout

# with(D15, plotWAC(data.frame(Time, BROLLR, BR, 10*DBR)))
\end_layout

\begin_layout Plain Layout

# op <- par (mar=c(5,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout

# with(D15, plotWAC(data.frame(Time, BYAWR, BY, 10*DBY), ylim=c(-2,2)))
\end_layout

\begin_layout Plain Layout

# op <- par (mfrow=c(1,1), mar=c(5,5,2,2)+0.1)  # reset
\end_layout

\begin_layout Plain Layout

# rm(D15)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
rotation rate of aircraft!retrieved
\end_layout

\end_inset

Figure 
\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:plot-retrieved-rotations}
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
rotation rate of aircraft!surrogate for measurement
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU!surrogate for
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!plot!rotation rate
\end_layout

\end_inset

 shows the resulting 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transformed 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

derivatives, as the green lines, and the measured rotation rates as blue
 lines.
 They are mostly indistinguishable in these plots, and statistically they
 are nearly identical as characterized at the end of Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Checking-the-rotation"

\end_inset

, so the transformed derivatives are valid estimates of the original rotation
 rates and should be suitable for use in the Kalman filter discussed in
 the next section.
\end_layout

\begin_layout Subsubsection
Accelerations
\begin_inset CommandInset label
LatexCommand label
name "subsec:retrieving-accelerations"

\end_inset


\end_layout

\begin_layout Standard
The retrieval of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU!surrogate for
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU!retrieval|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

--, surrogate for
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

accelerations
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!retrieving
\end_layout

\end_inset

 is similar: Differentiate
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!differentiated
\end_layout

\end_inset

 the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\emph on
l-
\emph default
frame velocity components {
\begin_inset Index var
status open

\begin_layout Plain Layout
VEW: ground speed eastward, INS
\end_layout

\end_inset

VEW, 
\begin_inset Index var
status open

\begin_layout Plain Layout
VNS: ground speed northward, INS
\end_layout

\end_inset

VNS, 
\begin_inset Index var
status open

\begin_layout Plain Layout
VSPD: rate of climb, INS
\end_layout

\end_inset

VSPD} to find the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\emph on
l-
\emph default
frame accelerations, apply the correction for inertial
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial corrections
\end_layout

\end_inset

 effects with sign opposite to that used for the 
\emph on
a-
\emph default
frame-to-
\emph on
l-
\emph default
frame 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transformation, then transform the results from the 
\emph on
l-
\emph default
frame to the 
\emph on
a-
\emph default
frame using the inverse of the transformation 
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!coordinate transformation
\end_layout

\end_inset

matrix used for the opposite transformation.
 See the workflow document
\begin_inset Index idx
status open

\begin_layout Plain Layout
workflow document
\end_layout

\end_inset

 for more detail, and refer to the code in the R chunk 
\begin_inset Quotes eld
\end_inset

checking-accelerations
\begin_inset Quotes erd
\end_inset

 for the R implementation.
 This is the same algorithm that was used in Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Checking-accelerations"

\end_inset

 to test the calibration of the accelerometers.
\begin_inset Index idx
status open

\begin_layout Plain Layout
calibration!accelerometer
\end_layout

\end_inset

 
\end_layout

\begin_layout Subsection
Simpler algorithms
\end_layout

\begin_layout Subsubsection
Reasons for considering alternate algorithms
\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
algorithm!simplier!correct pitch
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
algorithm!simplier!correct heading
\end_layout

\end_inset

The Kalman filter discussed in the next section will produce estimated 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!attitude angle!Kalman filter estimate
\end_layout

\end_inset

errors for the attitude angles,
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle!errors
\end_layout

\end_inset

 but it is possible to calculate a simpler estimate with some assumptions
 about the source of the error.
 One estimate was developed in 
\begin_inset CommandInset citation
LatexCommand citet
key "Cooper2016ncartn"

\end_inset

, Sect.
\begin_inset space ~
\end_inset

6.4; cf.
\begin_inset space ~
\end_inset

Eqs.
\begin_inset space ~
\end_inset

57.
 The intent of this section is to provide alternative corrections for all
 three attitude angles on the basis of relatively simple comparisons
\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!INS to GPS
\end_layout

\end_inset

 between measurements available from the combination of an 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

INS and a GPS
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

 receiver.
 These corrections can be applied to archived data
\begin_inset Index idx
status open

\begin_layout Plain Layout
data!standard archive
\end_layout

\end_inset

 and so can lead to improvements in data collected in 
\begin_inset Index idx
status open

\begin_layout Plain Layout
processing from archives
\end_layout

\end_inset

past as well as future projects, and they provide valuable comparisons to
 the results that will be obtained from the Kalman filter.
 
\end_layout

\begin_layout Standard
In the case of pitch and roll, the estimate of error relies on the derivatives
 of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!velocity
\end_layout

\end_inset

errors in 
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset

ground-speed components and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!position
\end_layout

\end_inset

position, which arise primarily from errors in those angles.
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle!errors
\end_layout

\end_inset

 For heading, the accelerations
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset

  determined by differentiating the ground-speed components produced by
 the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from INS
\end_layout

\end_inset

INS are compared to those determined by differentiating the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based 
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset

ground-speed 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS
\end_layout

\end_inset

components.
 This difference is dependent on the error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading
\end_layout

\end_inset

 in heading
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!error
\end_layout

\end_inset

 because the accelerations are measured in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!aircraft|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

reference frame, 
\emph on
a-
\emph default
frame
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\emph on
a-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset

 and transformation
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

 to an 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!Earth|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

reference frame, 
\emph on
l-
\emph default
frame
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

Earth-reference frame (the 
\emph on
l-
\emph default
frame) involves the heading.
 An error in heading
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading
\end_layout

\end_inset

 results in a difference between the two sets of measured accelerations,
 and that difference can be used to detect the error in heading.
 As developed here, all corrections are applied to measurements after acquisitio
n, not during recording or initial data processing, to be able to use algorithms
 that 
\begin_inset Index idx
status open

\begin_layout Plain Layout
smoothing
\end_layout

\end_inset

smooth measurements over centered intervals.
 This also makes it possible to correct archived data as long as the INS-provide
d and GPS-based measurements of ground speed
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset

 are available.
\end_layout

\begin_layout Subsubsection
Correcting the pitch and roll
\begin_inset CommandInset label
LatexCommand label
name "sec:Correcting-the-pitch"

\end_inset


\end_layout

\begin_layout Standard
An inertial system
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

 aligns during initialization
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial!alignment
\end_layout

\end_inset

 to detect the local 
\begin_inset Index idx
status open

\begin_layout Plain Layout
vertical direction!local
\end_layout

\end_inset

vertical direction and then calculates the new vertical direction as the
 aircraft moves (changing the local vertical direction) and accelerates
 (which can cause gyros to precess).
 Any misalignment present at initialization persists but also will oscillate
 and will cause errors in roll
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!roll
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
error!mix pitch and roll
\end_layout

\end_inset

 and pitch to mix as the aircraft changes flight direction.
 For the inertial system
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

 used on the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
aircraft!NSF/NCAR GV
\end_layout

\end_inset

NSF/NCAR GV, the standard uncertainty associated with this 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from INS!uncertainty
\end_layout

\end_inset

measurement is 0.05
\begin_inset Formula $^{\circ}$
\end_inset

 in both roll and pitch (cf.
\begin_inset space ~
\end_inset


\begin_inset CommandInset citation
LatexCommand citet
key "Cooper2016ncartn"

\end_inset

) for flight duration of a few hours, and the error often increases during
 the flight as heading
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!error
\end_layout

\end_inset

 errors and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!accelerometer
\end_layout

\end_inset

accelerometer
\begin_inset Index idx
status open

\begin_layout Plain Layout
calibration!accelerometer
\end_layout

\end_inset

 biases
\begin_inset Index idx
status open

\begin_layout Plain Layout
accelerometer!bias
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
accelerometer!bias
\end_layout

\end_inset

 affect the results.
 
\end_layout

\begin_layout Standard
The work of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Schuler oscillation
\end_layout

\end_inset

Schuler (
\begin_inset CommandInset citation
LatexCommand cite
key "Schuler1923"

\end_inset

) showed that coupling
\begin_inset Index idx
status open

\begin_layout Plain Layout
coupling!strong
\end_layout

\end_inset

 among some of these error sources leads to limits on the growth of errors
 and to simultaneous oscillations in some of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!error!Schuler oscillation
\end_layout

\end_inset

measurement errors.
 In particular, an error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch!strong coupling
\end_layout

\end_inset

 in pitch leads to an error in horizontal acceleration
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!acceleration!strong coupling
\end_layout

\end_inset

 because gravity
\begin_inset Index idx
status open

\begin_layout Plain Layout
gravity
\end_layout

\end_inset

 is resolved to have an erroneous horizontal component, and integration
\begin_inset Index idx
status open

\begin_layout Plain Layout
integration!position error
\end_layout

\end_inset

 of that error in horizontal acceleration leads to a position error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!position!strong coupling
\end_layout

\end_inset

 that grows so as to compensate for the false component of acceleration
 arising from the original error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch
\end_layout

\end_inset

 in pitch.
 However, when the error in pitch is reduced to zero, errors in position
 and velocity have been accumulated and those lead to growth of the error
 in pitch in the direction opposite to the original error.
 The result is a Schuler oscillation having a 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Schuler oscillation!period
\end_layout

\end_inset

period of 
\begin_inset Formula $T_{Sch}=(R_{e}/g)^{0.5}/(2\pi)\approx5064\thinspace s$
\end_inset

 or 84.4
\begin_inset space \thinspace{}
\end_inset

min, where 
\begin_inset Formula $R_{e}$
\end_inset

 is the radius of the Earth
\begin_inset Index idx
status open

\begin_layout Plain Layout
radius of curvature!Earth
\end_layout

\end_inset

 and 
\begin_inset Formula $g$
\end_inset

 the acceleration of gravity.
\begin_inset Index idx
status open

\begin_layout Plain Layout
gravity
\end_layout

\end_inset

 
\end_layout

\begin_layout Standard
The existence of this coupling allows estimation of the pitch error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch!estimation
\end_layout

\end_inset

 if the error in horizontal acceleration can be measured.
 That is the case if, in addition to the INS, there is a 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS receiver that can provide high-quality 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS
\end_layout

\end_inset

measurements of Earth-relative 
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!Earth-relative
\end_layout

\end_inset

velocity.
 Modern GPS receivers, especially if they incorporate differential-GPS correctio
ns or ionospheric corrections, produce velocity measurements that have remarkabl
y low 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS!uncertainty
\end_layout

\end_inset

uncertainty, often a few cm/s, so these can be considered a standard against
 which to compare the corresponding INS-provided velocity.
 The difference between ground-speed
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset

 components from the two systems thus determines the error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!velocity
\end_layout

\end_inset

 in the INS-provided velocity and, after differentiation, the error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!horizontal acceleration
\end_layout

\end_inset

 in horizontal acceleration.
\end_layout

\begin_layout Standard
If 
\begin_inset Formula $a_{n}=a_{n}^{*}+\delta a_{n}$
\end_inset

 where 
\begin_inset Formula $a_{n}^{*}$
\end_inset

 is the true northward acceleration
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset

  of the aircraft
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration
\end_layout

\end_inset

 and 
\begin_inset Formula $\delta a_{n}$
\end_inset

 is the erroneous acceleration
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!error
\end_layout

\end_inset

 that results from pitch and position errors, then the error in acceleration
 (if the accelerometer error itself is negligible) is given by
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\delta a_{n}^{(l)}=-g\delta\theta^{(l)}\,\,\,.\label{eq:delta-an}
\end{equation}

\end_inset

where 
\begin_inset Formula $\delta\theta^{(l)}$
\end_inset

 is the error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch!strong coupling
\end_layout

\end_inset

 in pitch.
 The superscripts 
\begin_inset Formula $(l)$
\end_inset

 denote that these pitch and acceleration 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!acceleration!strong coupling
\end_layout

\end_inset

errors are those present in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!ENU|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

reference frame, 
\emph on
l-
\emph default
frame
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

 
\emph on
l-
\emph default
frame.
 Then the error in 
\begin_inset Index idx
status open

\begin_layout Plain Layout
pitch!error
\end_layout

\end_inset

measured northward acceleration provides a direct measure of the error in
 pitch:
\begin_inset Newline newline
\end_inset


\begin_inset Formula 
\begin{equation}
\delta\theta^{(l)}=-\frac{1}{g}\frac{d(\delta v_{n}^{(l)})}{dt}\,\,\,.\label{eq:full-delta-pitch}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
Because 
\begin_inset Formula $\delta v_{n}$
\end_inset

 is measurable by comparison
\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!INS to GPS
\end_layout

\end_inset

 to 
\begin_inset Index idx
status open

\begin_layout Plain Layout
pitch
\end_layout

\end_inset

measurements from a GPS
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

 receiver, the error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 in pitch can be found from (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:full-delta-pitch"

\end_inset

).
 The analogous equation for the 
\emph on
l-
\emph default
frame error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!roll!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 in roll, 
\begin_inset Formula $\delta\phi^{(l)}$
\end_inset

, is
\begin_inset Note Note
status open

\begin_layout Plain Layout
this is wrong...
 fix this
\begin_inset Foot
status open

\begin_layout Plain Layout
The different signs arise from the different definitions of the angles,
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle!sign convention
\end_layout

\end_inset

 where a positive 
\emph on
l-
\emph default
frame pitch error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch!sign convention
\end_layout

\end_inset

 represents a positive rotation of the aircraft about the 
\begin_inset Formula $x$
\end_inset

-axis direction but a positive roll error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!roll!sign convention
\end_layout

\end_inset

 corresponds to a positive rotation of the aircraft about the 
\begin_inset Formula $y$
\end_inset

-axis direction.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
\delta\phi^{(l)} & = & \frac{1}{g}\frac{d(\delta v_{e}^{(l)})}{dt}\,\,\,.\label{eq:delta-phi}
\end{eqnarray}

\end_inset

The differentiated
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!differentiated
\end_layout

\end_inset

 errors in the components of the aircraft ground speed
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset

 thus provide estimates of the corrections to be applied to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
pitch!corrected
\end_layout

\end_inset

measurements of pitch
\begin_inset Index idx
status open

\begin_layout Plain Layout
pitch!correction!simplified
\end_layout

\end_inset

 and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
roll!correction!simplified
\end_layout

\end_inset

roll.
 Because this correction relies on the observable effects of the errors
 in velocity, it is not sensitive to the source of the error, whether it
 arises from misalignment before flight, bias errors in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial reference unit!bias
\end_layout

\end_inset

IRU 
\begin_inset Index idx
status open

\begin_layout Plain Layout
gyro
\end_layout

\end_inset

gyros,
\begin_inset Index idx
status open

\begin_layout Plain Layout
gyro!bias
\end_layout

\end_inset

 or other sources except for these exceptions: (i) an error in measured
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!acceleration!effect of
\end_layout

\end_inset

acceleration from the accelerometers
\begin_inset Index idx
status open

\begin_layout Plain Layout
accelerometer!error
\end_layout

\end_inset

 that contributes to the velocity 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!velocity
\end_layout

\end_inset

errors in a way not dependent on the pitch or roll errors; and (ii) a minor
 dependence on error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!effect on pitch
\end_layout

\end_inset

 in heading that arises when the pitch and roll errors in the Earth-relative
 
\emph on
l-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 are 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transformed to the reference frame of the aircraft.
 The latter is negligible for normal heading errors, but the former can
 cause increasing amplitude or drift of the velocity errors.
 Plots of the observed errors in ground-speed
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset

 components, shown later in this document, suggest relatively small changes
 in the amplitude of the Schuler 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Schuler oscillation
\end_layout

\end_inset

oscillation during most flights, as would be expected if the accelerometer
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!accelerometer
\end_layout

\end_inset

errors make only small contributions to the velocity 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!velocity
\end_layout

\end_inset

errors.
\end_layout

\begin_layout Standard
An additional 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transformation of angles
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle
\end_layout

\end_inset

 is needed to obtain the pitch
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch!
\emph on
a-
\emph default
frame
\end_layout

\end_inset

 and roll 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!roll!
\emph on
a-
\emph default
frame
\end_layout

\end_inset

errors in 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset

the 
\emph on
a-
\emph default
frame, the normal reference frame for these angles.
 
\begin_inset Foot
status open

\begin_layout Plain Layout
The 
\emph on
a-
\emph default
frame differs from the 
\begin_inset Formula $b$
\end_inset

-frame or body frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!body or b-frame
\end_layout

\end_inset

 often discussed in the inertial-navigation literature by having 
\begin_inset Formula $\hat{x}$
\end_inset

 and 
\begin_inset Formula $\hat{y}$
\end_inset

 axes interchanged
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame!axes interchanged
\end_layout

\end_inset

 and the 
\begin_inset Formula $\hat{z}$
\end_inset

 axis reversed to be downward, as is conventional for aircraft.
\end_layout

\end_inset

This calculation has been incorporated into a 
\begin_inset Index idx
status open

\begin_layout Plain Layout
function!CorrectPitch
\end_layout

\end_inset

function 
\begin_inset Quotes eld
\end_inset

CorrectPitch ()
\begin_inset Quotes erd
\end_inset

 that is part of the 
\begin_inset Quotes eld
\end_inset

Ranadu
\begin_inset Quotes erd
\end_inset

 
\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!package!Ranadu
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!package!Ranadu
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!package!Ranadu!CorrectPitch()
\end_layout

\end_inset

package.
 Given a data.frame containing appropriate 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!required by CorrectPitch
\end_layout

\end_inset

measurements from a flight (specifically, 
\begin_inset Index var
status open

\begin_layout Plain Layout
VNS: ground speed northward, INS
\end_layout

\end_inset

VNS,
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!VNS
\end_layout

\end_inset

 
\begin_inset Index var
status open

\begin_layout Plain Layout
VEW: ground speed eastward, INS
\end_layout

\end_inset

VEW,
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!VEW
\end_layout

\end_inset

 
\begin_inset Index var
status open

\begin_layout Plain Layout
GGVNS: ground speed northward, GPS
\end_layout

\end_inset

GGVNS,
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!GGVNS
\end_layout

\end_inset

 
\begin_inset Index var
status open

\begin_layout Plain Layout
GGVEW: ground speed eastward, GPS
\end_layout

\end_inset

GGVEW,
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!GGVEW
\end_layout

\end_inset

 
\begin_inset Index var
status open

\begin_layout Plain Layout
LAT: latitude, INS
\end_layout

\end_inset

LAT
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!LAT
\end_layout

\end_inset

 or 
\begin_inset Index var
status open

\begin_layout Plain Layout
LATC: latitude, GPS-corrected
\end_layout

\end_inset

LATC, 
\begin_inset Index var
status open

\begin_layout Plain Layout
GGALT: altitude, GPS, MSL
\end_layout

\end_inset

GGALT,
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!GGALT
\end_layout

\end_inset

 
\begin_inset Index var
status open

\begin_layout Plain Layout
THDG: heading, INS
\end_layout

\end_inset

THDG,
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!THDG
\end_layout

\end_inset

 
\begin_inset Index var
status open

\begin_layout Plain Layout
PITCH: pitch angle, INS
\end_layout

\end_inset

PITCH,
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!PITCH
\end_layout

\end_inset

 and 
\begin_inset Index var
status open

\begin_layout Plain Layout
ROLL: roll angle, INS
\end_layout

\end_inset

ROLL,
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!ROLL
\end_layout

\end_inset

 representing respectively the eastward and northward velocity components
 of the aircraft as measured by the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

INS and the GPS receiver, the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
latitude
\end_layout

\end_inset

latitude, the altitude from the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS, and the heading, pitch, and roll angle), the function returns estimates
 of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch!Ranadu
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
error!roll!Ranadu
\end_layout

\end_inset

errors in pitch and roll.
 The workflow document
\begin_inset Index idx
status open

\begin_layout Plain Layout
workflow document
\end_layout

\end_inset

 accompanying this technical note provides additional detail on the algorithm
\begin_inset Index idx
status open

\begin_layout Plain Layout
algorithm!simplier!correct pitch
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
algorithm!simplier!correct heading
\end_layout

\end_inset

 used, and the R code is available in the file 
\begin_inset Quotes eld
\end_inset

PitchCorrection.R
\begin_inset Quotes erd
\end_inset

 
\begin_inset Index idx
status open

\begin_layout Plain Layout
PitchCorrection.R
\end_layout

\end_inset

in the Ranadu
\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!package!Ranadu!repository
\end_layout

\end_inset

 package, available at this 
\begin_inset Index idx
status open

\begin_layout Plain Layout
repository!GitHub
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
repository!Ranadu
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
GitHub repository
\end_layout

\end_inset

URL: 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/WilliamCooper/Ranadu.git
\end_layout

\end_inset

, subdirectory 
\begin_inset Quotes eld
\end_inset

R
\begin_inset Quotes erd
\end_inset

.
\end_layout

\begin_layout Subsubsection
Correcting the heading
\begin_inset CommandInset label
LatexCommand label
name "subsec:CorrectHeading"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!correction!simplified
\end_layout

\end_inset

An algorithm related to that used for correcting pitch is developed here
 for estimating the error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading
\end_layout

\end_inset

 in heading.
 The basis for the correction is that an error in heading results in an
 error in transformation of the 
\emph on
a-
\emph default
frame measurements of acceleration
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from IRU
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

 to the 
\emph on
l-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

.
 These 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!estimate
\end_layout

\end_inset

errors can be detected by comparing the actual acceleration of the aircraft
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!from GPS
\end_layout

\end_inset

 (determined from 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

derivatives of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based ground-speed
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset

 components, as in the preceding section) to the measurements of acceleration
 after transformation to the 
\emph on
l-
\emph default
frame.
 
\begin_inset Foot
status open

\begin_layout Plain Layout
Additional small corrections arise from rotation of the Earth
\begin_inset Index idx
status open

\begin_layout Plain Layout
Earth!rotation rate
\end_layout

\end_inset

 and rotation of the 
\emph on
l-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 in an inertial
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!inertial
\end_layout

\end_inset

 frame, as discussed later..
\end_layout

\end_inset

 If those measurements
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!acceleration!surrogate
\end_layout

\end_inset

 are not available, they can be 
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!retrieving
\end_layout

\end_inset

retrieved by differentiating the corresponding ground-speed components provided
 by the INS, as discussed in Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:retrieving-accelerations"

\end_inset

.
 
\end_layout

\begin_layout Standard
The required 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transformation, developed by 
\begin_inset CommandInset citation
LatexCommand citet
key "Bulletin23"

\end_inset

 and others, 
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle!definition
\end_layout

\end_inset

involves a rotation about the roll axis to level the wings, a rotation about
 the pitch axis to level the longitudinal axis of the aircraft, and a rotation
 about the vertical axis as required to point the aircraft to the north.
 However, if there is an error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!equation for
\end_layout

\end_inset

 in the heading (
\begin_inset Formula $\delta\psi$
\end_inset

) the last rotation will give final components 
\begin_inset Formula $a_{x,y,z}^{(l)}$
\end_inset

 that have respective errors of 
\begin_inset Formula $\delta a_{x}^{(l)}=a_{x}^{(l)}(1-\cos\delta\psi)-a_{y}^{(l)}\sin\delta\psi$
\end_inset

, 
\begin_inset Formula $\delta a_{y}^{(l)}=a_{y}^{(l)}(1-\cos\delta\psi)+a_{x}^{(l)}\sin\delta\psi$
\end_inset

, and 
\begin_inset Formula $\delta a_{z}^{(l)}=0$
\end_inset

 or, for small angles,
\begin_inset Newline newline
\end_inset


\begin_inset Formula 
\begin{align}
\left[\begin{array}{c}
\delta a_{x}^{(l)}\\
\delta a_{y}^{(l)}\\
\delta a_{z}^{(l)}
\end{array}\right] & =\left[\begin{array}{ccc}
0 & -\delta\psi & 0\\
\delta\psi & 0 & 0\\
0 & 0 & 0
\end{array}\right]\left[\begin{array}{c}
a_{x}^{(l)}\\
a_{y}^{(l)}\\
a_{z}^{(l)}
\end{array}\right]\label{eq:heading-error-equation}\\
\delta a_{x}^{(l)} & =-a_{y}^{(l)}\delta\psi\label{eq:ax-error}\\
\delta a_{y}^{(l)} & =a_{x}^{(l)}\delta\psi\label{eq:ay-error}\\
\delta\psi & =\frac{a_{x}^{(l)}\delta a_{y}^{(l)}-a_{y}^{(l)}\delta a_{x}^{(l)}}{(a_{x}^{(l)})^{2}+(a_{y}^{(l)})^{2}}\label{eq:estimator-equation}
\end{align}

\end_inset

The last equation is obtained
\begin_inset Foot
status open

\begin_layout Plain Layout
If the error measure to be minimized is 
\begin_inset Formula $\chi^{2}=(\delta a_{x}+a_{y}\delta\psi)^{2}+(\delta a_{y}-a_{x}\delta\psi)^{2}$
\end_inset

, differentiating 
\begin_inset Formula $\chi^{2}$
\end_inset

 with respect to 
\begin_inset Formula $\delta\psi$
\end_inset

 and setting the result equal to zero gives (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:estimator-equation"

\end_inset

).
\end_layout

\end_inset

 by minimizing the errors between the values of 
\begin_inset Formula $\delta a_{i}^{(l)}$
\end_inset

 given by (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:ax-error"

\end_inset

) and (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:ay-error"

\end_inset

) and the measured error given by 
\begin_inset Formula $(a_{i}^{*}-a_{i}^{(l)})$
\end_inset

.
 This then gives an estimate of the rotation 
\begin_inset Formula $-\delta\psi$
\end_inset

 that gives the best match between the measured accelerations
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset

  and those determined from the derivatives
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!derivative
\end_layout

\end_inset

 of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based ground-speed
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset

 components.
 The resulting value of 
\begin_inset Formula $\delta\psi$
\end_inset

 from (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:estimator-equation"

\end_inset

) is then an estimate of the error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!estimate
\end_layout

\end_inset

 in heading.
 As in the pitch-correction algorithm, the acceleration
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!determined from GPS
\end_layout

\end_inset

 vector 
\begin_inset Formula $\mathbf{a^{*}}$
\end_inset

 is determined by differentiating the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!from GPS
\end_layout

\end_inset

GPS-measured velocity components using Savitzky-Golay polynomials, 
\begin_inset Index idx
status open

\begin_layout Plain Layout
derivative!Savitzky-Golay
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
derivative!--|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

--,derivative
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
polynomial!Savitzky-Golay
\end_layout

\end_inset

, but with a 31
\begin_inset space \thinspace{}
\end_inset

s span to avoid excessive distortion in 3-min turns.
 It was previously estimated that the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS!uncertainty
\end_layout

\end_inset

uncertainty
\begin_inset Index idx
status open

\begin_layout Plain Layout
uncertainty!GPS-based measurements
\end_layout

\end_inset

 in a measurement of acceleration from differentiation of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based measurements of velocity is not more than about 0.01
\begin_inset space \thinspace{}
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-1}$
\end_inset

/
\begin_inset Formula $\tau$
\end_inset

 where 
\begin_inset Formula $\tau$
\end_inset

 is the time over which the average is calculated.
 For polynomials spanning 31 1_Hz samples, the effective averaging time
 is about 20
\begin_inset space \thinspace{}
\end_inset

s, leading to a minimum uncertainty of about 0.0005
\begin_inset space \thinspace{}
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

.
 Equation
\begin_inset space ~
\end_inset

(
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:estimator-equation"

\end_inset

) indicates that, for an uncertainty
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!uncertainty
\end_layout

\end_inset

 in the heading correction of 0.1
\begin_inset Formula $^{\circ}$
\end_inset

 or about 0.002
\begin_inset space ~
\end_inset

radians, the total horizontal acceleration should then be at least 0.0005/0.002=0.2
5
\begin_inset space ~
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

.
\end_layout

\begin_layout Standard
Typical horizontal accelerations in turns exceed 4
\begin_inset space ~
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

 in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\emph on
l-
\emph default
frame, but horizontal accelerations exceeding 1
\begin_inset space ~
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

 are seldom encountered outside of turns.
 Therefore, the algorithm
\begin_inset Index idx
status open

\begin_layout Plain Layout
algorithm!simplier!correct heading
\end_layout

\end_inset

 developed here only provides a valid correction if there are regular turns
 during the flight.
 In the following, heading corrections will be calculated only when the
 horizontal acceleration exceeds 1
\begin_inset space ~
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

 to avoid excessive noise and uncertainty.
 For a flight that transits in a straight line from start to finish, attempts
 to use these estimates are cannot be useful.
 Fortunately, in most research flights there are many turns, e.g., as the
 aircraft flies back and forth over a mountain range or flies fixed raster
 patterns for mapping.
 Each turn can provide significant horizontal accelerations that give estimates
 of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading
\end_layout

\end_inset

heading 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading
\end_layout

\end_inset

error, but these estimates are only sporadic and must be linked by extrapolation
 to obtain valid corrections spanning intervals without significant acceleration.
 The heading
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!correction
\end_layout

\end_inset

 correction therefore has a higher 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!uncertainty
\end_layout

\end_inset

uncertainty than the pitch correction and, unlike the pitch correction,
 depends on particular flight 
\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver!recommended
\end_layout

\end_inset

maneuvers for successful operation.
 In addition, unlike the pitch error, the heading error is not coupled
\begin_inset Index idx
status open

\begin_layout Plain Layout
coupling!weak
\end_layout

\end_inset

 to other errors in ways that limit its growth, so determining an estimated
 correction is important not only to provide improved measurements but also
 to determine the estimated magnitude of the uncorrected error.
\end_layout

\begin_layout Standard
The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!correction!requirements
\end_layout

\end_inset

requirements for valid results from this algorithm
\begin_inset Index idx
status open

\begin_layout Plain Layout
algorithm!simplier!correct heading
\end_layout

\end_inset

 are as follows:
\end_layout

\begin_layout Itemize
The flight
\begin_inset Index idx
status open

\begin_layout Plain Layout
flight path!recommendation
\end_layout

\end_inset

 path must include 
\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver!recommended
\end_layout

\end_inset

maneuvers that provide horizontal accelerations,
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!horizontal!required magnitude
\end_layout

\end_inset

 usually turns of at least 30
\begin_inset space \thinspace{}
\end_inset

s duration 
\emph on
in each direction.

\emph default
 The reason is that it is difficult to correct for 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!timing
\end_layout

\end_inset

timing
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!time lag
\end_layout

\end_inset

 errors in the measurements of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading
\end_layout

\end_inset

heading relative to the measured ground-speed
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset

 components from a 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS receiver, and even a delay
\begin_inset Index idx
status open

\begin_layout Plain Layout
time lag
\end_layout

\end_inset

 of 50
\begin_inset space \thinspace{}
\end_inset

ms will, for a turn rate corresponding to a three-minute turn through 360
\begin_inset Formula $^{\circ}$
\end_inset

, lead to a 0.05
\begin_inset Formula $^{\circ}$
\end_inset

 false indication of a heading error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!effect of lag
\end_layout

\end_inset

.
 However, the error reverses sign with the direction of the turn, so averaging
 the results from left turns and from right turns will correct for this
 false indication of a heading error.
 Course-reversal maneuvers
\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver!reverse heading
\end_layout

\end_inset

 like 
\begin_inset Quotes eld
\end_inset

90-270
\begin_inset Quotes erd
\end_inset

 turns (90
\begin_inset Formula $^{\circ}$
\end_inset

 one direction followed by 270
\begin_inset Formula $^{\circ}$
\end_inset

 the other direction) provide good data for this algorithm, as do 
\begin_inset Quotes eld
\end_inset

60-300-60
\begin_inset Quotes erd
\end_inset

 teardrop turns that are a faster means of returning to the starting point.
 If wind 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!measurement!recommendation
\end_layout

\end_inset

measurements are critical to the research, it may be useful to include patterns
 like 
\begin_inset Quotes eld
\end_inset

S
\begin_inset Quotes erd
\end_inset

 turns periodically, with 30
\begin_inset space \thinspace{}
\end_inset

s turns in opposite directions, to provide the needed accelerations.
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!horizontal!needed magnitude
\end_layout

\end_inset

 
\end_layout

\begin_layout Itemize
To the extent possible, sampled time series should be corrected for sampling
 delays.
\begin_inset Index idx
status open

\begin_layout Plain Layout
time lag
\end_layout

\end_inset

 The most important such correction is the timing of the heading 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!time lag
\end_layout

\end_inset

measurement from the INS
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial!timing
\end_layout

\end_inset

 relative to the ground-speed
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset

 measurements from the GPS
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

 receiver.
 In the examples shown in this note, the differences between different turn
 directions were minimized by shifting the heading forward in time by 92
\begin_inset space \thinspace{}
\end_inset

ms.
 The averaging provided by the first item above helps reduce 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!timing
\end_layout

\end_inset

errors from timing, but it is still preferable to keep those errors small.
 Full-circle patterns
\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver!circle
\end_layout

\end_inset

 flown in each turn direction provide a sensitive test of timing 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!timing
\end_layout

\end_inset

errors.
\end_layout

\begin_layout Standard
Many research flights and research data sets meet these requirements, and
 where wind 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!measurement!recommendation
\end_layout

\end_inset

measurement is important appropriate flight maneuvers can be incorporated
 into flight plans for future projects.
 The algorithm
\begin_inset Index idx
status open

\begin_layout Plain Layout
algorithm!simplier!Ranadu reference
\end_layout

\end_inset

 implemented here, for which R code is available in the 
\begin_inset Quotes eld
\end_inset

Ranadu
\begin_inset Quotes erd
\end_inset

 
\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!package!Ranadu
\end_layout

\end_inset

package (cf.
\begin_inset space ~
\end_inset


\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/WilliamCooper/Ranadu.git
\end_layout

\end_inset

, 
\begin_inset Index idx
status open

\begin_layout Plain Layout
GitHub repository
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
repository!Ranadu
\end_layout

\end_inset

directory 
\begin_inset Quotes eld
\end_inset

R
\begin_inset Quotes erd
\end_inset

, 
\begin_inset Index idx
status open

\begin_layout Plain Layout
function!HeadingCorrection
\end_layout

\end_inset

script 
\begin_inset Quotes eld
\end_inset

HeadingCorrection.R
\begin_inset Quotes erd
\end_inset

), includes these components:
\end_layout

\begin_layout Enumerate

\emph on
Shift the timing of the heading measurement as needed to match the GPS-receiver
 measurements of ground velocity.
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout

\emph on
Optionally, apply pitch and roll corrections using the algorithm developed
 in Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Correcting-the-pitch"

\end_inset

.
 
\emph default
The measurements of pitch and, to a lesser extent, roll affect the transformatio
n of the accelerations from the 
\emph on
a-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset

 to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\emph on
l-
\emph default
frame, but only have a very small effect, so omission of this step normally
 makes no detectable difference in the final heading correction.
\end_layout

\end_inset


\emph default
 
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
Although the correction developed here depends only weakly on the correction
 to pitch and roll, inclusion of this step may protect against or at least
 identify anomalously large errors in pitch.
 Reciprocally, the pitch correction depends on the measured heading, but
 the effect of heading errors are insignificant.
 Omission of this step normally makes no detectable difference.
\end_layout

\end_inset


\emph on
 
\end_layout

\begin_layout Enumerate

\emph on
Differentiate the ground-speed measurements provided by a GPS receiver,
\emph default
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!differentiated
\end_layout

\end_inset

using third-order Savitzky-Golay polynomials
\begin_inset Index idx
status open

\begin_layout Plain Layout
polynomial!Savitzky-Golay
\end_layout

\end_inset

 spanning 21
\begin_inset space \thinspace{}
\end_inset

s, to obtain reference measurements of horizontal accelerations
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!from GPS
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\emph on
l-
\emph default
frame.
 
\end_layout

\begin_layout Enumerate

\emph on
Transform the accelerations measured by the INS in the a-
\emph default
frame
\emph on
 to the l-
\emph default
frame.
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!
\emph on
a-
\emph default
frame
\end_layout

\end_inset

 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

Filter
\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!Savitzky-Golay
\end_layout

\end_inset

 these results also using Savitzky-Golay polynomials of the same order and
 span so that they are 
\begin_inset Index idx
status open

\begin_layout Plain Layout
smoothing
\end_layout

\end_inset

smoothed in the same way as the ground-speed
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset

 derivatives.
\end_layout

\begin_layout Enumerate

\emph on
Use (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:estimator-equation"

\end_inset

) to obtain estimates of the heading error 
\begin_inset Formula $\delta\psi$
\end_inset

 at each time.

\emph default
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!estimate
\end_layout

\end_inset

However, apply data restrictions to avoid cases of high uncertainty.
 The most important restriction used here was to require that the total
 horizontal acceleration
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!horizontal!required magnitude
\end_layout

\end_inset

 in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\emph on
l-
\emph default
frame be larger than 
\begin_inset Formula $1$
\end_inset


\begin_inset space \thinspace{}
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

.
 
\end_layout

\begin_layout Enumerate

\emph on
Use a search algorithm to identify flight segments with turns
\emph default
 (specifically, magnitude of roll larger than 10
\begin_inset Formula $^{\circ}$
\end_inset

)
\begin_inset Index idx
status open

\begin_layout Plain Layout
algorithm!search for turns
\end_layout

\end_inset

 continuously except for possible gaps of 5
\begin_inset space \thinspace{}
\end_inset

min.
 Require that these flight
\begin_inset Index idx
status open

\begin_layout Plain Layout
flight segments!for heading correction
\end_layout

\end_inset

 segments have both right and left turns, with at least 25
\begin_inset space \thinspace{}
\end_inset

s of each.
\end_layout

\begin_layout Enumerate

\emph on
For each such segment, calculate the mean correction
\emph default
 and its standard 
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!heading correction
\end_layout

\end_inset

deviation and the mean time for each turn direction.
\end_layout

\begin_layout Enumerate

\emph on
Use cubic spline interpolation
\emph default
 to represent the heading correction
\begin_inset Index idx
status open

\begin_layout Plain Layout
spline!cubic
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
interpolation!spline
\end_layout

\end_inset

 over the course of the flight.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
Two possible choices are shown in Fig.
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:spline-plot}
\end_layout

\end_inset

; of these, the smoother choice is incorporated into the algorithm.
\end_layout

\end_inset


\end_layout

\begin_layout Enumerate

\emph on
Subtract the result given by this interpolation from the measured heading
 to obtain the corrected heading.
\end_layout

\begin_layout Subsubsection
Results from the simple correction algorithms
\end_layout

\begin_layout Standard
Results will be presented later in comparison to the results from the Kalman
 filter.
 See Figs.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:a-frame-errors"

\end_inset

 and 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:plot-Kalman-heading}
\end_layout

\end_inset

.
 
\end_layout

\begin_layout Subsection
Angle of attack
\end_layout

\begin_layout Standard
As described in 
\begin_inset CommandInset citation
LatexCommand citet
key "Cooper2016ncartn"

\end_inset

, the standard empirical represention of angle of attack
\begin_inset Index idx
status open

\begin_layout Plain Layout
angle of attack!empirical representation
\end_layout

\end_inset

 has been
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\alpha=c_{0}+\frac{\Delta p_{\alpha}}{q}\left(c_{1}+c_{2}M\right)\label{eq:old-AKRD}
\end{equation}

\end_inset

where 
\begin_inset Formula $\Delta p_{\alpha}$
\end_inset

 is the pressure difference 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!pressure difference!between radome ports
\end_layout

\end_inset

measured on the radome between top and bottom 
\begin_inset Index idx
status open

\begin_layout Plain Layout
radome!pressure ports
\end_layout

\end_inset

ports, 
\begin_inset Formula $q$
\end_inset

 is the dynamic pressure
\begin_inset Index idx
status open

\begin_layout Plain Layout
pressure!dynamic
\end_layout

\end_inset

 and 
\begin_inset Formula $M$
\end_inset

 is the Mach
\begin_inset Index idx
status open

\begin_layout Plain Layout
Mach number
\end_layout

\end_inset

 number calculated from the measurements
\begin_inset Index idx
status open

\begin_layout Plain Layout
pressure!dynamic
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
pressure!ambient
\end_layout

\end_inset

 of dynamic and static pressure
\begin_inset Index idx
status open

\begin_layout Plain Layout
pressure!static
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
pressure!ambient
\end_layout

\end_inset

 before static-defect
\begin_inset Index idx
status open

\begin_layout Plain Layout
static defect
\end_layout

\end_inset

 corrections are applied.
 The coefficients
\begin_inset Index idx
status open

\begin_layout Plain Layout
angle of attack!empirical representation
\end_layout

\end_inset

 were found by 
\begin_inset Index idx
status open

\begin_layout Plain Layout
fit!angle of attack
\end_layout

\end_inset

fitting that formula to a 
\begin_inset Index idx
status open

\begin_layout Plain Layout
angle of attack!empirical representation!reference for calibration
\end_layout

\end_inset

reference value 
\begin_inset Formula $\alpha^{*}$
\end_inset

 that assumes there is zero vertical wind:
\begin_inset Newline newline
\end_inset


\begin_inset Formula 
\begin{equation}
\alpha^{*}=\theta-\frac{w_{p}}{V}\label{eq:AOAREF}
\end{equation}

\end_inset

where 
\begin_inset Formula $\theta$
\end_inset

 is the pitch angle, 
\begin_inset Formula $w_{p}$
\end_inset

 the rate of climb of the aircraft
\begin_inset Index idx
status open

\begin_layout Plain Layout
rate of climb
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
rate of climb
\end_layout

\end_inset

 and 
\begin_inset Formula $V$
\end_inset

 the airspeed.
\begin_inset Index idx
status open

\begin_layout Plain Layout
airspeed
\end_layout

\end_inset


\end_layout

\begin_layout Standard
An alternate approach is developed here.
 The reference value as given by (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:AOAREF"

\end_inset

) is split into two components, 
\begin_inset Formula $\alpha^{*}=\alpha_{f}^{*}+\alpha_{s}^{*}$
\end_inset

 that result from applying a Butterworth low-pass filter
\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!Butterworth
\end_layout

\end_inset

  to 
\begin_inset Formula $\alpha^{*}$
\end_inset

 (in the code, the variable AOAREF) to obtain 
\begin_inset Formula $\alpha_{s}^{*}$
\end_inset

 and then finding 
\begin_inset Formula $\alpha_{f}^{*}$
\end_inset

 from 
\begin_inset Formula $\alpha_{f}^{*}=\alpha^{*}-\alpha_{s}^{*}$
\end_inset

, where the 
\begin_inset Formula $f$
\end_inset

 and 
\begin_inset Formula $s$
\end_inset

 subscripts represent the high-pass and low-pass components after filtering.
 These components are then represented by 
\begin_inset Index idx
status open

\begin_layout Plain Layout
fit!angle of attack!new
\end_layout

\end_inset

separate fits:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\alpha_{f}=c_{1}\left(\frac{\Delta p_{\alpha}}{q}\right)_{f}=c_{1}\left(\frac{\mathrm{\{ADIFR\}}}{\mathrm{\{QCF\}}}\right)_{f}\label{eq:alpha-fast}
\end{equation}

\end_inset


\begin_inset Formula 
\begin{equation}
\alpha_{s}=d_{0}+d_{1}\left(\frac{\Delta p_{\alpha}}{q}\right)_{s}+d_{2}q_{s}=d_{0}+d_{1}\left(\frac{\mathrm{\{ADIFR\}}}{\mathrm{\{QCF\}}}\right)_{s}+d_{2}\mathrm{\{QCF\}}_{s}\label{eq:alpha-slow}
\end{equation}

\end_inset

 where the second equalities in each line reference the standard variable
 names used in 
\begin_inset Index idx
status open

\begin_layout Plain Layout
netCDF
\end_layout

\end_inset

netCDF archives
\begin_inset Index idx
status open

\begin_layout Plain Layout
data!standard archive
\end_layout

\end_inset

 to represent the corresponding quantities in the first equality.
 More complicated representations were tested in both cases, but these appear
 to provide adequate fits without additional terms.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<read-sensitivity-coef, cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# load (file='~/RStudio/Reprocessing/AKRD-fit-coef.Rdata')
\end_layout

\begin_layout Plain Layout

cffn <- 19.70547
\end_layout

\begin_layout Plain Layout

cff <- 21.481
\end_layout

\begin_layout Plain Layout

cfs <- c(4.525341674, 19.933222011, -0.001960992)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
This approach has a substantial advantage
\begin_inset Index idx
status open

\begin_layout Plain Layout
angle of attack!empirical representation!new approach
\end_layout

\end_inset

 over the approach in standard use.
 The important sensitivity to fluctuations is not compromised by efforts
 to represent the slowly varying zero level for angle of attack, and the
 slowly varying offset can be represented by more complex equations without
 having those added factors influence the high-frequency response.
 The result is an empirical representation that is appropriate for all recent
 GV
\begin_inset Index idx
status open

\begin_layout Plain Layout
aircraft!NSF/NCAR GV
\end_layout

\end_inset

 projects and that does not need to be changed for each project, as has
 been the case for many recent projects that use the standard representation.
 
\end_layout

\begin_layout Standard
To find the coefficients
\begin_inset Index idx
status open

\begin_layout Plain Layout
angle of attack!empirical representation
\end_layout

\end_inset

 in (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:alpha-fast"

\end_inset

) and (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:alpha-slow"

\end_inset

), a composite data set was constructed from most flights from three recent
 projects, ORCAS, CSET, and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset

DEEPWAVE.
\begin_inset Foot
status open

\begin_layout Plain Layout
For descriptions of these projects, see the EOL web site at 
\begin_inset CommandInset href
LatexCommand href
name "this URL"
target "https://www.eol.ucar.edu/recent-projects-and-deployments"

\end_inset

.
\end_layout

\end_inset

 A full description of how these coefficients were determined is contained
 in 
\begin_inset Index idx
status open

\begin_layout Plain Layout
angle of attack!empirical representation!standard reference
\end_layout

\end_inset


\begin_inset CommandInset href
LatexCommand href
name "this document"
target "https://drive.google.com/open?id=0B1kIUH45ca5AUmR1UkNUUVdBRFE"

\end_inset

, and the coefficients from that analysis are used here.
 They are 
\begin_inset Formula $c_{1}=$
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(cff,4)}
\end_layout

\end_inset

 and {
\begin_inset Formula $d$
\end_inset

} = {
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(cfs[1], 4)}
\end_layout

\end_inset

, 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(cfs[2], 4)}
\end_layout

\end_inset

, 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(cfs[3], 6)}
\end_layout

\end_inset

}.
 Then the variables entering the fits in (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:alpha-fast"

\end_inset

) and (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:alpha-slow"

\end_inset

) were obtained by using a low-pass Butterworth forward-and-backward filter
\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!Butterworth
\end_layout

\end_inset

  to find the slowly varying components 
\begin_inset Formula $(\Delta p_{\alpha}/q)_{s}$
\end_inset

 and 
\begin_inset Formula $q_{s}$
\end_inset

, and the first was subtracted from the unfiltered variable to find 
\begin_inset Formula $(\Delta p_{\alpha}/q)_{f}$
\end_inset

.
 The new angle-of-attack variable was then calculated from 
\begin_inset Formula $\alpha=\alpha_{f}+\alpha_{s}$
\end_inset

.
\end_layout

\begin_layout Standard
This calculation gave much less variation from project to project and within
 projects and seemed to provide a standard representation applicable to
 all recent GV
\begin_inset Index idx
status open

\begin_layout Plain Layout
aircraft!NSF/NCAR GV
\end_layout

\end_inset

 projects since a change was made to the radome.
 
\end_layout

\begin_layout Section
The Kalman filter
\begin_inset CommandInset label
LatexCommand label
name "sec:The-Kalman-filter"

\end_inset


\end_layout

\begin_layout Subsection
The algorithm used
\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
overview!Kalman filter algorithm
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter
\end_layout

\end_inset

Section 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Mechanization"

\end_inset

 verified that a valid representation of the derivatives
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

 of the state vector is available.
\begin_inset Index idx
status open

\begin_layout Plain Layout
algorithm!Kalman filter
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!algorithm
\end_layout

\end_inset

 An error-state Kalman
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!error-state
\end_layout

\end_inset

 filter that uses that derivative function is described in this section.
 The computational algorithm has these components: 
\begin_inset Note Note
status open

\begin_layout Plain Layout
Before presenting that development, however, it is necessary to discuss
 two aspects of the Kalman filter developed here: 
\end_layout

\begin_layout Enumerate
Errors in the pitch and roll angles represent errors in the calculated level
 position of the IRU.
 For a fixed orientation error, when the aircraft turns, the errors in pitch
 and roll intermix, with for example a pitch error during northbound flight
 becoming a roll error during eastbound flight while the roll error becomes
 a pitch error.
 If a Kalman filter is implemented with error terms for pitch and roll in
 the 
\emph on
a-
\emph default
frame, there will be large transient errors arising from course changes
 that must be corrected via the Kalman filter, whereas if the filter is
 implemented with errors in the 
\emph on
l-
\emph default
frame the respective north and east components of the attitude-angle errors
 remain approximately constant.
 For this reason, it is preferable to implement the filter using attitude-angle
 errors as they appear in the 
\emph on
l-
\emph default
frame.
 The correction terms developed by the Kalman filter must then be transformed
 back to the 
\emph on
a-
\emph default
frame before they are applied to the measurements of pitch and roll.
 
\end_layout

\begin_layout Enumerate
Conventional implementations of Kalman-filter updating use the measurements
 of position and velocity from the GPS receiver as the external measurements
 to which the INS measurements are compared.
 This works well for all but the heading measurement.
 A heading error results in erroneous resolution of measured accelerations
 into 
\emph on
l-
\emph default
frame components and so to errors in velocity, but the feedback of these
 errors to heading is slow and noisy.
 Therefore, a more direct method of coupling GPS-derived measurements to
 heading errors will be used by differentiating the GPS-measured valocities
 to obtain independent measurements of acceleration and then using these
 measured 
\emph on
l-
\emph default
frame accelerations as additional measurements to be compared to the INS
 solution.
 If there is an error in heading, these accelerations will lead to a difference
 between the GPS-derived direction of 
\emph on
l-
\emph default
frame acceleration and the INS-derived direction, and this can be considered
 a direct measurement of heading error.
 Except in turns, the measured 
\emph on
l-
\emph default
frame acceleration is too small and noisy for this to be effective, but
 turns produce strong signals and consequent constraints on the heading
 error.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
The Kalman filter is then constructed as follows:
\end_layout

\end_inset


\end_layout

\begin_layout Enumerate
The first step is to initialize an error-state vector
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-state vector
\end_layout

\end_inset

 
\begin_inset Formula $\delta\mathbf{x}$
\end_inset

 from initial 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from INS
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS
\end_layout

\end_inset

measurements of the differences between the INS and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based values of position and velocity.
 Other errors in components of the state vector are unknown at the start
 of the integration and so will be initialized as zero.
 The 15-component vector used here contains the respective errors in 
\begin_inset Index idx
status open

\begin_layout Plain Layout
latitude
\end_layout

\end_inset

latitude, 
\begin_inset Index idx
status open

\begin_layout Plain Layout
longitude
\end_layout

\end_inset

longitude, altitude
\begin_inset Index idx
status open

\begin_layout Plain Layout
altitude of aircraft
\end_layout

\end_inset

, eastward ground speed, northward ground speed, rate of climb, pitch, roll,
 heading, pitch-axis rotation rate, roll-axis rotation rate, yaw-axis rotation
 rate, lateral
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!lateral
\end_layout

\end_inset

 component of acceleration,
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset

  longitudinal component of acceleration, and normal component of acceleration.
 The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!rotation rate
\end_layout

\end_inset

rotation-rate errors and acceleration 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!acceleration
\end_layout

\end_inset

errors
\begin_inset Index idx
status open

\begin_layout Plain Layout
accelerometer!bias
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
gyro!bias
\end_layout

\end_inset

 in this 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-state vector
\end_layout

\end_inset

error-state vector are biases; random errors enter instead through the noise-cov
ariance matrix
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!!noise covariance
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!noise
\end_layout

\end_inset

 
\begin_inset Formula $\mathbf{Q}$
\end_inset

 below.
\end_layout

\begin_layout Enumerate
The covariance
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!covariance
\end_layout

\end_inset

 matrix
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!covariance
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!matrices
\end_layout

\end_inset

 
\begin_inset Formula $\mathbf{V}$
\end_inset

 characterizing the errors in the error-state vector
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-state vector
\end_layout

\end_inset

 is also needed.
 This is here initialized to have rather large components corresponding
 to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

INS-provided measurements because it is expected that the GPS
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS!uncertainty
\end_layout

\end_inset

measurements will have much lower uncertainty
\begin_inset Index idx
status open

\begin_layout Plain Layout
uncertainty!GPS-based measurements
\end_layout

\end_inset

 than these INS-provided components and that will constrain the covariance
 matrix during the calculation.
 
\begin_inset Formula $\mathbf{V}$
\end_inset

 is initialized as a 15
\begin_inset Formula $\times$
\end_inset

15 diagonal matrix where the diagonal elements are the squares of these
 values: {2000/
\begin_inset Formula $R_{m}$
\end_inset

, 2000/(
\begin_inset Formula $R_{n}$
\end_inset

cos
\begin_inset Formula $\lambda$
\end_inset

), 500, 2, 2, 2, 0.3
\begin_inset Formula $^{\circ}$
\end_inset

, 0.3
\begin_inset Formula $^{\circ}$
\end_inset

, 1
\begin_inset Formula $^{\circ}$
\end_inset

, 0.005
\begin_inset Formula $^{\circ}s^{-1}$
\end_inset

, 0.005
\begin_inset Formula $^{\circ}s^{-1}$
\end_inset

, 0.005
\begin_inset Formula $^{\circ}s^{-1}$
\end_inset

, 0.0005, 0.0005, 0.0005}.
 All entries are in SI units except those where units are listed as degrees,
 and those cases are converted to radians before use.
 The variables 
\begin_inset Formula $R_{m}$
\end_inset

 and 
\begin_inset Formula $R_{n}$
\end_inset

 are appropriate radii of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
radius of curvature!Earth
\end_layout

\end_inset

Earth, as discussed in Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:deriv-array"

\end_inset

, and 
\begin_inset Formula $\lambda$
\end_inset

 is the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
latitude
\end_layout

\end_inset

latitude.
 The initial values assigned to this covariance matrix have little effect
 on the results because the covariance matrix is updated during the calculation
 based on the other error estimates.
\end_layout

\begin_layout Enumerate
The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
function!derivative
\end_layout

\end_inset

function 
\begin_inset Quotes eld
\end_inset

STMFV
\begin_inset Quotes erd
\end_inset

 was verified above and so provides appropriate 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

derivatives of the state vector, for the first nine components.
 The error-state 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-state vector
\end_layout

\end_inset

vector, however, also includes errors in the additional six components represent
ing the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!rotation rate
\end_layout

\end_inset

rotation-rate and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!acceleration
\end_layout

\end_inset

acceleration vectors.
 The derivatives of the first nine components depend on the derivatives
 of the additional six components, so all 15 elements in the error-state
 vector must be considered.
 For an error-state Kalman
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!error-state
\end_layout

\end_inset

 filter, the forward propagation of the error state
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-state vector!propagation
\end_layout

\end_inset

 can be found from the Jacobian
\begin_inset Index idx
status open

\begin_layout Plain Layout
Jacobian!of derivative function
\end_layout

\end_inset

 
\begin_inset Formula $\mathbf{J}(\mathbf{x})$
\end_inset

 of that derivative function of the state vector, so the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!state transition
\end_layout

\end_inset

error-state transition 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!matrices
\end_layout

\end_inset

matrix 
\begin_inset Formula $\mathbf{T}$
\end_inset

 is the sum of that Jacobian (multiplied by the time 
\begin_inset Index idx
status open

\begin_layout Plain Layout
time step
\end_layout

\end_inset

step) and the 15-element diagonal matrix:
\begin_inset Newline newline
\end_inset


\begin_inset Formula 
\begin{equation}
\delta\mathbf{x}_{k}=\mathbf{T}\thinspace\delta\mathbf{x}_{k-1}=(\mathbf{J}(\mathbf{x}_{k-1})\thinspace\Delta t+\mathbf{I})\thinspace\delta\mathbf{x}_{k-1}\label{eq:error-state-transition}
\end{equation}

\end_inset

The derivative
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative!extension
\end_layout

\end_inset

 function
\begin_inset Index idx
status open

\begin_layout Plain Layout
function!derivative!extension
\end_layout

\end_inset

 must be extended for this use beyond that used for mechanization, because
 the dependence of the first nine components on the additional six components
 is needed for the complete Jacobian.
 Furthermore, the dependence of the additional six derivatives on each other
 and the first nine components is needed.
 This is added as follows:
\end_layout

\begin_deeper
\begin_layout Enumerate
Expanding the state-vector 
\begin_inset Formula $\mathbf{x}$
\end_inset

 to include all 15 components naturally includes the effect of the added
 six components on the first nine components because the derivative
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

 calculation outlined earlier already includes these dependencies.
 The corresponding components of the Jacobian will therefore be included
 naturally.
\end_layout

\begin_layout Enumerate
The dependence that is not included in that case is the dependence of the
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative!extension
\end_layout

\end_inset

derivatives of the last six components on the values of the first nine.
 There is no such dependence, though, because these are direct measurements
 in an inertial frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!inertial
\end_layout

\end_inset

 and so are not affected by other components of the state vector.
 The changes in the errors in acceleration or rotation rate do not depend
 analytically on any other part of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-state vector
\end_layout

\end_inset

error-state vector, so the terms in the Jacobian
\begin_inset Index idx
status open

\begin_layout Plain Layout
Jacobian!of derivative function
\end_layout

\end_inset

 involving these components will be zero.
 This arises naturally if the state vector is expanded to 15 components
 and then used to calculate the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Jacobian!numerical evaluation
\end_layout

\end_inset

Jacobian
\begin_inset Index idx
status open

\begin_layout Plain Layout
function!Jacobian
\end_layout

\end_inset

 numerically.
 There will be new terms in the Jacobian describing how, for example, a
 derivative of a velocity component changes with the change in a component
 of acceleration, but not the reverse component describing how the derivative
 of a component of acceleration
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset

  changes with the change in velocity component.
 The highest 6
\begin_inset Formula $\times$
\end_inset

6 submatrix in the Jacobian will have 0 for all terms.
 
\end_layout

\begin_layout Enumerate
Implementation then involves having the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

derivative function
\begin_inset Index idx
status open

\begin_layout Plain Layout
function!derivative
\end_layout

\end_inset

 return a 15-component derivative where the first nine components are as
 before and the last six components are zero.
 Using that derivative function to find the Jacobian
\begin_inset Index idx
status open

\begin_layout Plain Layout
Jacobian!of derivative function
\end_layout

\end_inset

 will then include terms that involve all the components and so describe
 the full interdependence of the errors.
 For example, errors in the rotation-rate components will affect all of
 the error terms for the first nine components and so will enter most of
 the Jacobian terms involving the derivatives of the first nine components
 with respect to the rotation-rate components.
\end_layout

\end_deeper
\begin_layout Enumerate
The noise-covariance matrix
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!noise
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!noise
\end_layout

\end_inset

 
\begin_inset Formula $\mathbf{Q}$
\end_inset

 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!matrices
\end_layout

\end_inset

represents the estimated 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from INS!noise
\end_layout

\end_inset

noise in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

INS forward integration.
 The results vary significantly with different choices for these values,
 and the choices made here are the result of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
tuning
\end_layout

\end_inset

tuning to find a set of values giving reasonable results.
 The 15 values used for the diagonal components of this matrix are the squares
 of the following: {
\begin_inset Formula $a$
\end_inset

/
\begin_inset Formula $R_{m}$
\end_inset

, 
\begin_inset Formula $a$
\end_inset

/
\begin_inset Formula $(R_{n}\cos\lambda$
\end_inset

), 
\begin_inset Formula $a$
\end_inset

, 0.02
\begin_inset space ~
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-1}$
\end_inset

, 0.02
\begin_inset space ~
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-1}$
\end_inset

,, 0.05
\begin_inset space ~
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-1}$
\end_inset

,, 0.01
\begin_inset Formula $^{\circ}$
\end_inset

, 0.01
\begin_inset Formula $^{\circ}$
\end_inset

, 0.01
\begin_inset Formula $^{\circ}$
\end_inset

, 0.02
\begin_inset Formula $^{\circ}$
\end_inset

/s, 0.02
\begin_inset Formula $^{\circ}$
\end_inset

/s, 0.02
\begin_inset Formula $^{\circ}$
\end_inset

/s, 0.00005
\begin_inset space \thinspace{}
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

, 0.00005
\begin_inset space \thinspace{}
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

, 0.00005
\begin_inset space \thinspace{}
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

} where 
\begin_inset Formula $a$
\end_inset

 is 10
\begin_inset space ~
\end_inset

m.
 Cases with units of degrees are converted to radians before use.
 These values are used with a 5-s time 
\begin_inset Index idx
status open

\begin_layout Plain Layout
time step
\end_layout

\end_inset

step, and they may need adjustment if a different time step is used.
 To estimate these values, a high-pass filter of high-rate measurements
 for a straight-and-level flight segment was used to find the standard deviation
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!measurements
\end_layout

\end_inset

 of such signals applicable at a 0.2
\begin_inset space ~
\end_inset

Hz sample rate, corresponding to the 5-s time step used in this particular
 implementation of the Kalman filter.
 For positions, this approach indicated that appropriate values would be
 about 10% of the listed values, but the listed values were used instead
 because the smaller values tended to result in numerical singularities
\begin_inset Index idx
status open

\begin_layout Plain Layout
singularity
\end_layout

\end_inset

 in the inversion
\begin_inset Index idx
status open

\begin_layout Plain Layout
inversion!computational singularity
\end_layout

\end_inset

 required in step 6 below.
 This change did not otherwise result in any significant change in the solution.
 In the case of accelerations,
\begin_inset Index idx
status open

\begin_layout Plain Layout
accelerometer!noise
\end_layout

\end_inset

 the variance 
\begin_inset Index idx
status open

\begin_layout Plain Layout
spectrum!variance
\end_layout

\end_inset

spectra for these measurements show characteristics of a 
\begin_inset Index idx
status open

\begin_layout Plain Layout
variance spectrum!noise
\end_layout

\end_inset

noise limit at an amplitude of about 0.001
\begin_inset space ~
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

.
 However, this appears to arise from the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
resolution!data recording
\end_layout

\end_inset

resolution with which the variables were recorded, so the forward integration
\begin_inset Index idx
status open

\begin_layout Plain Layout
integration!INS
\end_layout

\end_inset

 in the INS may use less noisy measurements.
 When a noise estimate this large was used in the following calculations,
 substantial errors in 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch!dependence on noise
\end_layout

\end_inset

pitch and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!roll
\end_layout

\end_inset

roll were predicted that seemed unrealistic and were reduced substantially
 if these noise estimates were reduced.
 The very low values listed above for these elements of the noise-covariance
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!noise
\end_layout

\end_inset

 matrix correspond to assuming that the noise affecting the accelerometers
\begin_inset Index idx
status open

\begin_layout Plain Layout
accelerometer!noise
\end_layout

\end_inset

 is negligible, and indeed setting these values to zero gives almost the
 same result as that obtained by using these small values.
 The Kalman filter does estimate non-zero bias
\begin_inset Index idx
status open

\begin_layout Plain Layout
accelerometer!bias
\end_layout

\end_inset

 in accelerations during the integration, so very small noise estimates
 still permit compensation for errors in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!accelerometer
\end_layout

\end_inset

accelerometers.
\begin_inset Index idx
status open

\begin_layout Plain Layout
accelerometer!error
\end_layout

\end_inset

 
\begin_inset Note Note
status open

\begin_layout Plain Layout
Further support for this estimate comes from the standard deviations listed
 as the first two entries in Table
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "tab:accel-fits"

\end_inset

.
\end_layout

\end_inset

 All the values listed may be higher than the true noise, but at least they
 should be upper limits.
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset Foot
status collapsed

\begin_layout Plain Layout
For numerical reasons, the first two components were increased by a factor
 of 10 to avoid failure to invert the matrix required below for the Kalman-gain
 matrix because of the large range in values in the resulting matrix.
 
\end_layout

\end_inset


\end_layout

\end_inset

 
\begin_inset Note Note
status open

\begin_layout Plain Layout
Experimentation with the components corresponding to acceleration set to
 zero gave results almost exactly matching the simple pitch-correction algorithm
 discussed in Sect.
\begin_inset space ~
\end_inset

3.
 That analysis assumes no error in acceleration, while these terms represent
 only random components while the Kalman filter determines an estimate of
 bias.
\end_layout

\end_inset


\end_layout

\begin_layout Enumerate
Once 
\begin_inset Formula $\mathbf{T}$
\end_inset

 and 
\begin_inset Formula $\mathbf{Q}$
\end_inset

 are specified, the covariance 
\begin_inset Formula $\mathbf{V}$
\end_inset

 
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!covariance
\end_layout

\end_inset

matrix
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!covariance
\end_layout

\end_inset

 can be updated each 
\begin_inset Index idx
status open

\begin_layout Plain Layout
time step
\end_layout

\end_inset

time step via
\begin_inset Foot
status open

\begin_layout Plain Layout
Matrix multiplication is indicated by adjacent matrices separated by spaces.
 The corresponding symbol in R is '%*%' but transposition is sometimes required
 because matrices are represented in R in column-major format.
\end_layout

\end_inset


\begin_inset Newline newline
\end_inset


\begin_inset Formula 
\begin{equation}
\mathbf{V}=\mathbf{T}\thinspace\mathbf{V}\thinspace\mathbf{T}^{T}+\mathbf{Q}\label{eq:covariance-update}
\end{equation}

\end_inset


\end_layout

\begin_layout Enumerate
The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!matrices
\end_layout

\end_inset

Kalman gain
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!Kalman gain
\end_layout

\end_inset

 is then given by
\begin_inset Newline newline
\end_inset


\begin_inset Formula 
\begin{equation}
\mathbf{K}=\mathbf{V\thinspace}\mathbf{H}^{T}\mathbf{\left\{ \mathbf{H}\thinspace\mathbf{V}\thinspace\mathbf{H}^{T}+\mathbf{R}\right\} ^{-1}}\label{eq:kalman-gain}
\end{equation}

\end_inset

where 
\begin_inset Formula $\mathbf{H}$
\end_inset

 is a 15
\begin_inset Formula $\times$
\end_inset

6 diagonal matrix
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!matrices
\end_layout

\end_inset

 representing how the six measured differences
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

 (GPS-INS) correspond to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-state vector
\end_layout

\end_inset

error-state vector.
 
\begin_inset Formula $\mathbf{R}$
\end_inset

 is the measurement-noise covariance matrix
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!measurement noise
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!measurement noise
\end_layout

\end_inset

 representing the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS!noise
\end_layout

\end_inset

noise in the GPS-based measurements, a 6
\begin_inset Formula $\times$
\end_inset

6 matrix having diagonal elements that are the squares of these components:
 {0.5/
\begin_inset Formula $R_{m}$
\end_inset

, 0.5/(
\begin_inset Formula $R_{n}\cos\lambda$
\end_inset

), 0.5, 0.02, 0.02, 0.05} in SI units.
 These were based on the same analysis used to determine estimates for the
 components of 
\begin_inset Formula $\mathbf{Q}$
\end_inset

 and represent very high confidence in the measurements from the GPS receiver.
 The particular time interval was one where 
\begin_inset CommandInset href
LatexCommand href
name "OmniSTAR corrections"
target "http://www.omnistar.com/"

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
OmniSTAR corrections
\end_layout

\end_inset

 were available, so this represents the best performance that can be expected
 from the GPS receiver.
 An additional seventh component, based on an estimate of the heading 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!estimate
\end_layout

\end_inset

error determined from (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:estimator-equation"

\end_inset

) above, will be discussed below and added to the matrices so that 
\begin_inset Formula $\mathbf{H}$
\end_inset

 will be 15
\begin_inset Formula $\times$
\end_inset

7 and 
\begin_inset Formula $\mathbf{R}$
\end_inset

 will be 7
\begin_inset Formula $\times$
\end_inset

7.
\begin_inset Foot
status open

\begin_layout Plain Layout
Three additional measurements were explored for inclusion, the three measurement
s of acceleration determined by differentiating the measurements of velocity
 components from the GPS receiver.
 These complicate the tuning and did not appear useful, so they will not
 be discussed in this technical note.
 Their inclusion in the solution appears to be redundant.
\end_layout

\end_inset

 
\end_layout

\begin_layout Enumerate
Define 
\series bold

\begin_inset Formula $\delta\mathbf{z}$
\end_inset

 
\series default
as the set of six measurements consisting of the differences between 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

INS-provided 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!used in Kalman filter
\end_layout

\end_inset

position and velocity.
 Because the GPS antenna
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS!antenna location
\end_layout

\end_inset

 on the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
aircraft!NSF/NCAR GV
\end_layout

\end_inset

GV is located 
\begin_inset Formula $L_{G}=4.3$
\end_inset


\begin_inset space ~
\end_inset

m behind the INS, a small correction is made to the velocity differences
 to account for the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
correction!for aircraft rotation
\end_layout

\end_inset

rotation rate of the aircraft:
\begin_inset Index idx
status open

\begin_layout Plain Layout
rotation rate of aircraft
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!correction for GPS location
\end_layout

\end_inset


\begin_inset Newline newline
\end_inset


\begin_inset Formula 
\[
\delta z_{4}=v_{e}-v_{e}^{(G)}-L_{g}\dot{\psi}\cos\psi
\]

\end_inset


\begin_inset Formula 
\begin{equation}
\delta z_{5}=v_{n}-v_{n}^{(G)}+L_{G}\dot{\psi}\sin\psi\label{eq:GPScorrection}
\end{equation}

\end_inset


\begin_inset Formula 
\[
\delta z_{6}=v_{u}-v_{u}^{(G)}-L_{G}\dot{\theta}\cos\phi
\]

\end_inset

where {
\begin_inset Formula $v_{e},\,v_{n},\,v_{u}$
\end_inset

} are the eastward, northward, and upward components of the aircraft 
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft
\end_layout

\end_inset

velocity as 
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!correction to
\end_layout

\end_inset

measured by the INS, the same symbols with superscript (G) are the corresponding
 measurements from the GPS
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

 receiver, 
\begin_inset Formula $\psi$
\end_inset

 is the heading, 
\begin_inset Formula $\phi$
\end_inset

 the roll angle, and 
\begin_inset Formula $\dot{\psi}$
\end_inset

 and 
\begin_inset Formula $\dot{\theta}$
\end_inset

 are the respective time 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector!derivative
\end_layout

\end_inset

derivatives of the heading and pitch angles.
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle
\end_layout

\end_inset

 Similar corrections are made to the horizontal position differences.
 The error-state vector
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-state vector
\end_layout

\end_inset

 is then further updated as follows:
\begin_inset Newline newline
\end_inset


\begin_inset Formula 
\begin{equation}
\delta\mathbf{x}_{k}\leftarrow\delta\mathbf{x}_{k}+\mathbf{K\{\delta}\mathbf{z}-\mathbf{H}\delta\mathbf{x}\}\label{eq:post-update-sv}
\end{equation}

\end_inset


\end_layout

\begin_layout Enumerate
Finally, the covariance matrix
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!covariance
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!covariance
\end_layout

\end_inset

 is updated further according to
\begin_inset Newline newline
\end_inset


\begin_inset Formula 
\begin{equation}
\mathbf{V}\leftarrow\mathbf{V}-\mathbf{K}\thinspace\mathbf{H}\thinspace\mathbf{V}\label{eq:post-cv-update}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
To apply these equations, it is not necessary to use a high-rate data 
\begin_inset Index idx
status open

\begin_layout Plain Layout
file!data
\end_layout

\end_inset

file and update at high rate because it is expected that the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
smoothing
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
error!smoothing
\end_layout

\end_inset

errors vary slowly.
 However, turns and other maneuvers can introduce spurious effects if time
 delays are not adjusted well.
 For these reasons, a 1-Hz data file will be used for the following example,
 and the measurements of components of the velocity and of the attitude
 angles
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle!lag
\end_layout

\end_inset

 as well as the rotation rates and accelerations
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset

  will be shifted in time where needed and then smoothed before applying
 the Kalman filter.
 DEEPWAVE
\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset

 flight 16 (4 July 2014) was selected, and the measurements were filtered
 with 11-s smoothing of accelerations
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!smoothing
\end_layout

\end_inset

 and 301-s smoothing of measured velocity components and attitude angles.
 A 5
\begin_inset space ~
\end_inset

s update interval was used for the example that follows.
\end_layout

\begin_layout Standard
The file 
\begin_inset Quotes eld
\end_inset

KalmanFilterTechNote.Rnw
\begin_inset Quotes erd
\end_inset

 loads R 
\begin_inset Quotes eld
\end_inset

chunks
\begin_inset Quotes erd
\end_inset

 from a directory named 
\begin_inset Quotes eld
\end_inset

chunks
\begin_inset Quotes erd
\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!program chunks
\end_layout

\end_inset

 when it runs, so this directory is archived along with the file.
\begin_inset Index idx
status open

\begin_layout Plain Layout
archive!for this document
\end_layout

\end_inset

 The reason is that a separate R 
\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!interactive processing script
\end_layout

\end_inset

script
\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!interactive processing script
\end_layout

\end_inset

 designed to support interactive runs, with specification of the archive
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
file!data
\end_layout

\end_inset

file
\begin_inset Index idx
status open

\begin_layout Plain Layout
data!standard archive
\end_layout

\end_inset

 to be used and with options to change time shifts and calibrations but
 which omits generation of the text and plots in this technical note, can
 use those same chunks.
 That script is called 
\begin_inset Quotes eld
\end_inset

KalmanFilter.R
\begin_inset Quotes erd
\end_inset

, and the workflow 
\begin_inset Index idx
status open

\begin_layout Plain Layout
workflow document
\end_layout

\end_inset

document includes detailed instructions
\begin_inset Index idx
status open

\begin_layout Plain Layout
instructions!R script
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!interactive processing script!instructions
\end_layout

\end_inset

 for its use.
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
As a check on the uncertainty associated with the accelerometers, the GPS
 measurements of velocity components were differentiated and the resulting
 accelerations transformed to the 
\emph on
a-
\emph default
frame and compared to the measured accelerations from the IRU (with correction
 for the Earth's rotation and the motion of the 
\emph on
l-
\emph default
frame relative to an inertial frame).
 For the longitudinal acceleration (along the aircraft axis), the linear
 regression of the measured acceleration vs the GPS-based acceleration had
 offset 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(coef(fa1)[1], 4)}
\end_layout

\end_inset

 and slope 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(coef(fa1)[2], 4)}
\end_layout

\end_inset

., with a residual standard error of 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(summary(fa1)$sigma, 4)}
\end_layout

\end_inset


\begin_inset space \thinspace{}
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

.
 For the normal component of acceleration, the corresponding values are
 respectively 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(coef(fa3)[1], 4)}
\end_layout

\end_inset

, 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(coef(fa3)[2], 4)}
\end_layout

\end_inset

., and 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(summary(fa3)$sigma, 4)}
\end_layout

\end_inset


\begin_inset space \thinspace{}
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

.
 These then can be considered calibrations for the accelerometers as well
 as indications of their uncertainty.
 
\begin_inset Foot
status open

\begin_layout Plain Layout
The lateral accelerations were too noisy for a similar calibration because
 lateral accelerations are usually small and short-term except during periods
 with significant slip, which were not present on this flight.
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
The differentiated measurements of velocity components from the GPS can
 be considered as additional measurements corresponding to the measured
 accelerations.
 This is discussed further in the following sections.
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Detecting the error in heading
\begin_inset CommandInset label
LatexCommand label
name "subsec:heading-error"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!error
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
heading
\end_layout

\end_inset

Most of the components of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

state vector have good feedback from 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based measurements, but an exception is the measurement of heading.
 For position and velocity, there is direct correspondence between INS-provided
 and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from INS
\end_layout

\end_inset

GPS-based measurements.
 For pitch and roll, there is strong coupling
\begin_inset Index idx
status open

\begin_layout Plain Layout
coupling!strong
\end_layout

\end_inset

 to 
\begin_inset Index idx
status open

\begin_layout Plain Layout
strong coupling|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

coupling, strong
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

errors in the eastward and northward components of aircraft velocity.
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft
\end_layout

\end_inset

 However, the coupling of INS-provided heading
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!weak coupling
\end_layout

\end_inset

 to GPS-based measurements is not a case of strong coupling (to which the
 Schuler oscillation
\begin_inset Index idx
status open

\begin_layout Plain Layout
Schuler oscillation
\end_layout

\end_inset

 applies), and it is less effective to update via measurements from the
 GPS receiver.
 To improve the constraint on heading, another approach was tried that estimates
 a the error in heading by using derivatives of the measurements provided
 by the GPS receiver.
 The basis for this approach is related to that discussed in Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:CorrectHeading"

\end_inset

, in particular via (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:estimator-equation"

\end_inset

) which estimates the error in 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!error!estimate from acceleration
\end_layout

\end_inset

heading by comparing the directions of the two accelerations that arise
 in the first case from 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transforming the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial reference unit
\end_layout

\end_inset

IRU-measured accelerations to the 
\emph on
l-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 and in the second by differentiating the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based components of the aircraft velocity.
 The latter direction then provides a 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!error!reference
\end_layout

\end_inset

reference toward which the former can be updated.
 Unfortunately, the measured accelerations
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset

  are too noisy for this to be effective except during turns, so updating
 to this reference value must consider the variance in the estimated error.
 
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
As specified above, the differentiated GPS velocities provide an 
\emph on
l-
\emph default
frame measurement of acceleration, and these can be transformed back to
 the 
\emph on
a-
\emph default
frame to provide measurements that correspond to BLATA, BLONGA, and BNORMA.
 However, a difference in 
\emph on
a-
\emph default
frame accelerations from the two sources can arise not only from errors
 in the measured accelerations but also (and more likely) from an error
 in heading, which would cause incorrect translation between 
\emph on
l-
\emph default
frame and 
\emph on
a-
\emph default
frame components.
 The source of coupling between GPS-derived measurements and heading is
 via the aircraft-velocity components, because an error in heading causes
 the IRU-measured accelerations to be resolved into the 
\emph on
l-
\emph default
frame incorrectly and so introduces errors in the aircraft-velocity components
 that can be detected via comparison to GPS-based velocity components.
\end_layout

\end_inset

 Most of the evidence from flights that have been examined suggests that
 the heading
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!error
\end_layout

\end_inset

 error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!comparison of INSs
\end_layout

\end_inset

 is small and changes little during the flight.
 (The evidence comes primarily from comparisons
\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!independent INS units
\end_layout

\end_inset

 among independent inertial navigation
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

 systems, as discussed in 
\begin_inset CommandInset citation
LatexCommand citet
key "Cooper2016ncartn"

\end_inset

.) However, the Kalman filter often leads to estimates of heading error that
 are 0.2
\begin_inset Formula $^{\circ}$
\end_inset

 or more, accompanied by large variances that indicate substantial 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!correction!uncertainty
\end_layout

\end_inset

uncertainty in the estimates.
 The heading error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!need for turns
\end_layout

\end_inset

 is constrained well only during turns, when there are significant horizontal
 accelerations.
 With strong accelerations, the direction of the acceleration is determined
 well and can be used as an additional error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!additional constraint
\end_layout

\end_inset

 term in the Kalman filter.
 Although inclusion of this term is redundant in theory because the filter
 already determines optimal corrections to minimize the measurement errors,
 specific inclusion of this term did lead to apparent improvement in performance
, particularly the reduction of noise in the estimated heading error and
 smaller excursions from the mean correction.
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
There are three possible approaches, all of which have been tried in this
 study:
\end_layout

\begin_layout Enumerate
The Kalman-filter structure as described above will use the errors in velocity
 to correct the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

state vector.
 Via the derivative coefficient matrix, the horizontal-velocity errors are
 dependent on errors in horizontal-acceleration as well as on attitude-angle
 errors, esp.
\begin_inset space ~
\end_inset

via strong coupling to the errors in roll and pitch.
 The coupling to heading is typically an order of magnitude weaker.
 Without special attention, the coupling to heading potentially can be obscured
 by the other sensitivities, through which the errors in velocity can be
 attributed to error-state components in horizontal acceleration and in
 roll and pitch.
 In turn, an error in heading is dependent mostly on errors in the gyro
 rotation rates.
 These sensitivities make it difficult to obtain a reliable adjustment of
 heading in the standard approach, although an estimate can be obtained.
\end_layout

\begin_layout Enumerate
The 
\emph on
l-
\emph default
frame accelerations measured by differentiating the GPS-derived horizontal
 velocity components can be used as additional components of the observation
 vector, complementing the position and velocity measurements from GPS.
 These accelerations can then be used as independent measurements of acceleratio
n.
 While this provides some additional adjustable parameters for the filter
 associated with the covariances of the GPS-derived accelerations, the errors
 in acceleration can still be attributed to errors in the measured accelerations.
 This seems to add little to the sensitivity, and indeed in tests this led
 to changes in pitch and roll corrections that appeared to produce degraded
 results.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
To illustrate the problem, consider the measured horizontal-acceleration
 vector obtained by transforming the measured 
\emph on
a-
\emph default
frame accelerations to the 
\emph on
l-
\emph default
frame.
 If there is no heading error, the azimuth angle corresponding to this 
\emph on
l-
\emph default
frame vector acceleration should be the same as the azimuth angle of the
 vector acceleration determined by differentiating the GPS-measured components
 of horizontal velocity.
 The difference is a measure of the heading error: 
\begin_inset Newline newline
\end_inset


\begin_inset Formula 
\begin{equation}
\delta\psi=\arctan\left(\frac{a_{e}^{(l)}}{a_{n}^{(l)}}\right)-\arctan\left(\frac{\dot{v}_{e}}{\dot{v}_{n}}\right)\label{eq:Hcorr}
\end{equation}

\end_inset

where 
\begin_inset Formula $a_{e}^{(l)}$
\end_inset

 and 
\begin_inset Formula $a_{n}^{(l)}$
\end_inset

 are the 
\emph on
l-
\emph default
frame accelerations obtained by transforming the IRU-measured accelerations
 from the 
\emph on
a-
\emph default
frame to the 
\emph on
l-
\emph default
frame and 
\begin_inset Formula $\dot{v}_{e}$
\end_inset

 and 
\begin_inset Formula $\dot{v}_{n}$
\end_inset

 are the eastward and northward components of the acceleration obtained
 from the time-derivatives of the GPS-measured eastward and northward velocity
 components 
\begin_inset Formula $v_{e}$
\end_inset

 and 
\begin_inset Formula $v_{n}$
\end_inset

.
 The assumption made when using this formula is that the errors in the INS-produ
ced accelerations in the 
\emph on
l-
\emph default
frame arise from the heading error with negligible contribution from errors
 in the accelerometers themselves.
 If this is the case, it would be possible to base the heading correction
 on this formula alone, but the more general case needs to consider how
 this might be influenced by errors in accelerations.
 Appropriately incorporating this measurement of heading error into the
 Kalman filter would allow for the possibility that measured accelerations
 as well as the heading need to be adjusted.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Because significant horizontal accelerations
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!lag
\end_layout

\end_inset

 occur mostly in turns when the heading angle is changing rapidly, it is
 very important to have correct relative timing
\begin_inset Index idx
status open

\begin_layout Plain Layout
time lag
\end_layout

\end_inset

 between the INS-provided measurement
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!time lag
\end_layout

\end_inset

 of heading and the GPS-based
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

 measurement of velocity.
\begin_inset Foot
status open

\begin_layout Plain Layout
As an illustration, a 50-ms delay
\begin_inset Index idx
status open

\begin_layout Plain Layout
time lag
\end_layout

\end_inset

 in heading during a 3-min turn causes a shift in heading relative to the
 correct time of 0.1
\begin_inset Formula $^{\circ}$
\end_inset

, so adjustment to at least this uncertainty is desirable.
 
\end_layout

\end_inset

 The GPS measurements
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS
\end_layout

\end_inset

 are assigned correct times by the GPS receiver and so provide a standard
 clock against which to compare other measurements.
\begin_inset Foot
status open

\begin_layout Plain Layout
It appears that the relative timing between the IRU and the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS receiver can change enough during some flights to introduce additional
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!timing
\end_layout

\end_inset

errors that are sometimes detectable.
 This warrants further study.
\end_layout

\end_inset

 If the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-vs-INS time shift
\begin_inset Index idx
status open

\begin_layout Plain Layout
time lag!GPS vs.
 INS
\end_layout

\end_inset

 is not removed, a bias will be introduced into the heading correction that
 varies with turn direction.
 Therefore the following procedure was followed to remove this time shift:
\end_layout

\begin_layout Enumerate
Differentiate
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!differentiated
\end_layout

\end_inset

 the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS
\end_layout

\end_inset

measurements to obtain 
\begin_inset Formula $\dot{v}_{e}$
\end_inset

 and 
\begin_inset Formula $\dot{v}_{n}$
\end_inset

.
\end_layout

\begin_layout Enumerate
Transform
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

 the unshifted body accelerations
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset

  to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\emph on
l-
\emph default
frame, with rotation-rate 
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial corrections
\end_layout

\end_inset

corrections, to obtain the eastward and northward components of acceleration
 (
\begin_inset Formula $a_{e}^{(l)}$
\end_inset

, 
\begin_inset Formula $a_{n}^{(l)}$
\end_inset

) in the local-level frame (
\emph on
l-
\emph default
frame).
 
\end_layout

\begin_layout Enumerate
Find the heading
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!correction
\end_layout

\end_inset

 correction for unshifted measurements by calculating 
\begin_inset Formula $\delta\psi$
\end_inset

 from (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:estimator-equation"

\end_inset

).
\end_layout

\begin_layout Enumerate
Calculate the running-standard 
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!heading error
\end_layout

\end_inset

deviation of 
\begin_inset Formula $\delta\psi$
\end_inset

 spanning 30 seconds.
 Select the subset of 
\begin_inset Formula $\delta\psi$
\end_inset

 for which that standard deviation is less than 0.2
\begin_inset Formula $^{\circ}$
\end_inset

.
\end_layout

\begin_layout Enumerate
Fit
\begin_inset Index idx
status open

\begin_layout Plain Layout
fit!time shift
\end_layout

\end_inset

 the subset to find the slope 
\begin_inset Formula $b$
\end_inset

 in the relationship 
\begin_inset Formula $\delta\psi=a+b\thinspace\tan\phi$
\end_inset

 where 
\begin_inset Formula $\phi$
\end_inset

 is the roll angle.
 The rate of turn 
\begin_inset Formula $R$
\end_inset

 is related to the roll angle 
\begin_inset Formula $\phi$
\end_inset

 according to the relationship 
\begin_inset Formula $R=g\thinspace\tan\phi/V$
\end_inset

 where 
\begin_inset Formula $V$
\end_inset

 is the airspeed
\begin_inset Index idx
status open

\begin_layout Plain Layout
airspeed
\end_layout

\end_inset

, so 
\begin_inset Formula $\tan\phi=RV/g$
\end_inset

 and 
\begin_inset Formula $\delta\psi=a+bRV/g$
\end_inset

.
 A time delay
\begin_inset Index idx
status open

\begin_layout Plain Layout
time lag
\end_layout

\end_inset

 of 
\begin_inset Formula $\delta t$
\end_inset

 produces a heading 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!effect of lag
\end_layout

\end_inset

error of 
\begin_inset Formula $-R\delta t$
\end_inset

, so 
\begin_inset Formula $-R\delta t=a+bRV/g$
\end_inset

 and the time shift can be estimated from
\begin_inset Newline newline
\end_inset


\begin_inset Formula 
\begin{equation}
\delta t=-b\frac{V}{g}\,\,\,\,.\label{eq:deltaT}
\end{equation}

\end_inset

For example, for DEEPWAVE
\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset

 flight 16, 
\begin_inset Formula $b=0.2146^{\circ}$
\end_inset

s
\begin_inset Formula $^{-1}$
\end_inset

 = 0.003745
\begin_inset space \thinspace{}
\end_inset

rad
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-1}$
\end_inset

 and 
\begin_inset Formula $V\simeq240$
\end_inset


\begin_inset space \thinspace{}
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-1}$
\end_inset

, so (with g=9.8
\begin_inset space \thinspace{}
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

) 
\begin_inset Formula $\delta t=$
\end_inset

-0.092
\begin_inset space ~
\end_inset

s.
 The negative sign indicates that the INS-provided measurement of heading
 appears to be shifted backward (earlier) in time by 92
\begin_inset space \thinspace{}
\end_inset

ms relative to the GPS-based 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

measurements of aircraft velocity.
\begin_inset Index idx
status open

\begin_layout Plain Layout
time lag!GPS vs.
 INS
\end_layout

\end_inset

 The standard error from the fit indicates that this shift was determined
 with an uncertainty of about 3
\begin_inset space \thinspace{}
\end_inset

ms, so this is a very sensitive way to determine the time shift.
 Note that the result is not influenced by a real error in heading.
\end_layout

\begin_layout Enumerate
Apply this time shift to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!time lag
\end_layout

\end_inset

measurements of ground speed from the GPS (
\begin_inset Index var
status open

\begin_layout Plain Layout
GGVEW: ground speed eastward, GPS
\end_layout

\end_inset

GGVEW and 
\begin_inset Index var
status open

\begin_layout Plain Layout
GGVNS: ground speed northward, GPS
\end_layout

\end_inset

GGVNS), in this case shifting them backward (earlier) in time by 92
\begin_inset space ~
\end_inset

ms while leaving the heading unshifted.
\begin_inset Foot
status open

\begin_layout Plain Layout
The reason that it is preferable to shift GGVEW and GGVNS rather than THDG
 is that it is common in data archive for heading to already be shifted.
 In the case discussed here, heading was already shifted by 
\begin_inset Formula $-80$
\end_inset


\begin_inset space ~
\end_inset

ms.
 However, this was done after processing by the INS, so 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!time lag
\end_layout

\end_inset

measurements like VEW and VNS have been determined with the heading as used
 internally by the INS, not as shifted during subsequent processing.
 The feedback provided by the Kalman filter then relies on the heading before
 shifting, and subsequent shifting of the heading has no effect on those
 measurements.
 It does affect the recalculated transformation from 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset


\emph on
a-
\emph default
frame to 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\emph on
l-
\emph default
frame, so there would be an inconsistency between (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:estimator-equation"

\end_inset

) and other estimates of the heading error arising from the Kalman filter.
\end_layout

\end_inset

 For a data 
\begin_inset Index idx
status open

\begin_layout Plain Layout
file!data
\end_layout

\end_inset

file containing 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!time lag
\end_layout

\end_inset

measurements at 1
\begin_inset space ~
\end_inset

Hz, this requires creating an interpolated
\begin_inset Index idx
status open

\begin_layout Plain Layout
interpolation!for time shift
\end_layout

\end_inset

 high-rate vector of measurements, shifting that vector, and then extracting
 a shifted 1-Hz vector from the shifted measurements.
 The Ranadu 
\begin_inset Index idx
status open

\begin_layout Plain Layout
function!ShiftInTime
\end_layout

\end_inset

function ShiftInTime() accomplishes this by interpolating to a 125-Hz variable.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
The result can be tested by repeating step 5 using the shifted measurements;
 for this case, the deduced shift after previously shifting was only 1
\begin_inset space ~
\end_inset

ms.
 
\end_layout

\end_inset


\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
It may be useful to incorporate in addition a time dependence, either to
 the time shift or to the correction factor.
 Preliminary study of this indicates that a time dependence is significant,
 as represented for example via he~tan(ROLL)+Ts where Ts=as.vector(Data$Time-Data
$Time[1]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
After an appropriate time shift is introduced, (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:estimator-equation"

\end_inset

) is an appropriate measurement of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!estimated error
\end_layout

\end_inset

heading 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!estimate
\end_layout

\end_inset

error to include in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-measurement vector
\end_layout

\end_inset

error-measurement vector 
\begin_inset Formula $\delta\mathbf{z}$
\end_inset

.
 Here, that is accomplished by adding a seventh component to the measurement
 vector and a seventh row to the observation 
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!observation!added row
\end_layout

\end_inset

matrix 
\begin_inset Formula $\mathbf{H}$
\end_inset

, where a matrix element 1 then appears in row 7, column 9, to associate
 this measurement with the heading angle.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
Because typical horizontal accelerations in the 
\emph on
l-
\emph default
frame are small, this estimate of the heading error is too noisy to be useful
 except in turns where the horizontal accelerations are significant, often
 about 3
\begin_inset space ~
\end_inset

m/s
\begin_inset Formula $^{2}$
\end_inset

.
\end_layout

\end_inset

 In normal straight flight, the standard deviation
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!heading error
\end_layout

\end_inset

 in the estimate obtained from (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:estimator-equation"

\end_inset

) is around 15
\begin_inset Formula $^{\circ}$
\end_inset

, but in turns this standard deviation reduces to typically about 0.15
\begin_inset Formula $^{\circ}$
\end_inset

.
 This has two important consequences.
 First, flights without turns or other sources of horizontal acceleration
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!horizontal!required magnitude
\end_layout

\end_inset

 will lack the information for adjusting the heading.
 so in flights where good wind measurements
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!measurement!recommendation
\end_layout

\end_inset

 are important regular turns
\begin_inset Index idx
status open

\begin_layout Plain Layout
flight path!recommendation
\end_layout

\end_inset

 should be part of the flight plans.
 Second, when the GPS-based estimate of the heading error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading
\end_layout

\end_inset

 is used, an appropriate variance should be assigned to prevent excessive
 noise from affecting the result from the Kalman filter.
 It appears best to suppress updating to the GPS result entirely for this
 seventh term except when horizontal accelerations are significant (more
 than 1
\begin_inset space \thinspace{}
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

, which is common only in turns where accelerations are often about 3
\begin_inset space ~
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

), and the case to be shown used this suppression of updating.
 Then the running variance in the estimate of heading error can be used
 as the appropriate factor to include in the noise 
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!noise!expansion of
\end_layout

\end_inset

matrix 
\begin_inset Formula $\mathbf{R}$
\end_inset

\SpecialChar endofsentence
 For the flight being used as an example, the mean and standard 
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!heading error
\end_layout

\end_inset

deviation of the correction from (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:estimator-equation"

\end_inset

) for all cases where the horizontal accelerations exceed this criterion
 are 0.003
\begin_inset Formula $\pm0.15{}^{\circ}$
\end_inset

 for 4295 1-Hz measurements, and the mean error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!mean
\end_layout

\end_inset

 is determined to a standard 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!correction!uncertainty
\end_layout

\end_inset

uncertainty of about 0.002
\begin_inset Formula $^{\circ}$
\end_inset

.
\end_layout

\begin_layout Subsection
Smoothing the errors in pitch and roll
\begin_inset CommandInset label
LatexCommand label
name "subsec:Smoothing-the-errors"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
smoothing
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
error!smoothing
\end_layout

\end_inset

Because the errors in pitch and roll are strongly coupled
\begin_inset Index idx
status open

\begin_layout Plain Layout
coupling!strong
\end_layout

\end_inset

 to the errors in velocity, good estimates of these errors should arise
 naturally from the Kalman 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter
\end_layout

\end_inset

filter.
 However, the estimated 
\begin_inset Index idx
status open

\begin_layout Plain Layout
pitch!error!smoothing
\end_layout

\end_inset

errors so obtained are noisy in comparison to the direct measurements, so
 application of those corrections will introduce undesirable noise
\begin_inset Index idx
status open

\begin_layout Plain Layout
noise!from Kalman filter!reducing
\end_layout

\end_inset

 into the results from the filter.
 Variations in the errors in velocity indicate that the main source of error
 in pitch is expected to be the slowly varying Schuler oscillation
\begin_inset Index idx
status open

\begin_layout Plain Layout
Schuler oscillation
\end_layout

\end_inset

, so it is preferable to smooth the corrections before applying them to
 the original measurements to avoid the introduction of noise.
 As described above, the errors in pitch and roll are those that apply to
 the original measurements in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset


\emph on
a-
\emph default
frame.
 However, if a major source of those errors is platform misalignment that
 varies slowly, the errors will vary smoothly in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\emph on
l-
\emph default
frame, where 
\emph on
l-
\emph default
frame pitch error refers to platform
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial platform!misalignment
\end_layout

\end_inset

 north-south tilt and 
\emph on
l-
\emph default
frame roll error refers to platform east-west tilt.
 In the 
\emph on
a-
\emph default
frame, each turn leads to mixing of the pitch and roll errors and to abrupt
 changes, so smoothing
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!smoothing!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 in the 
\emph on
l-
\emph default
frame followed by 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transformation back to the 
\emph on
a-
\emph default
frame produces a better result.
 This will be discussed further after the results from the Kalman filter
 are presented.
\begin_inset Foot
status open

\begin_layout Plain Layout
An alternative that would likely be preferable would be to use the 
\emph on
l-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 errors in pitch and roll in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
state vector
\end_layout

\end_inset

state vector.
 This has not been done in this document and the associated code, but might
 be worth explorating in the future because it should produce smoother variation
s in the corrections.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
, but this will not be part of this initial study because the accelerometers
 appear to have low uncertainty and because the effect of errors in acceleration
 would also appear as errors in velocity and so should be detected by the
 conventional 6-component measurement vector for Kalman filtering.
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

<<plot-filtered, include=FALSE, echo=FALSE, fig.cap=' ', eval=FALSE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

op <- par (mar=c(2,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout

layout(matrix(1:3, ncol = 1), widths = 1,  heights = c(5,5,6))
\end_layout

\begin_layout Plain Layout

plotWAC (subset(D1,, c(Time, VEW, VEWF)))
\end_layout

\begin_layout Plain Layout

plotWAC (subset(D1,, c(Time, VNS, VNSF)))
\end_layout

\begin_layout Plain Layout

op <- par (mar=c(5,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout

plotWAC (subset(D1,, c(Time, VSPD, VSPDF)))
\end_layout

\begin_layout Plain Layout

op <- par (mar=c(2,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout

plotWAC (subset(D1,, c(Time, GGVEW, GGVEWF)))
\end_layout

\begin_layout Plain Layout

plotWAC (subset(D1,, c(Time, GGVNS, GGVNSF)))
\end_layout

\begin_layout Plain Layout

op <- par (mar=c(5,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout

plotWAC (subset(D1,, c(Time, GGVSPD, GGVSPDF)))
\end_layout

\begin_layout Plain Layout

op <- par (mfrow=c(1,1), mar=c(5,5,2,2)+0.1)  # reset
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<Kalman-setup, include=TRUE, cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## the chunk is 'sourced' here so the same code can be used in KalmanFilter.R
\end_layout

\begin_layout Plain Layout

# source ('chunks/Kalman-setup.R')
\end_layout

\begin_layout Plain Layout

## Kalman-setup
\end_layout

\begin_layout Plain Layout

## initialize matrices needed by the Kalman filter and load the starting-point
\end_layout

\begin_layout Plain Layout

## for the error-state vector.
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

NSTEP <- 30      ## update time
\end_layout

\begin_layout Plain Layout

# r <- setRange(D1, 110000, 120000)
\end_layout

\begin_layout Plain Layout

# D1 <- D1[r, ]
\end_layout

\begin_layout Plain Layout

DL <- nrow (D1)
\end_layout

\begin_layout Plain Layout

DLL <- DL - DL %% NSTEP
\end_layout

\begin_layout Plain Layout

if (DLL != DL) {
\end_layout

\begin_layout Plain Layout

  D1 <- D1[1:DLL, ]
\end_layout

\begin_layout Plain Layout

  DL <- DLL
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

## initial values of the state vector and error-state vector:
\end_layout

\begin_layout Plain Layout

SV <- with(D1[1, ], data.frame(LAT, LON, ZROC, VEW, VNS, ROC, PITCH, ROLL,
 THDG,
\end_layout

\begin_layout Plain Layout

                               BPITCHR, BROLLR, BYAWR, BLATA, BLONGA, BNORMA))
\end_layout

\begin_layout Plain Layout

SV[c(1,2,7:12)] <- SV[c(1,2,7:12)] * Cradeg
\end_layout

\begin_layout Plain Layout

## also need the corresponding noise vector:
\end_layout

\begin_layout Plain Layout

tau <- 60
\end_layout

\begin_layout Plain Layout

GCF <- function (sv, sp) {    ## sv is the state vector; sp is the data
 record
\end_layout

\begin_layout Plain Layout

  gcf <- vector('numeric', length=15)
\end_layout

\begin_layout Plain Layout

  ## For lat and lon, noise evidence indicates 1 m, but when that is used
\end_layout

\begin_layout Plain Layout

  ## there are numerical problems in the 'solve' call because of the large
 range
\end_layout

\begin_layout Plain Layout

  ## in values in the matrix.
 Forcing these 10 times larger avoids that problem.
\end_layout

\begin_layout Plain Layout

  gcf[1] <- 10 / sp$Rm
\end_layout

\begin_layout Plain Layout

  gcf[2] <- 10 / (sp$Rn * cos (sv$LAT))
\end_layout

\begin_layout Plain Layout

  gcf[3] <- 10
\end_layout

\begin_layout Plain Layout

  gcf[4:5] <- 0.02    ## 0.3
\end_layout

\begin_layout Plain Layout

  gcf[6] <- 0.05
\end_layout

\begin_layout Plain Layout

  gcf[7:8] <- 0.02*Cradeg  ## 0.005
\end_layout

\begin_layout Plain Layout

  gcf[9] <- 0.02*Cradeg    ## 0.015
\end_layout

\begin_layout Plain Layout

  gcf[10:11] <- 0.003*Cradeg    ## 0.015
\end_layout

\begin_layout Plain Layout

  gcf[12] <- 0.003*Cradeg       ## 0.015
\end_layout

\begin_layout Plain Layout

  gcf[13:15] <- 0.00005 # see text re why this is so small
\end_layout

\begin_layout Plain Layout

  # gcf <- as.vector(gcf) * sqrt(2/tau)
\end_layout

\begin_layout Plain Layout

  return (gcf)
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

gcf <- as.numeric (GCF (SV, D1[1, ]))
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## The measurement model: 
\end_layout

\begin_layout Plain Layout

##      Calculate the measurements of acceleration from the GPS to add to
 the measurement vector.
\end_layout

\begin_layout Plain Layout

##      This was explored but not used in the version that produced the
 the Tech Note
\end_layout

\begin_layout Plain Layout

GAEL <- c(D1$LACCX - D1$vedot, D1$LACCY - D1$vndot, D1$LACCZ - D1$vudot)
\end_layout

\begin_layout Plain Layout

DL <- nrow(D1)
\end_layout

\begin_layout Plain Layout

dim(GAEL) <- c(DL, 3)
\end_layout

\begin_layout Plain Layout

## transform to the a-frame
\end_layout

\begin_layout Plain Layout

GAE <- XformLA (D1, GAEL, .inverse=TRUE)
\end_layout

\begin_layout Plain Layout

## get rotation-rate corrections to apply to GPS measurements
\end_layout

\begin_layout Plain Layout

LR <- 4.42; LG <- -4.30
\end_layout

\begin_layout Plain Layout

Pdot <- c(0, diff (D1$PITCH*Cradeg)) * Rate  # diff does step-wise differentiati
on
\end_layout

\begin_layout Plain Layout

Hdot <- c(0, diff (D1$THDG*Cradeg))          # see Rate multiplication few
 lines down
\end_layout

\begin_layout Plain Layout

Hdot[is.na(Hdot)] <- 0
\end_layout

\begin_layout Plain Layout

Hdot[Hdot > pi] <- Hdot[Hdot > pi] - 2*pi
\end_layout

\begin_layout Plain Layout

Hdot[Hdot < -pi] <- Hdot[Hdot < -pi] + 2*pi
\end_layout

\begin_layout Plain Layout

Hdot <- Hdot * Rate
\end_layout

\begin_layout Plain Layout

cospsi <- cos (D1$THDG*Cradeg)
\end_layout

\begin_layout Plain Layout

sinpsi <- sin (D1$THDG*Cradeg)
\end_layout

\begin_layout Plain Layout

cosphi <- cos (D1$ROLL*Cradeg)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## note that LG is negative:
\end_layout

\begin_layout Plain Layout

DZ <- with(D1, c(Cradeg*(LAT-GGLAT)-LG*cospsi/Rm, Cradeg*(LON-GGLON)-LG*sinpsi/R
n, 
\end_layout

\begin_layout Plain Layout

                 ZROC-GGALT, VEW-GGVEW + LG*Hdot*cospsi, 
\end_layout

\begin_layout Plain Layout

                 VNS-GGVNS - LG*Hdot*sinpsi, ROC-D1[, VROC] + LG*Pdot*cosphi))
\end_layout

\begin_layout Plain Layout

# DZ <- c(DZ, GAE[,1], GAE[,2], GAE[,3]) ## add this later?
\end_layout

\begin_layout Plain Layout

## The last three components provide direct feedback to measured acceleration
\end_layout

\begin_layout Plain Layout

## in the a-frame but also provide feedback to heading, as developed below
\end_layout

\begin_layout Plain Layout

# dim(DZ) <- c(DL, 9)
\end_layout

\begin_layout Plain Layout

# dim(DZ) <- c(DL, 6)
\end_layout

\begin_layout Plain Layout

# DZ[,1:2] <- DZ[, 1:2] * Cradeg
\end_layout

\begin_layout Plain Layout

## now add the pseudo-measurement of heading error found from the accelerations:
\end_layout

\begin_layout Plain Layout

D1$deltaPsi <- (atan2 (D1$LACCX, D1$LACCY) - atan2 (D1$vedot, D1$vndot))
\end_layout

\begin_layout Plain Layout

## alternate based on (12):
\end_layout

\begin_layout Plain Layout

D1$deltaPsi <- (D1$LACCX*(D1$vndot-D1$LACCY)-D1$LACCY*(D1$vedot-D1$LACCX))
 /
\end_layout

\begin_layout Plain Layout

               (D1$LACCX^2+D1$LACCY^2)
\end_layout

\begin_layout Plain Layout

D1$deltaPsi[D1$deltaPsi > pi] <- D1$deltaPsi[D1$deltaPsi > pi] - 2*pi
\end_layout

\begin_layout Plain Layout

D1$deltaPsi[D1$deltaPsi < -pi] <- D1$deltaPsi[D1$deltaPsi < -pi] + 2*pi
\end_layout

\begin_layout Plain Layout

D1$sdPsi <- zoo::rollapply(D1$deltaPsi, 10, sd, fill=NA)  ## calculate the
 std dev
\end_layout

\begin_layout Plain Layout

## add the heading correction to the measurement vector
\end_layout

\begin_layout Plain Layout

DZ <- c(as.vector(DZ), D1$deltaPsi)
\end_layout

\begin_layout Plain Layout

dim(DZ) <- c(DL, 7)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## The observation matrix: (the first six and last three components of the
 state error 
\end_layout

\begin_layout Plain Layout

## vector are observable, the latter requiring transformation from l-frame
 to a-frame)
\end_layout

\begin_layout Plain Layout

## components 7-9 are connected to IRU-measured rotation rates via the transform
ation matrix l->a,
\end_layout

\begin_layout Plain Layout

## so matrix H must vary with aircraft attitude angles.
 This is addressed by the GAEL->GAE transform.
\end_layout

\begin_layout Plain Layout

# H <- diag(1, nrow=10, ncol=15)
\end_layout

\begin_layout Plain Layout

# for (k in 7:9) {
\end_layout

\begin_layout Plain Layout

#   H[k,k] <- 0
\end_layout

\begin_layout Plain Layout

#   H[k,k+6] <- 1
\end_layout

\begin_layout Plain Layout

# }
\end_layout

\begin_layout Plain Layout

# H[10,9] <- 1
\end_layout

\begin_layout Plain Layout

H <- diag(1, nrow=7, ncol=15)
\end_layout

\begin_layout Plain Layout

H[7,7] <- 0
\end_layout

\begin_layout Plain Layout

H[7,9] <- 1  ## measurement 7 applies to the heading error, SVE component
 9
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## at any time step, assume the measurements are contaminated by noise:
\end_layout

\begin_layout Plain Layout

RCV <- matrix (rep(0,100), ncol=10)
\end_layout

\begin_layout Plain Layout

RCV <- matrix (rep(0,49), ncol=7)
\end_layout

\begin_layout Plain Layout

RCV[1,1] <- (1/D1$Rm[1])^2  ## latitude
\end_layout

\begin_layout Plain Layout

RCV[2,2] <- (1/(D1$Rn[1]*cos(SV$LAT)))^2
\end_layout

\begin_layout Plain Layout

RCV[3,3] <- 5^2 #100^2
\end_layout

\begin_layout Plain Layout

RCV[4,4] <- 0.1^2            ## ve
\end_layout

\begin_layout Plain Layout

RCV[5,5] <- 0.1^2
\end_layout

\begin_layout Plain Layout

RCV[6,6] <- 0.1^2
\end_layout

\begin_layout Plain Layout

# RCV[7,7] <- 100.0  # A big value here limits updating of acceleration measureme
nt.
\end_layout

\begin_layout Plain Layout

# RCV[8,8] <- 100.0  # The assumption is that there errors arise from an
 error in heading, not
\end_layout

\begin_layout Plain Layout

# RCV[9,9] <- 100.0  # measured acceleration, so the GPS-measured acceleration
 is used for that.
\end_layout

\begin_layout Plain Layout

# RCV[10,10] <- D1$sdPsi[1]^2
\end_layout

\begin_layout Plain Layout

# if (is.na(D1$sdPsi[1])) {RCV[10,10] <- 225}  # typical sd is 15 deg.
\end_layout

\begin_layout Plain Layout

# # RCV[10, 10] <- 1000  ## suppress effect
\end_layout

\begin_layout Plain Layout

RCV[7,7] <- 1000  ## but update this each time step
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## initialize covariance matrix with generous variances, because Schuler-oscilla
tion
\end_layout

\begin_layout Plain Layout

## errors might be large at the start
\end_layout

\begin_layout Plain Layout

CV <- matrix (rep(0,225), ncol=15)
\end_layout

\begin_layout Plain Layout

CV[1,1] <- 2000^2 / D1$Rm[1]^2
\end_layout

\begin_layout Plain Layout

CV[2,2] <- 2000^2 / (D1$Rn[1]*cos(SV[1]))^2
\end_layout

\begin_layout Plain Layout

CV[3,3] <- 500^2
\end_layout

\begin_layout Plain Layout

CV[4,4] <- 4
\end_layout

\begin_layout Plain Layout

CV[5,5] <- 4
\end_layout

\begin_layout Plain Layout

CV[6,6] <- 4
\end_layout

\begin_layout Plain Layout

CV[7,7] <- (0.3*Cradeg)^2
\end_layout

\begin_layout Plain Layout

CV[8,8] <- CV[7,7]
\end_layout

\begin_layout Plain Layout

CV[9,9] <- (1*Cradeg)^2
\end_layout

\begin_layout Plain Layout

CV[10,10] <- CV[11,11] <- (0.005*Cradeg)^2
\end_layout

\begin_layout Plain Layout

CV[12,12] <- (0.01*Cradeg)^2
\end_layout

\begin_layout Plain Layout

CV[13,13] <- CV[14,14] <- CV[15,15] <- 0.0005^2
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## Q: (initial estimate):
\end_layout

\begin_layout Plain Layout

Q <- diag(gcf^2, 15)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<Kalman-loop, include=TRUE, cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# source ('chunks/Kalman-loop.R')
\end_layout

\begin_layout Plain Layout

## Kalman-loop.R
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

SVEF <- array(dim=c(DL/NSTEP, 15))
\end_layout

\begin_layout Plain Layout

CVEF <- array(dim=c(DL/NSTEP, 15))
\end_layout

\begin_layout Plain Layout

## initialize error state vector
\end_layout

\begin_layout Plain Layout

SVE <- rep (0, 15)  ## respectively: (lat,lon,alt) (vew,vns,vspd),
\end_layout

\begin_layout Plain Layout

## (pitch,roll,thdg) (rot.
 rates) (accel components)
\end_layout

\begin_layout Plain Layout

SVE[1:6] <- DZ[1, 1:6]
\end_layout

\begin_layout Plain Layout

## pitch and roll errors are going to be those in the l-frame
\end_layout

\begin_layout Plain Layout

SVE[7:9] <- 0  ## might initialize using pitch/roll/heading-correction functions
 here
\end_layout

\begin_layout Plain Layout

## start with zero for gyro and accelerometer errors
\end_layout

\begin_layout Plain Layout

SVEF[1, ] <- SVE
\end_layout

\begin_layout Plain Layout

CVEF[1, ] <- diag (CV)
\end_layout

\begin_layout Plain Layout

pctL <- 0
\end_layout

\begin_layout Plain Layout

MH <- 1    ## 0 suppresses use of deltaPsi as error in heading
\end_layout

\begin_layout Plain Layout

for (i in seq(2*NSTEP, DL, by=NSTEP)) {
\end_layout

\begin_layout Plain Layout

  pct <- as.integer(100*i/DL)
\end_layout

\begin_layout Plain Layout

  # if (pct %% 10 == 0 && pct != pctL) {print (sprintf ('pct done is %d',
 pct));pctL <- pct}
\end_layout

\begin_layout Plain Layout

  SV <- with(D1[i, ], data.frame(LAT, LON, ZROC, VEW, VNS, ROC, PITCH, ROLL,
 THDG,
\end_layout

\begin_layout Plain Layout

                                 BPITCHR, BROLLR, BYAWR, BLATA, BLONGA,
 BNORMA))
\end_layout

\begin_layout Plain Layout

  SV[c(1,2,7:12)] <- SV[c(1,2,7:12)] * Cradeg
\end_layout

\begin_layout Plain Layout

  Rn <- D1$Rn[i]
\end_layout

\begin_layout Plain Layout

  Rm <- D1$Rm[i]
\end_layout

\begin_layout Plain Layout

  Grav <- D1$Grav[i]
\end_layout

\begin_layout Plain Layout

  sv <- as.vector (SV, mode='numeric')
\end_layout

\begin_layout Plain Layout

  # stmf <- STMFV (sv)
\end_layout

\begin_layout Plain Layout

  dcm <- jacobian (STMFV, sv) * dt * NSTEP + diag(15)
\end_layout

\begin_layout Plain Layout

  ## modify to include this?
\end_layout

\begin_layout Plain Layout

  ## modify this to include decaying error terms for the measurements:
\end_layout

\begin_layout Plain Layout

  # dcm[10,10] <- dcm[11,11] <- dcm[12,12] <- -1/tau
\end_layout

\begin_layout Plain Layout

  # dcm[13,13] <- dcm[14,14] <- dcm[15,15] <- -1/tau
\end_layout

\begin_layout Plain Layout

  ## predict the new error-state vector:
\end_layout

\begin_layout Plain Layout

  ## the pitch and roll error derivatives are now those in the a-frame,
 but
\end_layout

\begin_layout Plain Layout

  ##   the pitch/roll error state is in the l-frame.
 Save the l-frame error state:
\end_layout

\begin_layout Plain Layout

  #   SVEL <- SVEA <- SVE
\end_layout

\begin_layout Plain Layout

  #   ## Transform l-frame pitch/roll error state to a-frame
\end_layout

\begin_layout Plain Layout

  #   SVEA[7] <- cos(sv[9]) * SVEL[7] + sin(sv[9]) * SVEL[8]
\end_layout

\begin_layout Plain Layout

  #   SVEA[8] <- -sin(sv[9]) * SVEL[7] + cos(sv[9]) * SVEL[8]
\end_layout

\begin_layout Plain Layout

  #   ## apply derivatives to get a-frame change
\end_layout

\begin_layout Plain Layout

  #   SVEA <- dcm %*% SVEA
\end_layout

\begin_layout Plain Layout

  #   ## transform back to l-frame
\end_layout

\begin_layout Plain Layout

  #   SVEL[7] <- cos(sv[9]) * SVEA[7] - sin(sv[9]) * SVEA[8]
\end_layout

\begin_layout Plain Layout

  #   SVEL[8] <- sin(sv[9]) * SVEA[7] + cos(sv[9]) * SVEA[8]
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

  SVE <- dcm %*% SVE    ## take time step in error-state vector
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

  ## update the covariance matrix:
\end_layout

\begin_layout Plain Layout

  CV <- dcm %*% (CV %*% t(dcm)) + Q
\end_layout

\begin_layout Plain Layout

  if (is.na(D1$sdPsi[i]) || (sqrt(D1$LACCX[i]^2+D1$LACCY[i]^2) < 1)) {
\end_layout

\begin_layout Plain Layout

    H[7,9] <- 0
\end_layout

\begin_layout Plain Layout

    # DZ[i, 7] <- NA
\end_layout

\begin_layout Plain Layout

  } else {
\end_layout

\begin_layout Plain Layout

    H[7,9] <- MH
\end_layout

\begin_layout Plain Layout

    RCV[7, 7] <- 10*D1$sdPsi[i]^2
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

  ## the Kalman gain:
\end_layout

\begin_layout Plain Layout

  Kb <- solve (H %*% CV %*% t(H) + RCV)
\end_layout

\begin_layout Plain Layout

  K <- CV %*% t(H) %*% Kb
\end_layout

\begin_layout Plain Layout

  DZZ <- DZ[i, ] - H %*% SVE
\end_layout

\begin_layout Plain Layout

  SVE <- SVE + K %*% DZZ
\end_layout

\begin_layout Plain Layout

  CV <- CV - K %*% H %*% CV
\end_layout

\begin_layout Plain Layout

  SVEF[i/NSTEP, ] <- SVE
\end_layout

\begin_layout Plain Layout

  CVEF[i/NSTEP, ] <- diag(CV)
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## interpolate the results over the full data.frame:
\end_layout

\begin_layout Plain Layout

IntFilter <- function (X, inRate, outRate) {
\end_layout

\begin_layout Plain Layout

  if (inRate == outRate) {return (X)}
\end_layout

\begin_layout Plain Layout

  ratio <- as.integer(outRate/inRate)    ## expected to be an integer
\end_layout

\begin_layout Plain Layout

  x <- 0:(length(X)-1)
\end_layout

\begin_layout Plain Layout

  A <- stats::approx (x, X, n=length(X)*ratio-ratio+1)
\end_layout

\begin_layout Plain Layout

  T <- A$y
\end_layout

\begin_layout Plain Layout

  T <- signal::filter(signal::sgolay(4,75),T)
\end_layout

\begin_layout Plain Layout

  ## now shift to match Rate:
\end_layout

\begin_layout Plain Layout

  n <- as.integer (ratio / 2)
\end_layout

\begin_layout Plain Layout

  NL = length(T)
\end_layout

\begin_layout Plain Layout

  T <- c(rep(T[1],n), T, rep(T[NL],ratio-n-1))  ## OK, even or odd ratio
\end_layout

\begin_layout Plain Layout

  return (T)
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

Cor <- vector('numeric', DL*15)
\end_layout

\begin_layout Plain Layout

dim (Cor) <- c(DL, 15)
\end_layout

\begin_layout Plain Layout

VCor <- vector ('numeric', DL*15)
\end_layout

\begin_layout Plain Layout

dim (VCor) <- c(DL, 15)
\end_layout

\begin_layout Plain Layout

X <- SVEF[, 1]
\end_layout

\begin_layout Plain Layout

for (j in 1:15) {
\end_layout

\begin_layout Plain Layout

  Cor[, j] <- IntFilter (SVEF[, j], 1, NSTEP)
\end_layout

\begin_layout Plain Layout

  VCor[, j] <- IntFilter (CVEF[, j], 1, NSTEP)
\end_layout

\begin_layout Plain Layout

  VCor[VCor[,j] < 0] <- 0 
\end_layout

\begin_layout Plain Layout

  if (j > 6) {next}
\end_layout

\begin_layout Plain Layout

  Cor[, j] <- zoo::na.approx (as.vector (Cor[, j]), maxgap=1000, na.rm=FALSE)
\end_layout

\begin_layout Plain Layout

  Cor[is.na(Cor[, j]), j] <- 0
\end_layout

\begin_layout Plain Layout

  Cor[, j] <- signal::filtfilt (signal::butter (3, 1/600), Cor[, j])
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

# Cor7 <- Cor[, 7]
\end_layout

\begin_layout Plain Layout

# VC7 <- VCor[, 7]
\end_layout

\begin_layout Plain Layout

# .hdg <- D1$THDG * Cradeg
\end_layout

\begin_layout Plain Layout

# Cor[, 7] <- cos(.hdg) * Cor7 - sin(.hdg) * Cor[, 8]
\end_layout

\begin_layout Plain Layout

# Cor[, 8] <- sin(.hdg) * Cor7 + cos(.hdg) * Cor[, 8]
\end_layout

\begin_layout Plain Layout

# VCor[, 7] <- cos(.hdg) * VC7 - sin(.hdg) * VCor[, 8]
\end_layout

\begin_layout Plain Layout

# VCor[, 8] <- sin(.hdg) * VC7 + cos(.hdg) * VCor[, 8]
\end_layout

\begin_layout Plain Layout

D1$LATKF <- D1$LAT - Cor[, 1]/Cradeg
\end_layout

\begin_layout Plain Layout

D1$LONKF <- D1$LON - Cor[, 2]/Cradeg
\end_layout

\begin_layout Plain Layout

## filter the result to smooth the jumps arising from limited INS resolution:
\end_layout

\begin_layout Plain Layout

D1$LATKF <- zoo::na.approx (as.vector (D1$LATKF), maxgap=1000, na.rm=FALSE)
\end_layout

\begin_layout Plain Layout

D1$LONKF <- zoo::na.approx (as.vector (D1$LONKF), maxgap=1000, na.rm=FALSE)
\end_layout

\begin_layout Plain Layout

D1$LATKF[is.na(D1$LATKF)] <- 0
\end_layout

\begin_layout Plain Layout

D1$LONKF[is.na(D1$LONKF)] <- 0
\end_layout

\begin_layout Plain Layout

D1$LATKF <- signal::filtfilt (signal::butter (3, 2/(10*Rate)), D1$LATKF)
\end_layout

\begin_layout Plain Layout

D1$LONKF <- signal::filtfilt (signal::butter (3, 2/(10*Rate)), D1$LONKF)
\end_layout

\begin_layout Plain Layout

D1$ALTKF <- D1$ZROC - Cor[, 3]
\end_layout

\begin_layout Plain Layout

D1$VEWKF <- D1$VEW - Cor[, 4]
\end_layout

\begin_layout Plain Layout

D1$VNSKF <- D1$VNS - Cor[, 5]
\end_layout

\begin_layout Plain Layout

D1$ROCKF <- D1$ROC - Cor[, 6]
\end_layout

\begin_layout Plain Layout

D1$PITCHKF <- D1$PITCH - Cor[, 7]/Cradeg
\end_layout

\begin_layout Plain Layout

D1$ROLLKF <- D1$ROLL - Cor[, 8]/Cradeg
\end_layout

\begin_layout Plain Layout

D1$THDGKF <- D1$THDG - Cor[, 9]/Cradeg
\end_layout

\begin_layout Plain Layout

D1$BPITCHRKF <- D1$BPITCHR - Cor[, 10]/Cradeg
\end_layout

\begin_layout Plain Layout

D1$BROLLRKF <- D1$BROLLR - Cor[, 11]/Cradeg
\end_layout

\begin_layout Plain Layout

D1$BYAWRKF <- D1$BYAWR - Cor[, 12]/Cradeg
\end_layout

\begin_layout Plain Layout

D1$BLATAKF <- D1$BLATA - Cor[, 13]
\end_layout

\begin_layout Plain Layout

D1$BLONGAKF <- D1$BLONGA - Cor[, 14]
\end_layout

\begin_layout Plain Layout

D1$BNORMAKF <- D1$BNORMA - Cor[, 15]
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

D1$DLAT <- D1$LATKF-D1$GGLAT
\end_layout

\begin_layout Plain Layout

D1$DLATM <- D1$DLAT * .060 * StandardConstant ('Cmfromnmi')
\end_layout

\begin_layout Plain Layout

D1$CLAT <- -Cor[, 1] / Cradeg
\end_layout

\begin_layout Plain Layout

D1$CLATM <- D1$CLAT * .060 * StandardConstant ('Cmfromnmi')
\end_layout

\begin_layout Plain Layout

D1$DLON <- D1$LONKF-D1$GGLON
\end_layout

\begin_layout Plain Layout

D1$DLONM <- D1$DLON * .060 * StandardConstant ('Cmfromnmi') * cos (D1$GGLAT
 * Cradeg)
\end_layout

\begin_layout Plain Layout

D1$CLON <- -Cor[, 2] / Cradeg
\end_layout

\begin_layout Plain Layout

D1$CLONM <- D1$CLON * .060 * StandardConstant ('Cmfromnmi') * cos (D1$GGLAT
 * Cradeg)
\end_layout

\begin_layout Plain Layout

D1$DALT <- (D1$ALTKF-D1$GGALT)/1000
\end_layout

\begin_layout Plain Layout

D1$CALT <- -Cor[, 3]/1000
\end_layout

\begin_layout Plain Layout

D1$DVEW <- D1$VEWKF-D1$GGVEW
\end_layout

\begin_layout Plain Layout

D1$CVEW <- -Cor[, 4]
\end_layout

\begin_layout Plain Layout

D1$DVNS <- D1$VNSKF-D1$GGVNS
\end_layout

\begin_layout Plain Layout

D1$CVNS <- -Cor[, 5]
\end_layout

\begin_layout Plain Layout

D1$DROC <- D1$ROCKF-D1[, VROC]
\end_layout

\begin_layout Plain Layout

D1$CROC <- -Cor[, 6]
\end_layout

\begin_layout Plain Layout

D1$CPITCH <- -Cor[, 7] / Cradeg
\end_layout

\begin_layout Plain Layout

D1$CROLL <- -Cor[, 8] / Cradeg
\end_layout

\begin_layout Plain Layout

D1$CTHDG <- -Cor[, 9] / Cradeg
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

.hdg <- D1$THDG * Cradeg
\end_layout

\begin_layout Plain Layout

D1$CPL <- (cos(.hdg)*Cor[,7]+sin(.hdg)*Cor[,8]) / Cradeg
\end_layout

\begin_layout Plain Layout

D1$CRL <- (-sin(.hdg)*Cor[,7]+cos(.hdg)*Cor[,8]) / Cradeg
\end_layout

\begin_layout Plain Layout

D1$SDCPL <- sqrt(cos(.hdg)^2*VCor[,7]+sin(.hdg)^2*VCor[,8]) / (30*Cradeg)
\end_layout

\begin_layout Plain Layout

D1$SDCRL <- sqrt(sin(.hdg)^2*VCor[,7]+cos(.hdg)^2*VCor[,8]) / (30*Cradeg)
\end_layout

\begin_layout Plain Layout

D1$SDCPA <- sqrt(cos(.hdg)^2*D1$SDCPL^2 + sin(.hdg)^2*D1$SDCRL^2)
\end_layout

\begin_layout Plain Layout

D1$SDCRA <- sqrt(sin(.hdg)^2*D1$SDCPL^2 + cos(.hdg)^2*D1$SDCRL^2)
\end_layout

\begin_layout Plain Layout

D1$CPLF <- signal::filtfilt (signal::butter (3, 1/900), D1$CPL)
\end_layout

\begin_layout Plain Layout

D1$CRLF <- signal::filtfilt (signal::butter (3, 1/900), D1$CRL)
\end_layout

\begin_layout Plain Layout

D1$CPAF <- cos(.hdg)*D1$CPLF - sin(.hdg)*D1$CRLF
\end_layout

\begin_layout Plain Layout

D1$CRAF <- sin(.hdg)*D1$CPLF + cos(.hdg)*D1$CRLF
\end_layout

\begin_layout Plain Layout

## save corrected values, obtained by subtracting the smoothed a-frame correctio
ns:
\end_layout

\begin_layout Plain Layout

D1$PITCHKF <- D1$PITCH - D1$CPAF
\end_layout

\begin_layout Plain Layout

D1$ROLLKF <- D1$ROLL - D1$CRAF
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

HE <- VCor[,9]
\end_layout

\begin_layout Plain Layout

HE[HE < 0.00001] <- 0.00001
\end_layout

\begin_layout Plain Layout

# lineWAC(D1$Time[r], D1$THDG[r]/1000, col='brown', lwd=0.7)
\end_layout

\begin_layout Plain Layout

# lineWAC(D1$Time, D1$CTHDG-HE, col='magenta', lwd=0.7)
\end_layout

\begin_layout Plain Layout

# lineWAC(D1$Time, D1$CTHDG+HE, col='magenta', lwd=0.7)
\end_layout

\begin_layout Plain Layout

# D1$CTHDG <- SmoothInterp (D1$CTHDG, .Length=181)
\end_layout

\begin_layout Plain Layout

SS <- smooth.spline(D1$Time, D1$CTHDG, w=1/HE, spar=1.1)
\end_layout

\begin_layout Plain Layout

D1$HCS <- predict(SS, as.numeric(D1$Time))$y
\end_layout

\begin_layout Plain Layout

D1$THDGKF <- D1$THDG - D1$HCS    ## save the corrected heading
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
clearpage
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Results
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
There are several tests that the corrected values should pass:
\end_layout

\begin_layout Enumerate
Because the GPS measurements of position and aircraft velocity have low
 uncertainty, the corrected values from the Kalman filter should match these
 in long-term average, perhaps with some high-frequency components not present
 in the GPS-based measurements.
\end_layout

\begin_layout Enumerate
The pitch-correction algorithm developed in the Tech Note that describes
 wind uncertainty for the NSF/NCAR GV should give results in reasonable
 agreement with the corrected values of pitch and roll from the Kalman filter.
\end_layout

\begin_layout Enumerate
The heading-correction algorithm discussed in this memo should also produce
 results consistent with the Kalman-filter results.
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Position
\end_layout

\begin_layout Standard
Because the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
time step
\end_layout

\end_inset

time step for the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!time step
\end_layout

\end_inset

Kalman filter is normally longer that the interval between measurements
 in the original file, the error estimates from the Kalman filter are 
\begin_inset Index idx
status open

\begin_layout Plain Layout
interpolation!Kalman-filter results
\end_layout

\end_inset

interpolated to the original data rate
\begin_inset Index idx
status open

\begin_layout Plain Layout
data rate
\end_layout

\end_inset

 and then subtracted from the original 
\begin_inset Index idx
status open

\begin_layout Plain Layout
position!Kalman filter
\end_layout

\end_inset

measurements to obtain corrected
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!corrected variable
\end_layout

\end_inset

 results corresponding to the original measurements.
 The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!results!position
\end_layout

\end_inset

corrected results for position, after conversion to meters, are shown in
 Fig.
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:plot-Kalman-position}
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
altitude of aircraft!Kalman filter
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!plot!Kalman filter results
\end_layout

\end_inset

 for DEEPWAVE
\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset

 flight 16.
 The blue lines in the top two panels show that differences between the
 corrected (KF) and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based measurements (DLAT=
\begin_inset Index var
status open

\begin_layout Plain Layout
LAT: latitude, INS
\end_layout

\end_inset

LAT
\begin_inset Formula $-$
\end_inset


\begin_inset Index var
status open

\begin_layout Plain Layout
GGLAT: latitude, GPS
\end_layout

\end_inset

GGLAT+CLAT and DLON=
\begin_inset Index var
status open

\begin_layout Plain Layout
LON: longitude, INS
\end_layout

\end_inset

LON
\begin_inset Formula $-$
\end_inset


\begin_inset Index var
status open

\begin_layout Plain Layout
GGLON: longitude, GPS
\end_layout

\end_inset

GGLON+CLON where CLAT and CLON are the corrections produced by the Kalman
 filter) are negligibly small for latitude
\begin_inset Index idx
status open

\begin_layout Plain Layout
latitude
\end_layout

\end_inset

 and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
longitude
\end_layout

\end_inset

longitude, at the resolution of these plots.
 
\begin_inset Note Note
status open

\begin_layout Plain Layout
(0.01
\begin_inset Formula $^{\circ}$
\end_inset

 in latitude corresponds approximately to 1 km.) 
\end_layout

\end_inset

This good agreement arises from the corrections CLAT and CLON shown as the
 green lines, which show a smoothly varying 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Schuler oscillation
\end_layout

\end_inset

Schuler oscillation.
\begin_inset Foot
status open

\begin_layout Plain Layout
Before addition to the original measurement, this correction has been filtered
 using a three-pole low-pass Butterworth filter
\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!Butterworth
\end_layout

\end_inset

  with cutoff frequency
\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!cutoff frequency
\end_layout

\end_inset

 corresponding to a period of 600
\begin_inset space ~
\end_inset

s.
 This avoids the introduction of noise from the Kalman filter that otherwise
 would contaminate the high-frequency variance 
\begin_inset Index idx
status open

\begin_layout Plain Layout
spectrum!variance
\end_layout

\end_inset

spectra.
\end_layout

\end_inset

 Using the new variable ZROC
\begin_inset Index var
status open

\begin_layout Plain Layout
ZROC: altitude, INS new
\end_layout

\end_inset

 from Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:ROC"

\end_inset

 for altitude
\begin_inset Index idx
status open

\begin_layout Plain Layout
altitude of aircraft!new variable ZROC
\end_layout

\end_inset

 leads to only a small 
\begin_inset Index idx
status open

\begin_layout Plain Layout
altitude!offset
\end_layout

\end_inset

offset in vertical position; this would be 100 times larger if the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

INS-provided variable ALT
\begin_inset Index var
status open

\begin_layout Plain Layout
ALT: altitude, INS
\end_layout

\end_inset


\begin_inset Index idx
status collapsed

\begin_layout Plain Layout
variable in data files!ALT
\end_layout

\end_inset

  had been used, because then the correction would need to remove the difference
 between pressure altitude,
\begin_inset Index idx
status open

\begin_layout Plain Layout
altitude of aircraft!pressure
\end_layout

\end_inset

 used by the INS, and geometric altitude
\begin_inset Index idx
status open

\begin_layout Plain Layout
altitude of aircraft!geometric
\end_layout

\end_inset

  from the GPS.
 
\end_layout

\begin_layout Standard
At higher resolution than plotted here, there are step-change features in
 the KF result that are not present in the GPS measurement, at a level of
 about 10
\begin_inset space ~
\end_inset

m.
 The reason is that this is the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
resolution!data recording
\end_layout

\end_inset

resolution at which the original measurements from the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

INS (variables LAT and LON) are recorded, so a smoothly varying correction
 as provided by the Kalman filter preserves these step changes.
 Because the true values of latitude
\begin_inset Index idx
status open

\begin_layout Plain Layout
latitude
\end_layout

\end_inset

 and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
longitude
\end_layout

\end_inset

longitude are not expected to show high-frequency components at these frequencie
s, the positions after correction are further 
\begin_inset Index idx
status open

\begin_layout Plain Layout
smoothing
\end_layout

\end_inset

filtered using a low-pass Butterworth filter with a cutoff frequency
\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!cutoff frequency
\end_layout

\end_inset

 corresponding to about 10
\begin_inset space ~
\end_inset

s.
 This effectively smooths the jumps arising from the original 
\begin_inset Index idx
status open

\begin_layout Plain Layout
position!smoothing
\end_layout

\end_inset

measurements from the INS and leads to agreement between the KF and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based values corresponding to about 10
\begin_inset space ~
\end_inset

m standard deviation
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!position difference
\end_layout

\end_inset

 for the part of the flight track that excludes the initial climb and final
 descent.
 Some part of this standard deviation likely arises from minor time shifts
 between the measurements from the INS and GPS.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<plot-Kalman-position, include=TRUE, fig.scap="Comparison of the Kalman
 filter, GPS, and INS values for latitude, longitude and altitude, with
 corrections from the Kalman filter also shown.", fig.cap='Comparison of the
 KF (Kalman filter), GPS, and INS values of position for DEEPWAVE flight
 16.
 DLAT, DLON, and DALT (blue lines) are the differences between the Kalman-filter
 result and GPS measurement, while CLAT, CLON, and CALT (green lines) are
 the corrections applied to the original INS values by the Kalman filter.',
 cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

r <- setRange (D1, 70000, 122000)
\end_layout

\begin_layout Plain Layout

DP <- D1[r, ]
\end_layout

\begin_layout Plain Layout

ggplotWAC (with (DP,
\end_layout

\begin_layout Plain Layout

                 data.frame(Time, DLONM, CLONM, DLATM, CLATM, DALT, CALT)),
\end_layout

\begin_layout Plain Layout

           ylab=expression (paste ('difference in position [km]')),
\end_layout

\begin_layout Plain Layout

           panels=3, 
\end_layout

\begin_layout Plain Layout

           labelL=c('KF-GPS', 'correction'),
\end_layout

\begin_layout Plain Layout

           labelP=c('east', 'north', 'up'),
\end_layout

\begin_layout Plain Layout

           legend.position=c(0.2,0.68), theme.version=1
\end_layout

\begin_layout Plain Layout

)
\end_layout

\begin_layout Plain Layout

sdZ <- sd(DP$DALT, na.rm=TRUE)
\end_layout

\begin_layout Plain Layout

sdvew <- sd(DP$GGVEW - DP$VEWKF, na.rm=TRUE)
\end_layout

\begin_layout Plain Layout

sdvns <- sd(DP$GGVNS - DP$VNSKF, na.rm=TRUE)
\end_layout

\begin_layout Plain Layout

meanvz <- mean(DP$ROCKF - DP[, VROC], na.rm=TRUE)
\end_layout

\begin_layout Plain Layout

sdvz <- sd(DP[, VROC] - DP$ROCKF, na.rm=TRUE)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
The bottom panel in Fig.
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:plot-Kalman-position}
\end_layout

\end_inset

 shows that a significant offset is required to correct the altitude, as
 expected because the INS-provided altitude is updated to the pressure altitude
 while the GPS provides geometric altitude above MSL.
 The repetitive pattern in the correction arises from the repeated portions
 of the flight track, which passed over the South Island of New Zealand
 in retracing patterns.
 The updating effectively adjusts the altitude to match the GPS-measured
 altitude, with a standard deviation in the central part of this flight
 track that was 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(sd(D1$DALT[r], na.rm=TRUE), 0)}
\end_layout

\end_inset


\begin_inset space ~
\end_inset

m.
 
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The result then is that the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
position!Kalman filter
\end_layout

\end_inset

positions after correction are in agreement with the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based measurements of position to within about 10
\begin_inset space ~
\end_inset

m in each component of the position vector.
 The uncertainty arising from the calculated covariance
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!covariance
\end_layout

\end_inset

 matrix
\begin_inset Index idx
status open

\begin_layout Plain Layout
matrix!covariance
\end_layout

\end_inset

 also indicates uncertainty
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!uncertainty
\end_layout

\end_inset

 for individual 
\begin_inset Index idx
status open

\begin_layout Plain Layout
position!uncertainty
\end_layout

\end_inset

measurements of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
latitude!uncertainty
\end_layout

\end_inset

latitude or 
\begin_inset Index idx
status open

\begin_layout Plain Layout
longitude
\end_layout

\end_inset

longitude corresponding to about 10
\begin_inset space ~
\end_inset

m.
\end_layout

\begin_layout Subsubsection
Ground-speed components and rate of climb
\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!results!velocity
\end_layout

\end_inset

Figure 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:plot-Kalman-velocity}
\end_layout

\end_inset

 shows the corresponding differences between the aircraft-velocity 
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!Kalman filter
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!**
\end_layout

\end_inset

components
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!Kalman filter
\end_layout

\end_inset

 and the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based measurements, for the same flight as that shown in the preceding
 figure.
 For the two horizontal components of ground speed, the mean difference
 between KF and GPS results is negligible (
\begin_inset Formula $<0.00001$
\end_inset


\begin_inset space ~
\end_inset

m/s) and the standard deviation
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!velocity difference
\end_layout

\end_inset

 of this difference is about 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(sdvns, 2)}
\end_layout

\end_inset


\begin_inset space ~
\end_inset

m/s, mostly arising in turns and likely the result of small timing differences
 between INS-provided and GPS-based measurements.
 There does not appear to be a problem with 
\begin_inset Index idx
status open

\begin_layout Plain Layout
resolution!data recording
\end_layout

\end_inset

resolution for the INS variables (
\begin_inset Index var
status open

\begin_layout Plain Layout
VEW: ground speed eastward, INS
\end_layout

\end_inset

VEW and 
\begin_inset Index var
status open

\begin_layout Plain Layout
VNS: ground speed northward, INS
\end_layout

\end_inset

VNS) as there was for position, so no further smoothing of these results
 is needed.
 Indeed, plots of the KF and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based variables for short time intervals indicate that there is more
 noise in the GPS-based variables (GGVEW and GGVNS) than in the KF variables,
 so using the new variables from the Kalman filter in the calculation
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!horizontal!calculation
\end_layout

\end_inset

 of horizontal wind may lead to better high-frequency spectral characteristics
\begin_inset Index idx
status open

\begin_layout Plain Layout
spectral characteristics!high frequency
\end_layout

\end_inset

 than those obtained using the GPS-based variables.
 This will be explored further in Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:KF-wind"

\end_inset

.
 The occasional spikes in this plot are all associated with turns, and they
 have been minimized by adjustment of the relative timing
\begin_inset Index idx
status open

\begin_layout Plain Layout
time lag!adjustment for
\end_layout

\end_inset

 between the INS-provided and GPS-based variables as well as correction
 for the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
correction!for aircraft rotation
\end_layout

\end_inset

rotation rates of the aircraft, but these small residuals remain.
 Despite some exploration, it has not been possible to reduce them further.
\end_layout

\begin_layout Standard
The difference between the KF and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based variables for 
\begin_inset Index idx
status open

\begin_layout Plain Layout
rate of climb!Kalman filter
\end_layout

\end_inset

rate-of-climb of the aircraft,
\begin_inset Index idx
status open

\begin_layout Plain Layout
rate of climb!Kalman filter
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
rate of climb!Kalman filter
\end_layout

\end_inset

 shown in the bottom panel of Fig.
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:plot-Kalman-velocity}
\end_layout

\end_inset

,
\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!plot!Kalman filter results
\end_layout

\end_inset

 needs further explanation.
 This calculation was first done using the INS-provided variable 
\begin_inset Index var
status open

\begin_layout Plain Layout
VSPD: rate of climb, INS
\end_layout

\end_inset

VSPD as the vertical-motion component of the state variable.
 While the mean values were similar, the standard deviation
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!velocity difference
\end_layout

\end_inset

 in this difference was about 0.28
\begin_inset space ~
\end_inset

m/s, which is larger than expected or desirable.
 The difficulty is attributable to weakness in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

INS-provided variable 
\begin_inset Index idx
status open

\begin_layout Plain Layout
VSPD!characteristics
\end_layout

\end_inset

VSPD\SpecialChar endofsentence
 Examination of this variable indicates that it has been filtered and
 shifted in time before being transmitted to the GV data system for recording,
 and the INS internal processing includes a 
\begin_inset Index idx
status open

\begin_layout Plain Layout
baro-inertial loop
\end_layout

\end_inset

baro-inertial loop that updates to the pressure altitude.
\begin_inset Index idx
status open

\begin_layout Plain Layout
altitude of aircraft!pressure
\end_layout

\end_inset

 Section 
\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:ROC"

\end_inset

 of this technical note and this 
\begin_inset Index idx
status open

\begin_layout Plain Layout
rate of climb!ROC memo
\end_layout

\end_inset

memo (
\begin_inset CommandInset href
LatexCommand href
name "Recommendation161107f.pdf"
target "https://drive.google.com/open?id=0B1kIUH45ca5AMXpaWlIyWWxwU2M"

\end_inset

) argue that 
\begin_inset Index var
status open

\begin_layout Plain Layout
VSPD: rate of climb, INS
\end_layout

\end_inset

VSPD is a poor variable to use when calculating the vertical wind
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!vertical!**
\end_layout

\end_inset

 and that an alternative 
\begin_inset Index idx
status open

\begin_layout Plain Layout
ROC=rate of climb
\end_layout

\end_inset

variable
\begin_inset Index var
status open

\begin_layout Plain Layout
ROC: rate of climb, INS new
\end_layout

\end_inset

 (ROC) represents the rate of climb of the aircraft better while still remaining
 independent of the GPS-based measurements.
 That new variable has been used in the present calculation and in Fig.
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:plot-Kalman-velocity}
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!Kalman filter
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset

  instead of VSPD.
 The Kalman filter then updates that variable to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS
\end_layout

\end_inset

measurement (GGVSPD), to produce the new variable 
\begin_inset Index idx
status open

\begin_layout Plain Layout
ROC=rate of climb
\end_layout

\end_inset

ROCKF
\begin_inset Index var
status open

\begin_layout Plain Layout
ROCKF: rate of climb, Kalman filter
\end_layout

\end_inset

 that is shown in this plot.
 The mean difference between the GPS value and the corrected measurement
 from the Kalman filter
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter
\end_layout

\end_inset

 was 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(meanvz,3)}
\end_layout

\end_inset


\begin_inset space ~
\end_inset

m/s, with standard deviation 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(sdvz, 2)}
\end_layout

\end_inset


\begin_inset space ~
\end_inset

m/s.
 Section
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:KF-vertical-wind"

\end_inset

 explores the characteristics of the new variable (ROCKF) as it would influence
 calculation
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!vertical!calculation
\end_layout

\end_inset

 of the vertical wind.
 There it is argued that the level of noise evident in the bottom panel
 of this plot arises mostly from noise in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS!noise
\end_layout

\end_inset

measurement of rate of climb.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<plot-Kalman-velocity, include=TRUE, fig.scap="Comparison of the Kalman
 filter, GPS, and INS values for aircraft-velocity components, with corrections
 from the Kalman filter also shown.", fig.cap="Comparison of the KF, GPS,
 and INS values of aircraft-velocity components for DEEPWAVE flight 16.
 Blue lines show the differences between the Kalman-filter results and the
 corresponding GPS-based values, while the green lines show the corrections
 applied to the original INS values by the Kalman filter.", cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

ggplotWAC (with (DP,
\end_layout

\begin_layout Plain Layout

                 data.frame(Time, DVEW, CVEW, DVNS, CVNS, DROC, CROC)),
\end_layout

\begin_layout Plain Layout

           ylab=expression (paste ('velocity component [m ',s^-1,']')),
\end_layout

\begin_layout Plain Layout

           panels=3, 
\end_layout

\begin_layout Plain Layout

           labelL=c('KF-GPS', 'correction'),
\end_layout

\begin_layout Plain Layout

           labelP=c('east', 'north', 'up'),
\end_layout

\begin_layout Plain Layout

           legend.position=c(0.2, 0.97), theme.version=1
\end_layout

\begin_layout Plain Layout

)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Plain Layout
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename Fig7.png
	width 98text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Errors in pitch and roll after transformation to the l-frame (blue lines).
 The red lines result from the application of a centered low-pass third-order
 Butterworth filter to the errors, where the filter cutoff frequency corresponds
 to a period of 900 s.
 The shaded ribbon shows the estimated standard uncertainty.
\begin_inset CommandInset label
LatexCommand label
name "fig:Errors-in-pitch"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
newpage
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename Fig9.png
	width 98text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Errors in pitch and roll (blue lines) that result from transforming the
 filtered result in the previous figure back from the 
\emph on
l-
\emph default
frame to the 
\emph on
a-
\emph default
frame.
 The corrections needed to these variables when calculating the wind are
 to subtract these values from the measurements produced by the INS.
 The red lines show the result of the separate pitch-correction function
 discussed in the text.
 The shaded ribbon shows the estimated standard uncertainty in the Kalman-filter
 result.
\begin_inset CommandInset label
LatexCommand label
name "fig:a-frame-errors"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout

<<custom-dev, eval=FALSE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

my_png = function(file, width=600, height=480) {
\end_layout

\begin_layout Plain Layout

  png(file, width = width, height = height, res=150, pointsize = 10)
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<errors-in-pitch, include=TRUE, fig.height=4.5, fig.scap="Errors in pitch
 and roll after transformation to the l-frame with a filtered result and
 bands of uncertainty.", fig.cap='Errors in pitch and roll after transformation
 to the l-frame (blue lines).
 The red lines result from the application of a centered low-pass third-order
 Butterworth filter to the errors, where the filter cutoff frequency corresponds
 to a period of 900 s.
 The shaded ribbon shows the estimated standard uncertainty.', dev='png',
 dpi=100, cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## must construct using many of the elements of ggplotWAC but in this order:
\end_layout

\begin_layout Plain Layout

d1 <- with(DP, data.frame(Time, CPL, CPLF, CRL, CRLF))
\end_layout

\begin_layout Plain Layout

lines_per_panel <- 2; panels <- 2
\end_layout

\begin_layout Plain Layout

labelL=c('KF value', 'smoothed')
\end_layout

\begin_layout Plain Layout

labelP=c('pitch', 'roll')
\end_layout

\begin_layout Plain Layout

DL <- nrow(d1)
\end_layout

\begin_layout Plain Layout

VarGroup <- rep (gl (lines_per_panel, DL, labels=labelL), panels)
\end_layout

\begin_layout Plain Layout

PanelGroup <- gl (panels, lines_per_panel*DL, labels=labelP)
\end_layout

\begin_layout Plain Layout

dd <- data.frame(reshape2::melt(d1, 1), VarGroup, PanelGroup)
\end_layout

\begin_layout Plain Layout

lvl <- levels(dd$VarGroup)
\end_layout

\begin_layout Plain Layout

d2 <- with(DP, data.frame(Time, "plo"=CPLF-4*SDCPL, "rlo"=CRLF-4*SDCRL,
\end_layout

\begin_layout Plain Layout

                             "phi"=CPLF+4*SDCPL, "rhi"=CRLF+4*SDCRL))
\end_layout

\begin_layout Plain Layout

## note the required order below:
\end_layout

\begin_layout Plain Layout

de <- data.frame (reshape2::melt(d2, 1, c(2,4,3,5)), VarGroup, PanelGroup)
\end_layout

\begin_layout Plain Layout

g7 <- ggplot(dd, aes(x=Time)) + facet_grid(PanelGroup ~ .) 
\end_layout

\begin_layout Plain Layout

g7 <- g7 + geom_ribbon(aes(x=Time, ymin=value, ymax=value), data=de, alpha=0.25)
  ##alpha=.25 
\end_layout

\begin_layout Plain Layout

g7 <- g7 + geom_path(aes(x=Time, y=value, colour=VarGroup, linetype=VarGroup,
 size=VarGroup), data=dd)
\end_layout

\begin_layout Plain Layout

g7 <- g7 + ylim(-0.05,0.05)
\end_layout

\begin_layout Plain Layout

g7 <- g7 + scale_linetype_manual ('', labels=lvl, breaks=lvl, values = c(1,1))
\end_layout

\begin_layout Plain Layout

g7 <- g7 + scale_colour_manual('', labels = lvl, breaks=lvl, values = c('blue',
 'red'))
\end_layout

\begin_layout Plain Layout

g7 <- g7 + scale_size_manual('', labels=lvl, breaks=lvl, values = c(0.5,
 1.5))
\end_layout

\begin_layout Plain Layout

g7 <- g7 + theme_WAC(1) + theme (legend.position=c(0.5,0.95))
\end_layout

\begin_layout Plain Layout

g7 <- g7 + theme(axis.text.x = element_text (size=11.5, margin=margin(15,0,0,0)))
\end_layout

\begin_layout Plain Layout

g7 <- g7 + theme(axis.title.x = element_text (size=12))
\end_layout

\begin_layout Plain Layout

g7 <- g7 + labs (x='Time [UTC]', y=expression (paste ('l-frame error [',degree,'
]')))
\end_layout

\begin_layout Plain Layout

## I'm not sure why this is necessary; printing g7 in the usual way did
 not leave
\end_layout

\begin_layout Plain Layout

## the ribbon visible, apparently because the resulting pdf file did not
 include it.
\end_layout

\begin_layout Plain Layout

## Now the plot is generated here, but placed in the document in the LaTeX
 code
\end_layout

\begin_layout Plain Layout

## preceding this chunk.
 This out-of-order sequence requires run
\end_layout

\begin_layout Plain Layout

# png (filename='Fig7.png', width=600, height=480, res=150)
\end_layout

\begin_layout Plain Layout

print (g7)
\end_layout

\begin_layout Plain Layout

# invisible (dev.off())
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Roll and pitch
\begin_inset CommandInset label
LatexCommand label
name "subsec:Roll-and-pitch"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!results!pitch
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!results!roll
\end_layout

\end_inset

The primary value of this Kalman-filter estimate of error is the improvement
 in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle
\end_layout

\end_inset

measurements of attitude angles.
\begin_inset Index idx
status open

\begin_layout Plain Layout
attitude angle
\end_layout

\end_inset

 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS
\end_layout

\end_inset

Measurements of position and velocity with good quality are already available
 from the GPS
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

 receiver, although some improvement is realized in those cases also.
 As discussed in Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Smoothing-the-errors"

\end_inset

, it is expected that the errors in pitch and roll will vary more smoothly
 in the 
\emph on
l-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 than in the 
\emph on
a-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset

 because each turn changes how any platform
\begin_inset Index idx
status open

\begin_layout Plain Layout
inertial platform!misalignment
\end_layout

\end_inset

 misalignment is resolved into errors in pitch and roll.
 It is therefore useful to 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

transform those errors to the 
\emph on
l-
\emph default
frame for 
\begin_inset Index idx
status open

\begin_layout Plain Layout
smoothing
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
pitch!smoothing!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

smoothing.
 The approximate transformation for level flight is
\begin_inset Newline newline
\end_inset


\begin_inset Formula 
\begin{eqnarray}
\delta\theta^{(l)} & = & \cos\psi\thinspace\delta\theta^{(a)}+\sin\psi\thinspace\delta\phi^{(a)}\label{eq:a-to-l-frame}\\
\delta\phi^{(l)} & = & -\sin\psi\thinspace\delta\theta^{(a)}+\cos\psi\thinspace\delta\phi^{(a)}\nonumber 
\end{eqnarray}

\end_inset

where 
\begin_inset Formula $\theta$
\end_inset

, 
\begin_inset Formula $\phi$
\end_inset

 and 
\begin_inset Formula $\psi$
\end_inset

 denote pitch, roll and heading, respectively, and the superscripts in parenthes
es indicate the reference frame.
 After this transformation is applied to the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error-state vector
\end_layout

\end_inset

error-state vector produced by the Kalman filter, the pitch and roll errors
 in the 
\emph on
l-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 are as shown in 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!transformation
\end_layout

\end_inset

Fig.
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:errors-in-pitch}
\end_layout

\end_inset

.
\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!cutoff frequency
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch!Kalman-filter result
\end_layout

\end_inset

 As for position and velocity, pronounced Schuler oscillations
\begin_inset Index idx
status open

\begin_layout Plain Layout
Schuler oscillation
\end_layout

\end_inset

 are evident in both.
 Also shown in this plot is the result of applying a low-pass third-order
 Butterworth filter
\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!Butterworth
\end_layout

\end_inset

 with 900
\begin_inset space ~
\end_inset

s cutoff period to the errors.
 The result is a smoothly varying error signal dominated by the Schuler
 oscillation that eliminates much of the apparent noise introduced by the
 Kalman filter.
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
a-
\emph default
frame
\end_layout

\end_inset

Figure
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:a-frame-errors}
\end_layout

\end_inset

 shows the result of transforming the smoothed error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch!
\emph on
a-
\emph default
frame
\end_layout

\end_inset

 signal back to the 
\emph on
a-
\emph default
frame, and it also shows the result of the simplified algorithm of Sect.
\begin_inset space ~
\end_inset

XX as the red line labeled 
\begin_inset Quotes eld
\end_inset

PC.
\begin_inset Quotes erd
\end_inset

 The results from the simplified algorithm are in good agreement with the
 error estimates from the Kalman filter, with some increased differences
 in turns as expected.
 These smoothed errors are then subtracted from the original measurements
 to obtain corrected 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!corrected by Kalman filter
\end_layout

\end_inset

results,
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<a-frame-errors, include=TRUE, fig.height=4.0, fig.scap="Errors in pitch and
 roll that result from transforming the filtered result in the previous
 figure back from the l-frame to the a-frame.", fig.cap='Errors in pitch and
 roll (blue lines) that result from transforming the filtered result in
 the previous figure back from the l-frame to the a-frame.
 The red lines show the result of the separate pitch-correction function
 discussed in the text.
 The shaded ribbon shows the estimated standard uncertainty in the Kalman-filter
 result.', dev='png', dpi=100, cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# with(D1[r, ],
\end_layout

\begin_layout Plain Layout

#      ggplotWAC (data.frame(Time, CPL, CPLF, CRL, CRLF),
\end_layout

\begin_layout Plain Layout

#                 col=c('blue', 'red'), lwd=c(1.4, 0.8), lty=c(1,1),
\end_layout

\begin_layout Plain Layout

#                 ylab=expression (paste ('l-frame error [',degree,']')),
\end_layout

\begin_layout Plain Layout

#                 panels=2, labelL=c('KF value', 'smoothed'),
\end_layout

\begin_layout Plain Layout

#                 labelP=c('pitch', 'roll')
\end_layout

\begin_layout Plain Layout

#      )
\end_layout

\begin_layout Plain Layout

# )
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

PC <- CorrectPitch(DP, .span=901)
\end_layout

\begin_layout Plain Layout

DP$PC <- PC[, 1]
\end_layout

\begin_layout Plain Layout

DP$RC <- PC[, 2]
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# with(D1[r, ],
\end_layout

\begin_layout Plain Layout

#      ggplotWAC (data.frame(Time, CPAF, PC, CRAF, RC),
\end_layout

\begin_layout Plain Layout

#                 col=c('blue', 'red'), lwd=c(1.4, 0.8), lty=c(1,1),
\end_layout

\begin_layout Plain Layout

#                 ylab=expression (paste ('a-frame error [',degree,']')),
\end_layout

\begin_layout Plain Layout

#                 panels=2, labelL=c('KF smoothed', 'CorrectPitch'),
\end_layout

\begin_layout Plain Layout

#                 labelP=c('pitch', 'roll')
\end_layout

\begin_layout Plain Layout

#      )
\end_layout

\begin_layout Plain Layout

# )
\end_layout

\begin_layout Plain Layout

d1 <- with(DP, data.frame(Time, CPAF, PC, CRAF, RC))
\end_layout

\begin_layout Plain Layout

lines_per_panel <- 2; panels <- 2
\end_layout

\begin_layout Plain Layout

labelL=c('smoothed KF value', 'PC')
\end_layout

\begin_layout Plain Layout

labelP=c('pitch', 'roll')
\end_layout

\begin_layout Plain Layout

DL <- nrow(d1)
\end_layout

\begin_layout Plain Layout

VarGroup <- rep (gl (lines_per_panel, DL, labels=labelL), panels)
\end_layout

\begin_layout Plain Layout

PanelGroup <- gl (panels, lines_per_panel*DL, labels=labelP)
\end_layout

\begin_layout Plain Layout

dd <- data.frame(reshape2::melt(d1, 1), VarGroup, PanelGroup)
\end_layout

\begin_layout Plain Layout

lvl <- levels(dd$VarGroup)
\end_layout

\begin_layout Plain Layout

d2 <- with(DP, data.frame(Time, "plo"=CPAF-4*SDCPA, "rlo"=CRAF-4*SDCRA,
\end_layout

\begin_layout Plain Layout

                             "phi"=CPAF+4*SDCPA, "rhi"=CRAF+4*SDCRA))
\end_layout

\begin_layout Plain Layout

## note the required order below:
\end_layout

\begin_layout Plain Layout

de <- data.frame (reshape2::melt(d2, 1, c(2,4,3,5)), VarGroup, PanelGroup)
\end_layout

\begin_layout Plain Layout

g9 <- ggplot(dd, aes(x=Time)) + facet_grid(PanelGroup ~ .) 
\end_layout

\begin_layout Plain Layout

g9 <- g9 + geom_ribbon(aes(x=Time, ymin=value, ymax=value), data=de, alpha=0.25)
 
\end_layout

\begin_layout Plain Layout

g9 <- g9 + geom_line(aes(x=Time, y=value, colour=VarGroup, linetype=VarGroup),
 data=dd)
\end_layout

\begin_layout Plain Layout

g9 <- g9 + ylim(-0.05,0.05)
\end_layout

\begin_layout Plain Layout

g9 <- g9 + scale_linetype_manual ('', labels=lvl, breaks=lvl, values = c(1,1))
\end_layout

\begin_layout Plain Layout

g9 <- g9 + scale_colour_manual('', labels = lvl, breaks=lvl, values = c('blue',
 'red'))
\end_layout

\begin_layout Plain Layout

g9 <- g9 + theme_WAC(1) + theme (legend.position=c(0.5,0.95))
\end_layout

\begin_layout Plain Layout

g9 <- g9 + theme(axis.text.x = element_text (size=11.5, margin=margin(15,0,0,0)))
\end_layout

\begin_layout Plain Layout

g9 <- g9 + theme(axis.title.x = element_text (size=12))
\end_layout

\begin_layout Plain Layout

g9 <- g9 + labs (x='Time [UTC]', y=expression (paste ('a-frame error [',degree,'
]')))
\end_layout

\begin_layout Plain Layout

## I'm not sure why this is necessary; printing g9 in the usual way did
 not leave
\end_layout

\begin_layout Plain Layout

## the ribbon visible, apparently because the resulting pdf file did not
 include it.
\end_layout

\begin_layout Plain Layout

## Now the plot is generated here, but placed in the document in the LaTeX
 code
\end_layout

\begin_layout Plain Layout

## preceding this chunk.
 This out-of-order sequence requires run
\end_layout

\begin_layout Plain Layout

# png (filename='Fig9.png', width=600, height=480, res=150)
\end_layout

\begin_layout Plain Layout

print (g9)
\end_layout

\begin_layout Plain Layout

# invisible (dev.off())
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## translate pitch/roll corrections to the a-frame:
\end_layout

\begin_layout Plain Layout

.hdg <- DP$THDG * Cradeg
\end_layout

\begin_layout Plain Layout

C7 <- SmoothInterp (Cor[, 7], .Length=181)
\end_layout

\begin_layout Plain Layout

C8 <- SmoothInterp (Cor[, 8], .Length=181)
\end_layout

\begin_layout Plain Layout

# CPITCH <- cos(.hdg) * C7 + sin(.hdg) * C8
\end_layout

\begin_layout Plain Layout

# CROLL <- -sin(.hdg) * C7 + cos(.hdg) * C8
\end_layout

\begin_layout Plain Layout

# # CPITCH <- cos(.hdg) * Cor[, 7] + sin(.hdg) * Cor[, 8]
\end_layout

\begin_layout Plain Layout

# # CROLL <- -sin(.hdg) * Cor[, 7] + cos(.hdg) * Cor[, 8]
\end_layout

\begin_layout Plain Layout

# D1$CPITCH <- CPITCH / Cradeg
\end_layout

\begin_layout Plain Layout

# D1$CROLL <- CROLL / Cradeg
\end_layout

\begin_layout Plain Layout

# D1$CPITCH <- SmoothInterp (D1$CPITCH, .Length=181)
\end_layout

\begin_layout Plain Layout

# D1$CROLL <- SmoothInterp (D1$CROLL, .Length=181)
\end_layout

\begin_layout Plain Layout

# D1$CTHDG <- SmoothInterp (D1$CTHDG, .Length=181)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

DP$HC <- -CorrectHeading (DP, .plotfile='./HCPlot.pdf')
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# plotWAC(subset(D1[r,],,c(Time, CPITCH, PC)), ylab=expression(paste('PITCH
 CORRECTION',' [',degree,']')), 
\end_layout

\begin_layout Plain Layout

#         ylim=c(-0.05, 0.05), lwd=c(0.7,0.7), col=c('blue', 'red'), legend.position=
'topright')
\end_layout

\begin_layout Plain Layout

# CCPITCH <- D1$CPITCH
\end_layout

\begin_layout Plain Layout

# PCC <- D1$PC
\end_layout

\begin_layout Plain Layout

# ival <- abs(D1$ROLL) > 4
\end_layout

\begin_layout Plain Layout

# CCPITCH[ival] <- NA
\end_layout

\begin_layout Plain Layout

# PCC[ival] <- NA
\end_layout

\begin_layout Plain Layout

# lineWAC(D1$Time[r], CCPITCH[r], lwd=3, col='blue')
\end_layout

\begin_layout Plain Layout

# lineWAC(D1$Time[r], PCC[r], lwd=3, col='red')
\end_layout

\begin_layout Plain Layout

# abline(h=0, col='darkorange', lty=2)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# with(D1[r,], plotWAC(data.frame(Time, CPL)))
\end_layout

\begin_layout Plain Layout

# lineWAC(D1$Time[r], predict(SP, as.numeric(D1$Time))$y[r], col='red')
\end_layout

\begin_layout Plain Layout

# lineWAC(D1$Time[r], sqrt(VC7[r])+predict(SP, as.numeric(D1$Time))$y[r],
 col='darkgreen')
\end_layout

\begin_layout Plain Layout

# lineWAC(D1$Time[r], -sqrt(VC7[r])+predict(SP, as.numeric(D1$Time))$y[r],
 col='darkgreen')
\end_layout

\begin_layout Plain Layout

# Y <- predict(SP, as.numeric(D1$Time))$y[r]
\end_layout

\begin_layout Plain Layout

# plotWAC(data.frame(D1$Time[r], Y, Y+sqrt(VC7[r]), Y-sqrt(VC7[r]), D1$CPL[r]),
 
\end_layout

\begin_layout Plain Layout

#         col=c('blue', 'darkgreen', 'darkgreen', 'red'), lty=c(1,2,2,1))
\end_layout

\begin_layout Plain Layout

# plotWAC(subset(D1[r,],,c(Time, CROLL, RC)), 
\end_layout

\begin_layout Plain Layout

#       ylab=expression(paste('ROLL CORRECTION [',degree,']')), 
\end_layout

\begin_layout Plain Layout

#       ylim=c(-0.05,0.05), lwd=c(0.7,0.7), col=c('blue', 'red'), legend.position='to
pright')
\end_layout

\begin_layout Plain Layout

# D1$CROLL[ival] <- NA
\end_layout

\begin_layout Plain Layout

# D1$RC[ival] <- NA
\end_layout

\begin_layout Plain Layout

# lineWAC(D1$Time[r], D1$CROLL[r], lwd=3, col='blue')
\end_layout

\begin_layout Plain Layout

# lineWAC(D1$Time[r], D1$RC[r], lwd=3, col='red')
\end_layout

\begin_layout Plain Layout

# abline(h=0, col='darkorange', lty=2)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

DP$dP <- DP$deltaPsi/Cradeg
\end_layout

\begin_layout Plain Layout

HA <- with(DP, sqrt(LACCX^2+LACCY^2))
\end_layout

\begin_layout Plain Layout

DP$dP[HA < 1] <- NA
\end_layout

\begin_layout Plain Layout

sddP <- sd(DP$dP, na.rm=TRUE)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The variances associated with 
\emph on
l-
\emph default
frame
\begin_inset Index idx
status open

\begin_layout Plain Layout
pitch!variance!
\emph on
l-
\emph default
frame
\end_layout

\end_inset

 pitch and roll can be found by appropriate derivation from (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:a-to-l-frame"

\end_inset

).
 The resulting variances correspond to a standard deviation
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!pitch correction
\end_layout

\end_inset

 of typically about 0.2
\begin_inset Formula $^{\circ}$
\end_inset

, but that then is reduced by an appropriate factor representing the reduction
 in standard deviation from averaging many points, as was done with the
 low-pass filter with 900
\begin_inset space ~
\end_inset

s cutoff.
\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!cutoff frequency
\end_layout

\end_inset

 Averaging 900 points would reduce the expected standard deviation by a
 factor of 1/30, so this seems an appropriate factor to use when representing
 the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!uncertainty
\end_layout

\end_inset

uncertainty in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
smoothing
\end_layout

\end_inset

smoothed correction.
 The gray ribbon in Fig.
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:errors-in-pitch}
\end_layout

\end_inset

 shows the resulting 
\begin_inset Index idx
status open

\begin_layout Plain Layout
pitch!uncertainty!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
pitch!uncertainty!
\emph on
a-
\emph default
frame
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch!uncertainty
\end_layout

\end_inset

standard uncertainty in pitch and roll in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\emph on
l-
\emph default
frame, and this then leads to similar standard uncertainty in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
reference frame!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\emph on
a-
\emph default
frame for the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
smoothing
\end_layout

\end_inset

smoothed 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!pitch!smoothed
\end_layout

\end_inset

error estimates, as shown in Fig.
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:a-frame-errors}
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
function!CorrectPitch
\end_layout

\end_inset

.
 The mean standard deviation obtained in this way is 0.01
\begin_inset Formula $^{\circ}$
\end_inset

 for both pitch and roll in either the 
\emph on
a-
\emph default
frame or 
\emph on
l-
\emph default
frame, so this is reasonable estimate of the uncertainty after correction
 using the Kalman filter.
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
op <- par (mar=c(2,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout
layout(matrix(1:2, ncol = 1), widths = 1,  heights = c(5,6))
\end_layout

\begin_layout Plain Layout
with(D1[r, ], plotWAC(data.frame(Time, CPL, CPLF), col=c('blue', 'red'),
 
\end_layout

\begin_layout Plain Layout
                        lwd=c(1,2), ylim=c(-0.05,0.05), ylab='
\emph on
l-
\emph default
frame pitch error'))
\end_layout

\begin_layout Plain Layout
for (k in seq(1, length(r), 120)) {lines(c(D1$Time[r[k]], D1$Time[r[k]]),
 
\end_layout

\begin_layout Plain Layout
        c(D1$CPLF[r[k]]+D1$SDCPL[r[k]], D1$CPLF[r[k]]-D1$SDCPL[r[k]]), 
\end_layout

\begin_layout Plain Layout
        lwd=0.7, col='black')}
\end_layout

\begin_layout Plain Layout
op <- par (mar=c(5,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout
with(D1[r, ], plotWAC(data.frame(Time, CRL, CRLF), col=c('blue', 'red'),
 
\end_layout

\begin_layout Plain Layout
                        lwd=c(1,2), ylim=c(-0.05,0.05), ylab='
\emph on
l-
\emph default
frame roll error'))
\end_layout

\begin_layout Plain Layout
for (k in seq(10, length(r), 120)) {lines(c(D1$Time[r[k]], D1$Time[r[k]]),
 
\end_layout

\begin_layout Plain Layout
        c(D1$CRLF[r[k]]+D1$SDCRL[r[k]], D1$CRLF[r[k]]-D1$SDCRL[r[k]]), 
\end_layout

\begin_layout Plain Layout
        lwd=0.7, col='black')}
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout
PC <- CorrectPitch(D1, .span=901)
\end_layout

\begin_layout Plain Layout
D1$PC <- PC[, 1]
\end_layout

\begin_layout Plain Layout
D1$RC <- PC[, 2]
\end_layout

\begin_layout Plain Layout
op <- par (mar=c(2,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout
with(D1[r, ], plotWAC(data.frame(Time, CPAF, PC), col=c('blue', 'red'), 
\end_layout

\begin_layout Plain Layout
                        lwd=c(1,2), lty=c(1,2), ylim=c(-0.05,0.05), ylab='
\emph on
a-
\emph default
frame pitch error'))
\end_layout

\begin_layout Plain Layout
for (k in seq(10, length(r), 120)) {lines(c(D1$Time[r[k]], D1$Time[r[k]]),
 
\end_layout

\begin_layout Plain Layout
        c(D1$CPAF[r[k]]+D1$SDCPA[r[k]], D1$CPAF[r[k]]-D1$SDCPA[r[k]]), 
\end_layout

\begin_layout Plain Layout
        lwd=0.7, col='black')}
\end_layout

\begin_layout Plain Layout
op <- par (mar=c(5,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout
with(D1[r, ], plotWAC(data.frame(Time, CRAF, RC), col=c('blue', 'red'), 
\end_layout

\begin_layout Plain Layout
                        lwd=c(1,2), lty=c(1,2), ylim=c(-0.05,0.05), ylab='
\emph on
a-
\emph default
frame roll error'))
\end_layout

\begin_layout Plain Layout
for (k in seq(10, length(r), 120)) {lines(c(D1$Time[r[k]], D1$Time[r[k]]),
 
\end_layout

\begin_layout Plain Layout
        c(D1$CRAF[r[k]]+D1$SDCRA[r[k]], D1$CRAF[r[k]]-D1$SDCRA[r[k]]), 
\end_layout

\begin_layout Plain Layout
        lwd=0.7, col='black')}
\end_layout

\begin_layout Plain Layout
op <- par (mfrow=c(1,1), mar=c(5,5,2,2)+0.1)  # reset
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout
# VC7 <- (cos(.hdg)^2*VCor[, 7] + sin (.hdg)^2*VCor[,8])
\end_layout

\begin_layout Plain Layout
# VC7[VC7 < 0.000006] <- 0.000006
\end_layout

\begin_layout Plain Layout
# SP <- smooth.spline(D1$Time[r], D1$CPL[r], w=1/VC7[r], spar=0.7)
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Heading
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<flight-track, include=TRUE, fig.height=3, fig.width=4, fig.scap="The flight
 track of about 7 h duration for DEEPWAVE flight 16, 4 July 2012.", fig.cap="The
 flight track of about 7 h duration for DEEPWAVE flight 16, 4 July 2012.
 In the Kalman filter, the many turns provide constraints on the heading.
 The dashed-line topography shows the South Island of New Zealand.", cache=CACHE>
>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

plotTrack(getNetCDF(fname), .Spacing=NA)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<plot-Kalman-heading, include=TRUE, fig.height=6, fig.scap="Heading error
 estimated from Eqn.
\backslash

\backslash
 15 (top), and the results from the Kalman filter and a simplified estimate
 of the error in heading (bottom).", fig.cap="(top) Heading error estimated
 from (15), for only those periods of DEEPWAVE flight 16 where the horizontal
 acceleration is larger than 1
\backslash

\backslash
 m
\backslash

\backslash
,s$^{-2}$.
 (bottom) Heading correction from the Kalman filter and from Ranadu::CorrectHead
ing (HC, green line).
 The results from the Kalman filter are plotted as dotted where the estimated
 standard deviation exceeds 0.02$^{
\backslash

\backslash
circ}$ and as a thick solid line otherwise.
 A spline representing the smoothed heading correction from the Kalman filter,
 using the inverse of the estimated variance as weight factor for the spline,
 is shown as the red line.
 Data from DEEPWAVE flight 16.", cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

DP$dP <- DP$deltaPsi/Cradeg
\end_layout

\begin_layout Plain Layout

HA <- with(DP, sqrt(LACCX^2+LACCY^2))
\end_layout

\begin_layout Plain Layout

DP$dP[HA < 1] <- NA
\end_layout

\begin_layout Plain Layout

# plotWAC(subset(DP,,c(Time, dP)))
\end_layout

\begin_layout Plain Layout

grid.newpage()
\end_layout

\begin_layout Plain Layout

suppressWarnings (
\end_layout

\begin_layout Plain Layout

  with(DP,
\end_layout

\begin_layout Plain Layout

       ggplotWAC (data.frame(Time, dP),
\end_layout

\begin_layout Plain Layout

                  ylim=c(-0.4,0.4),
\end_layout

\begin_layout Plain Layout

                  ylab=expression (paste ('error in heading [',degree,']')),
\end_layout

\begin_layout Plain Layout

                  legend.position=NA, position=c(2,2), theme.version=1
\end_layout

\begin_layout Plain Layout

       )
\end_layout

\begin_layout Plain Layout

  )
\end_layout

\begin_layout Plain Layout

)
\end_layout

\begin_layout Plain Layout

# sddP <- sd(DP$dP, na.rm=TRUE)
\end_layout

\begin_layout Plain Layout

DP$SDH <- sqrt(VCor[r,9]) / (Cradeg * 30)
\end_layout

\begin_layout Plain Layout

DP$CCTHDG <- SmoothInterp (DP$CTHDG, .Length=181)
\end_layout

\begin_layout Plain Layout

DP$CCCTHDG <- DP$CCTHDG
\end_layout

\begin_layout Plain Layout

DP$CCCTHDG[DP$SDH > 0.02] <- NA
\end_layout

\begin_layout Plain Layout

suppressWarnings (
\end_layout

\begin_layout Plain Layout

  with (DP,
\end_layout

\begin_layout Plain Layout

    ggplotWAC(data.frame(Time, 'Kalman'=CCTHDG, 'Ranadu'=HC, 'spline'=HCS,
 'KF'=CCCTHDG), 
\end_layout

\begin_layout Plain Layout

      ylim=c(-0.4,0.4), lwd=c(0.7,1,1,1.5), lty=c(3,1,1,1),
\end_layout

\begin_layout Plain Layout

      ylab=expression (paste ('error in heading [',degree,']')),
\end_layout

\begin_layout Plain Layout

      col=c('blue', 'forestgreen', 'red', 'blue'), position=c(1,2),
\end_layout

\begin_layout Plain Layout

      legend.position=c(0.5,0.95), theme.version=1
\end_layout

\begin_layout Plain Layout

    )
\end_layout

\begin_layout Plain Layout

  )
\end_layout

\begin_layout Plain Layout

)
\end_layout

\begin_layout Plain Layout

# plotWAC(subset(DP,, c(Time, CCTHDG, HC)), ylim=c(-0.4,0.4), 
\end_layout

\begin_layout Plain Layout

#         lwd=0.7, legend.position='topright')
\end_layout

\begin_layout Plain Layout

# iv <- HE > 0.0012    # 0.0025
\end_layout

\begin_layout Plain Layout

# D1$CCTHDG[iv] <- NA
\end_layout

\begin_layout Plain Layout

# lineWAC(D1$Time, D1$CCTHDG, lwd=3, col='blue')
\end_layout

\begin_layout Plain Layout

# lineWAC(D1$Time, D1$HCS, col='red')
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!Kalman filter results
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!results!heading
\end_layout

\end_inset

The error in heading is more difficult to determine because, for most flight
 conditions, the heading is poorly constrained and as a result the estimated
 error in heading often has large uncertainty.
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!correction!uncertainty
\end_layout

\end_inset

 The flight path for the particular flight used for this example included
 frequent changes in flight direction, as shown in 
\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset

Fig.
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:flight-track}
\end_layout

\end_inset

, so those turns result in accelerations that can constrain the heading
 at times spaced throughout during the flight.
 In Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:heading-error"

\end_inset

, it was argued that (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:estimator-equation"

\end_inset

) provides an estimate of the error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading
\end_layout

\end_inset

 in heading.
 However, for the full flight (excluding initial climb and final descent)
 the mean value provided by this formula was 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(mean(D1$deltaPsi[r], na.rm=TRUE)/Cradeg, 3)}
\end_layout

\end_inset


\begin_inset Formula $^{\circ}$
\end_inset

 but the standard deviation of the correction provided by this equation
 was 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(sd(D1$deltaPsi[r], na.rm=TRUE)/Cradeg, 3)}
\end_layout

\end_inset


\begin_inset Formula $^{\circ}$
\end_inset

, so using this correction throughout the flight would introduce unrealistic
 corrections with large uncertainty.
 To avoid the noise
\begin_inset Index idx
status open

\begin_layout Plain Layout
noise!in heading correction
\end_layout

\end_inset

 this would introduce, the estimated error can be considered valid only
 when horizontal accelerations are large.
 The top panel in 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading
\end_layout

\end_inset

Figure
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:plot-Kalman-heading}
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!horizontal!required magnitude
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!heading correction
\end_layout

\end_inset

 shows the values from (
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:estimator-equation"

\end_inset

) for those times when the horizontal acceleration was more than 1
\begin_inset space ~
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-2}$
\end_inset

.
 The mean value of 
\begin_inset Formula $\delta\psi$
\end_inset

 for these periods was smaller than 0.001
\begin_inset Formula $^{\circ}$
\end_inset

 and the standard deviation of the 4295 values was 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(sddP, 2)}
\end_layout

\end_inset

.
 This indicates that the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!correction!uncertainty
\end_layout

\end_inset

uncertainty in the average error in heading
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!uncertainty
\end_layout

\end_inset

 is smaller than 0.01
\begin_inset Formula $^{\circ}$
\end_inset

 when the average is calculated for the entire flight.
 
\end_layout

\begin_layout Standard
The heading error
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!correction
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
correction!heading|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

error!heading!correction
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

 from the Kalman filter
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!results!heading
\end_layout

\end_inset

 is shown as the blue line in the bottom panel of Fig.
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:plot-Kalman-heading}
\end_layout

\end_inset

.
 The estimate of error usually has large uncertainty as estimated from the
 covariance estimate from the Kalman filter.
 As in the top panel, the regions of low uncertainty are confined to the
 turns where horizontal accelerations are significant.
 To avoid large corrections with high uncertainty, a 
\begin_inset Index idx
status open

\begin_layout Plain Layout
smoothing
\end_layout

\end_inset

smoothing spline
\begin_inset Foot
status open

\begin_layout Plain Layout
The 
\begin_inset Quotes eld
\end_inset

smooth.spline()
\begin_inset Quotes erd
\end_inset

 function
\begin_inset Index idx
status open

\begin_layout Plain Layout
function!spline
\end_layout

\end_inset

 provided by the 
\begin_inset Quotes eld
\end_inset

stats
\begin_inset Quotes erd
\end_inset

 
\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!package!stats
\end_layout

\end_inset

package in R 
\begin_inset CommandInset citation
LatexCommand citet
key "Rlanguage"

\end_inset

 was used, with parameter 
\begin_inset Quotes eld
\end_inset

spar=1.1
\begin_inset Quotes erd
\end_inset

 to give strong smoothing.
\end_layout

\end_inset

 that uses weight 
\begin_inset Index idx
status open

\begin_layout Plain Layout
spline!weight factors
\end_layout

\end_inset

factors inversely proportional to the covariance leads to the red line in
 Fig.
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:plot-Kalman-heading}
\end_layout

\end_inset

, for which the mean 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!spline fit
\end_layout

\end_inset

error is 
\begin_inset Formula $<0.002^{\circ}$
\end_inset

 and the standard deviation
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!heading correction
\end_layout

\end_inset

 for individual 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!uncertainty
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!correction!uncertainty
\end_layout

\end_inset

measurements is about 0.02
\begin_inset Formula $^{\circ}$
\end_inset

.
 Another test of the heading error is provided by the correction algorithm
\begin_inset Index idx
status open

\begin_layout Plain Layout
algorithm!simplier!correct heading
\end_layout

\end_inset

 
\begin_inset Quotes eld
\end_inset

Ranadu::CorrectHeading()
\begin_inset Quotes erd
\end_inset

 from Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:CorrectHeading"

\end_inset

, which gives a mean and standard deviation of 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(mean(D1$HC[r], na.rm=TRUE),3)}
\end_layout

\end_inset


\begin_inset Formula $\pm$
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(sd(D1$HC[r], na.rm=TRUE),3)}
\end_layout

\end_inset

 as shown by the green line in the figure.
 Perhaps the best interpretation for this flight is that, within about 0.02
\begin_inset Formula $^{\circ}$
\end_inset

 uncertainty, there is no heading error.
 However, in general the spline fit representing the result from the Kalman
 filter appears to be the preferable correction to the heading.
\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
correction to heading!caution re use
\end_layout

\end_inset

The results reported by the INS are those that have been used during its
 internal 
\begin_inset Index idx
status open

\begin_layout Plain Layout
mechanization
\end_layout

\end_inset

mechanization to find, for example, the ground-speed
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset

 components and the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!
\emph on
l-
\emph default
frame
\end_layout

\end_inset


\emph on
l-
\emph default
frame accelerations.
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!imposed offset
\end_layout

\end_inset

 In processed data sets, it has been common to introduce adjustments
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!imposed offset
\end_layout

\end_inset

 to the heading or, less often, the pitch to improve the wind measurements
 during calibration
\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver!calibration
\end_layout

\end_inset

 maneuvers.
 It is particularly common to find an offset in 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!imposed offset
\end_layout

\end_inset

heading that was introduced to give better agreement for winds during reverse-he
ading maneuvers.
\begin_inset Index idx
status open

\begin_layout Plain Layout
maneuver!reverse heading
\end_layout

\end_inset

 However, it is difficult to separate an offset in sideslip from an offset
 in heading, as discussed in the NCAR Technical Note on uncertainty in wind
 measurements.
 It now appears that the offset often introduced to 
\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!offset
\end_layout

\end_inset

heading should have instead been an offset in sideslip.
 Because these offsets are introduced after the INS has performed its internal
 calculations, the Kalman filter has no mechanism for detecting that an
 offset has been introduced and will still produce estimates of heading
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!heading!effect of imposed offset
\end_layout

\end_inset

error applicable to the original measurements.
 It is therefore important to remove any ad hoc adjustments that have been
 introduced to heading or other INS-provided variables before applying the
 Kalman filter.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
clearpage
\end_layout

\end_inset


\end_layout

\begin_layout Section
New variables for wind
\begin_inset CommandInset label
LatexCommand label
name "sec:KF-variables"

\end_inset


\end_layout

\begin_layout Subsection
Calculating the wind
\begin_inset CommandInset label
LatexCommand label
name "subsec:KF-wind"

\end_inset


\end_layout

\begin_layout Subsubsection
The vertical wind
\begin_inset CommandInset label
LatexCommand label
name "subsec:KF-vertical-wind"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!**
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!vertical!**
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!results!new variables
\end_layout

\end_inset

The result of the Kalman filter is that new corrected 
\begin_inset Index idx
status open

\begin_layout Plain Layout
velocity of aircraft!**
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
pitch!**
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
heading!**
\end_layout

\end_inset

variables
\begin_inset Index idx
status open

\begin_layout Plain Layout
variables!new from Kalman filter
\end_layout

\end_inset

 {
\begin_inset Index var
status open

\begin_layout Plain Layout
LATKF: latitude, Kalman filter
\end_layout

\end_inset

LATKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
LONKF: longitude, Kalman filter
\end_layout

\end_inset

LONKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
ALTKF: altitude, Kalman filter
\end_layout

\end_inset

ALTKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
VEWKF: ground speed eastward, Kalman filter
\end_layout

\end_inset

VEWKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
VNSKF: ground speed northward, Kalman filter
\end_layout

\end_inset

VNSKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
ROCKF: rate of climb, Kalman filter
\end_layout

\end_inset

ROCKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
PITCHKF: pitch angle, Kalman filter
\end_layout

\end_inset

PITCHKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
ROLLKF: roll angle, Kalman filter
\end_layout

\end_inset

ROLLKF, and 
\begin_inset Index var
status open

\begin_layout Plain Layout
THDGKF: heading, Kalman filter
\end_layout

\end_inset

THDGKF} are available.
 These and the variables
\begin_inset Index idx
status open

\begin_layout Plain Layout
variables!standard|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

variable in data files
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

 {
\begin_inset Index var
status open

\begin_layout Plain Layout
TASX: airspeed, relative wind
\end_layout

\end_inset

TASX, 
\begin_inset Index var
status open

\begin_layout Plain Layout
ATTACK|see 
\begin_inset ERT
status open

\begin_layout Plain Layout

{
\end_layout

\end_inset

also AKRD
\begin_inset ERT
status open

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset

ATTACK, 
\begin_inset Index var
status open

\begin_layout Plain Layout
SSLIP: sideslip, radome
\end_layout

\end_inset

SSLIP}
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!TASX
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!ATTACK
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!SSLIP
\end_layout

\end_inset

 can be used in a new calculation of the vector wind.
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!calculation!Kalman-based
\end_layout

\end_inset

 For the vertical wind, the new variable PITCHKF should be superior to the
 original variable 
\begin_inset Index var
status open

\begin_layout Plain Layout
PITCH: pitch angle, INS
\end_layout

\end_inset

PITCH and should lead to some improvement.
 The other critical 
\begin_inset Index idx
status open

\begin_layout Plain Layout
rate of climb
\end_layout

\end_inset

measurement used to calculate vertical wind is the rate-of-climb of the
 aircraft, for which there are two options: 
\begin_inset Index idx
status open

\begin_layout Plain Layout
ROC=rate of climb
\end_layout

\end_inset

ROCKF
\begin_inset Index var
status open

\begin_layout Plain Layout
ROCKF: rate of climb, Kalman filter
\end_layout

\end_inset

 and 
\begin_inset Index var
status open

\begin_layout Plain Layout
GGVSPD: rate of climb, GPS
\end_layout

\end_inset

GGVSPD.
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!GGVSPD
\end_layout

\end_inset

 The former uses the accelerations
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!measurement
\end_layout

\end_inset

  from the INS
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

 and so should have the best 
\begin_inset Index idx
status open

\begin_layout Plain Layout
spectral characteristics!high frequency
\end_layout

\end_inset

high-frequency characteristics, although 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS receivers provide very good measurements now even at high frequency.
 The other difference between these two choices is that if 
\begin_inset Index var
status open

\begin_layout Plain Layout
GGVSPD: rate of climb, GPS
\end_layout

\end_inset

GGVSPD is used then a correction is needed for the separation
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS!antenna location
\end_layout

\end_inset

 of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system, GPS!antenna location
\end_layout

\end_inset

GPS antenna from the INS\SpecialChar endofsentence
 ROCKF is based on measurements from the INS, with
 slow updating to the GPS value through the Kalman filter, so it does not
 need such a correction.
\begin_inset Foot
status open

\begin_layout Plain Layout
An aspect of the corrected vertical wind that needs further investigation
 is the relative timing of measurements entering the calculation, especially
 the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!inertial
\end_layout

\end_inset

INS-provided variables PITCH and ACINS
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!ACINS
\end_layout

\end_inset

 as they might be offset from the vertical component of the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!relative
\end_layout

\end_inset

relative wind as determined from the airspeed
\begin_inset Index idx
status open

\begin_layout Plain Layout
airspeed
\end_layout

\end_inset

 (
\begin_inset Index var
status open

\begin_layout Plain Layout
TASX: airspeed, relative wind
\end_layout

\end_inset

TASX) and angle of attack (
\begin_inset Index var
status open

\begin_layout Plain Layout
AKRD: angle of attack, radome
\end_layout

\end_inset

AKRD).
\begin_inset Index idx
status open

\begin_layout Plain Layout
angle of attack
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!AKRD
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<wind-calculation, include=TRUE, cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# source ('chunks/wind-calculation.R')
\end_layout

\begin_layout Plain Layout

## wind-calculation.R
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## get the wind variables:
\end_layout

\begin_layout Plain Layout

DataW <- D1
\end_layout

\begin_layout Plain Layout

DataN <- WindProcessor (DataW)
\end_layout

\begin_layout Plain Layout

D1$WICC <- DataN$WIN
\end_layout

\begin_layout Plain Layout

D1$WDCC <- DataN$WDN
\end_layout

\begin_layout Plain Layout

D1$WSCC <- DataN$WSN
\end_layout

\begin_layout Plain Layout

DataW$PITCH <- D1$PITCHKF
\end_layout

\begin_layout Plain Layout

DataW$ROLL <- D1$ROLLKF
\end_layout

\begin_layout Plain Layout

DataW$THDG <- D1$THDGKF
\end_layout

\begin_layout Plain Layout

DataW$VEW <- D1$VEWKF
\end_layout

\begin_layout Plain Layout

DataW$VNS <- D1$VNSKF
\end_layout

\begin_layout Plain Layout

DataW$GGVSPD <- D1$ROCKF
\end_layout

\begin_layout Plain Layout

DataN <- WindProcessor(DataW, LG=0, CompF=FALSE)    ## suppress comp filter
 and GPS lever arm)
\end_layout

\begin_layout Plain Layout

D1$WDKF <- DataN$WDN
\end_layout

\begin_layout Plain Layout

D1$WSKF <- DataN$WSN
\end_layout

\begin_layout Plain Layout

D1$WIKF <- DataN$WIN
\end_layout

\begin_layout Plain Layout

## add longitudinal and lateral components analogous to UXC and VYC:
\end_layout

\begin_layout Plain Layout

.hdg <- D1$THDGKF * Cradeg
\end_layout

\begin_layout Plain Layout

.wd <- D1$WDKF * Cradeg + pi
\end_layout

\begin_layout Plain Layout

D1$UXKF <- D1$WSKF * (sin(.hdg)*sin(.wd) + cos(.hdg)*cos(.wd))
\end_layout

\begin_layout Plain Layout

.hdg <- .hdg - pi/2
\end_layout

\begin_layout Plain Layout

D1$VYKF <- D1$WSKF * (sin(.hdg)*sin(.wd) + cos(.hdg)*cos(.wd))
\end_layout

\begin_layout Plain Layout

DataW$GGVSPD <- D1[, VROC]
\end_layout

\begin_layout Plain Layout

DataN <- WindProcessor(DataW, CompF=FALSE)    ## suppress comp filter and
 GPS lever arm)
\end_layout

\begin_layout Plain Layout

D1$WIKFG <- DataN$WIN
\end_layout

\begin_layout Plain Layout

sdWIdif <- sd(D1$WIKF[r]-D1$WICC[r], na.rm=TRUE)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
Figure
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Variance-spectra-ROC"

\end_inset

 shows a comparison
\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!plot!variance spectra!Kalman filter
\end_layout

\end_inset

 of the variance spectra
\begin_inset Index idx
status open

\begin_layout Plain Layout
spectrum!variance
\end_layout

\end_inset

 from the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based value (
\begin_inset Index var
status open

\begin_layout Plain Layout
GGVSPD: rate of climb, GPS
\end_layout

\end_inset

GGVSPD) and the Kalman-filter 
\begin_inset Index idx
status open

\begin_layout Plain Layout
ROC=rate of climb
\end_layout

\end_inset

value (
\begin_inset Index var
status open

\begin_layout Plain Layout
ROCKF: rate of climb, Kalman filter
\end_layout

\end_inset

ROCKF).
 The spectra are nearly identical, but GGVSPD appears to have some 
\begin_inset Index idx
status open

\begin_layout Plain Layout
spectral characteristics!high frequency
\end_layout

\end_inset

high-frequency noise not present in ROCKF.
 At these high frequencies, both have contributions to the vertical wind
 that are insignificant in comparison to that from the relative 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!relative
\end_layout

\end_inset

wind (air motion relative to the aircraft), so it will make little difference
 which is used in wind calculations,
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!calculation
\end_layout

\end_inset

 but ROCKF is the preferred choice because high-frequency fluctuations in
 rate of climb are probably not present.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename ROCGGVSPDMEMPlot.png
	lyxscale 50
	width 85text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
caption[Variance spectra for the rate-of-climb measurements from the GPS
 receiver and the integrated INS-provided acceleration.]{
\backslash
index{spectrum!variance!rate of climb}Variance 
\backslash
index{spectrum!variance}spectra for the rate-of-climb 
\backslash
index{rate of climb!variance spectrum}measurements from the 
\backslash
index{navigation system!GPS}GPS receiver (GGVSPD) and the integrated INS-provide
d acceleration
\backslash
index{acceleration!vertical} adjusted to match the rate of climb required
 by the hydrostatic equation 
\backslash
index{ROC=rate of climb}(ROCKF).
 The thin red line shows the spectrum without smoothing for ROCKF; other
 lines have been smoothed in 50 bins in the logarithm of frequency.
 Data from a region with intense waves encountered during 
\backslash
index{DEEPWAVE research project}DEEPWAVE flight 16 on 4 July 2014 over New
 Zealand.
\backslash
label{fig:Variance-spectra-ROC}}
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset Index idx
status open

\begin_layout Plain Layout
spectrum!variance!rate of climb
\end_layout

\end_inset

Variance 
\begin_inset Index idx
status open

\begin_layout Plain Layout
spectrum!variance
\end_layout

\end_inset

spectra for the rate-of-climb 
\begin_inset Index idx
status open

\begin_layout Plain Layout
rate of climb!variance spectrum
\end_layout

\end_inset

measurements from the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS receiver (GGVSPD) and the integrated INS acceleration
\begin_inset Index idx
status open

\begin_layout Plain Layout
acceleration!vertical
\end_layout

\end_inset

 adjusted to match the rate of climb required by the hydrostatic equation
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
ROC=rate of climb
\end_layout

\end_inset

(ROCKF).
 The thin red line shows the spectrum without smoothing for ROCKF; other
 lines have been smoothed in 50 bins in the logarithm of frequency.
 Data from a region with intense waves encountered during 
\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset

DEEPWAVE flight 16 on 4 July 2014 over New Zealand.
\begin_inset CommandInset label
LatexCommand label
name "fig:Variance-spectra-ROC"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Variance 
\begin_inset Index idx
status open

\begin_layout Plain Layout
spectrum!variance
\end_layout

\end_inset

spectra for the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!vertical!variance spectrum
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!vertical!variance spectrum
\end_layout

\end_inset

measurements of vertical wind for the same flight segment are shown in 
\begin_inset Index var
status open

\begin_layout Plain Layout
WIC: vertical wind, GPS corrected
\end_layout

\end_inset


\begin_inset Index var
status open

\begin_layout Plain Layout
WIKF: vertical wind, Kalman filter
\end_layout

\end_inset

Fig.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Variance-spectra-WI"

\end_inset

.
 There are small but significant differences, particularly for frequencies
 around 0.1
\begin_inset space ~
\end_inset

Hz where the rate of climb makes an important contribution to the measurement
 of vertical wind.
 (At higher frequencies, the relative wind makes the dominating contribution;
 at lower frequencies, the aircraft is controlled to maintain altitude so
 again the relative wind is dominant.)
\begin_inset Index idx
status open

\begin_layout Plain Layout
ROC=rate of climb
\end_layout

\end_inset

ROCKF
\begin_inset Index var
status open

\begin_layout Plain Layout
ROCKF: rate of climb, Kalman filter
\end_layout

\end_inset


\begin_inset Index var
status open

\begin_layout Plain Layout
GGVSPD: rate of climb, GPS
\end_layout

\end_inset


\begin_inset Index var
status open

\begin_layout Plain Layout
ACINS: vertical acceleration, INS
\end_layout

\end_inset

ACINS)
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!ACINS
\end_layout

\end_inset

 A comparison of the two measurements of vertical wind is shown in 
\begin_inset Index idx
status open

\begin_layout Plain Layout
ROC=rate of climb
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset

Fig.
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:plot-WIC}
\end_layout

\end_inset

.
\begin_inset Index idx
status open

\begin_layout Plain Layout
comparison!plot!variance spectra!rate of climb
\end_layout

\end_inset

 While the two represent almost the same signal, the differences at any
 given time can be significant, as emphasized by the bottom panel in the
 figure.
 The standard deviation
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!velocity difference
\end_layout

\end_inset

 of the difference between measurements for the interval shown in this figure
 is 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
Sexpr{round(sd(D1$WIKF[r]-D1$WICC[r], na.rm=TRUE), 2)}
\end_layout

\end_inset


\begin_inset space ~
\end_inset

m/s
\begin_inset Note Note
status open

\begin_layout Plain Layout
, a value that can be reduced slightly (
\begin_inset Formula $<10$
\end_inset

%) by shifting the measurements in time.
 XXX
\end_layout

\end_inset

, so the difference is the same as the claimed uncertainty in measuried
 vertical wind.
 The evidence from Sect.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "subsec:Roll-and-pitch"

\end_inset

 indicates that the standard uncertainty in pitch has been reduced from
 an estimated error of 0.02
\begin_inset Formula $^{\circ}$
\end_inset

 to 0.01
\begin_inset Formula $^{\circ}$
\end_inset

.
 This is the dominant source of error in the measured vertical wind; its
 inclusion in the uncertainty estimate for vertical wind indicates reduction
 in the standard uncertainty from about 0.12
\begin_inset space ~
\end_inset

m/s to about 0.07
\begin_inset space ~
\end_inset

m/s.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename WIKFWICMEMPlot.png
	lyxscale 50
	width 85text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
caption[Variance spectra for two measurements of the vertical wind, WIKF
 as adjusted by the Kalman filter and WIC from conventional data processing.]{
\backslash
index{spectrum!variance!vertical wind}Variance 
\backslash
index{spectrum!variance}spectra for two 
\backslash
index{wind!vertical!variance spectrum}
\backslash
index{wind!vertical!variance spectrum}measurements of the vertical 
\backslash
index{wind!vertical!Kalman filter}wind, WIKF as adjusted by the Kalman filter
 and WIC from conventional data processing.
\backslash
index{data processing!conventional} The thin red line shows the spectrum
 without smoothing for WIKF; other lines have been smoothed in 50 logarithmic
 frequency bins.
 Measurements from a region where intense waves were encountered during
 
\backslash
index{DEEPWAVE research project}DEEPWAVE flight 16, 4 July 2014.
 
\backslash
label{fig:Variance-spectra-WI}} 
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset Index idx
status open

\begin_layout Plain Layout
spectrum!variance!vertical wind
\end_layout

\end_inset

Variance 
\begin_inset Index idx
status open

\begin_layout Plain Layout
spectrum!variance
\end_layout

\end_inset

spectra for two 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!vertical!variance spectrum
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!vertical!variance spectrum
\end_layout

\end_inset

measurements of the vertical 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!vertical!Kalman filter
\end_layout

\end_inset

wind, WIKF as adjusted by the Kalman-filter and WIC from conventional data
 processing.
\begin_inset Index idx
status open

\begin_layout Plain Layout
data processing!conventional
\end_layout

\end_inset

 The thin red line shows the spectrum without smoothing for WIKF; other
 lines have been smoothed in 50 logarithmic frequency bins.
 Measurements from a region where intense waves were encountered during
 
\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset

DEEPWAVE flight 16, 4 July 2014.
 
\begin_inset CommandInset label
LatexCommand label
name "fig:Variance-spectra-WI"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
 [XXX consider pitch maneuvers and what minimizes the error.]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<plot-WIC, include=TRUE, fig.scap="Vertical wind calculated using the results
 from the Kalman filter, compared to the original calculation before Kalman-filt
er correction.", fig.cap='Vertical wind calculated using the results from
 the Kalman filter, compared to the original calculation before Kalman-filter
 correction.
 The difference is shown in the bottom panel.
 The result labeled "Kalman" is calculated using ROCKF and other results
 after correction by the Kalman filter, while WIC was calculated using GGVSPD
 from the GPS for the rate-of-climb of the aircraft.
 Data from a segment of DEEPWAVE flight 16 where intense waves were encountered.'
, cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# layout(matrix(1:2, ncol = 1), widths = 1,  heights = c(5,6))
\end_layout

\begin_layout Plain Layout

# op <- par (mar=c(2,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout

# with(D1[setRange(D1, 83400, 83800),], plotWAC (data.frame(Time, WIKF, WICC),
\end_layout

\begin_layout Plain Layout

#                                                    legend.position=NA))
\end_layout

\begin_layout Plain Layout

# legend ('bottomleft', legend=c('WIKF', 'WIC'), col=c('blue', 'darkgreen'),
 lwd=c(2,1), cex=0.8)
\end_layout

\begin_layout Plain Layout

# op <- par (mar=c(5,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout

# with(D1[setRange(D1, 83400, 83800),], plotWAC (data.frame(Time, WIKF-WICC),
 ylab='WIKF-WIC'))
\end_layout

\begin_layout Plain Layout

# op <- par (mfrow=c(1,1), mar=c(5,5,2,2)+0.1)  # reset
\end_layout

\begin_layout Plain Layout

ggplotWAC(
\end_layout

\begin_layout Plain Layout

  with(D1[setRange(D1, 83400, 83800), ], 
\end_layout

\begin_layout Plain Layout

       data.frame (Time, 'Kalman'=WIKF, 'original'=WICC, "DWI"=WIKF-WICC,
 'SKIP'=WIKF*0)),
\end_layout

\begin_layout Plain Layout

       col=c('blue', 'red'), lwd=c(1.4,0.8,1,0), lty=c(1,42),
\end_layout

\begin_layout Plain Layout

       ylab=expression(paste('vertical wind [m ', s^-1, ']')),
\end_layout

\begin_layout Plain Layout

       panels=2,
\end_layout

\begin_layout Plain Layout

       labelL=c('Kalman', 'original'),
\end_layout

\begin_layout Plain Layout

       labelP=c('variables', 'difference'),
\end_layout

\begin_layout Plain Layout

       legend.position=c(0.8,0.94), theme.version=1
\end_layout

\begin_layout Plain Layout

)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
The horizontal wind
\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!**
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!Kalman filter
\end_layout

\end_inset

The conventional measurements
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!measurement!conventional
\end_layout

\end_inset

 of horizontal wind, provided by the direction 
\begin_inset Index var
status open

\begin_layout Plain Layout
WDC: wind direction, GPS corrected
\end_layout

\end_inset

WDC and speed 
\begin_inset Index var
status open

\begin_layout Plain Layout
WSC: wind speed, GPS corrected
\end_layout

\end_inset

WSC, are based on the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!relative
\end_layout

\end_inset

relative wind added to the ground-speed
\begin_inset Index idx
status open

\begin_layout Plain Layout
ground speed
\end_layout

\end_inset

 components 
\begin_inset Index var
status open

\begin_layout Plain Layout
VEWC: ground speed eastward, GPS corrected
\end_layout

\end_inset

VEWC
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!VEWC
\end_layout

\end_inset

 and 
\begin_inset Index var
status open

\begin_layout Plain Layout
VNSC: ground speed northward, GPS corrected
\end_layout

\end_inset

VNSC.
\begin_inset Index idx
status open

\begin_layout Plain Layout
variable in data files!VNSC
\end_layout

\end_inset

 These are adjusted in standard data processing to match the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based measurements via a complementary filter
\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!complementary
\end_layout

\end_inset

 that uses the slowly varying components from the GPS and the faster varying
 components from the INS (
\begin_inset CommandInset citation
LatexCommand citet
key "Cooper2016ncartn"

\end_inset

).
 This complementary filter therefore should produce results quite similar
 to the variables VEWKF
\begin_inset Index var
status open

\begin_layout Plain Layout
VEWKF: ground speed eastward, Kalman filter
\end_layout

\end_inset

 and 
\begin_inset Index var
status open

\begin_layout Plain Layout
VNSKF: ground speed northward, Kalman filter
\end_layout

\end_inset

VNSKF from the Kalman filter.
 For the example flight being used (
\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset

DEEPWAVE flight 16), the standard deviation
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!difference in wind
\end_layout

\end_inset

 of the difference between the corrected measurements and the complementary-filt
er results is 0.1
\begin_inset space ~
\end_inset

m/s and the mean difference is 
\begin_inset Formula $<0.0001$
\end_inset


\begin_inset space ~
\end_inset

m/s, so these are in very good agreement.
 These differences are plotted in Fig.
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:hw-plot}
\end_layout

\end_inset

.
 The resulting measurements of horizontal wind direction match with a standard
 deviation of 0.3
\begin_inset Formula $^{\circ}$
\end_inset

 and the magnitudes of the horizontal winds match with a standard deviation
 of 0.1
\begin_inset space ~
\end_inset

m/s.
 In both variables the differences show a Schuler oscillation.
\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!centered
\end_layout

\end_inset

 
\begin_inset Index idx
status open

\begin_layout Plain Layout
filter!recursive
\end_layout

\end_inset

 The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!calculation!standard
\end_layout

\end_inset

complementary filter uses a recursive filter that leaves a small residual
 from the Schuler oscillation, so the corrected result from the Kalman filter
 is preferable.
 The plot also shows some larger fluctuations in turns that likely point
 to residual timing differences among the components entering the calculation
 of the wind.
 The difference in heading between the two measurements also would affect
 the measured horizontal 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!measurement
\end_layout

\end_inset

wind, but in this case the heading correction is small and slowly varying
 so it will have little effect on the results.
\begin_inset Foot
status open

\begin_layout Plain Layout
The heading-change correction needed to account for the separation 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS!antenna location
\end_layout

\end_inset

between the INS and 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system, GPS!antenna location
\end_layout

\end_inset

GPS antenna has little effect on the horizontal wind because both the Kalman
 filter and the complementary filter smooth any short-term contributions
 to the GPS-based measurements.
 For completeness, however, the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
navigation system!GPS
\end_layout

\end_inset

GPS-based 
\begin_inset Index idx
status open

\begin_layout Plain Layout
measurement!from GPS!correction to
\end_layout

\end_inset

measurements 
\begin_inset Index var
status open

\begin_layout Plain Layout
GGVEW: ground speed eastward, GPS
\end_layout

\end_inset

GGVEW and 
\begin_inset Index var
status open

\begin_layout Plain Layout
GGVNS: ground speed northward, GPS
\end_layout

\end_inset

GGVNS have been corrected for the effect of heading change before use in
 the Kalman filter or the complementary filter.
\end_layout

\end_inset

 
\end_layout

\begin_layout Standard
Despite these small differences, representative 
\begin_inset Index idx
status open

\begin_layout Plain Layout
spectrum!variance
\end_layout

\end_inset

variance spectra
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!variance spectrum
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
spectrum!variance!horizontal wind
\end_layout

\end_inset

 for the longitudinal and lateral wind
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!lateral
\end_layout

\end_inset

 overlap in plots so well that the spectra are indistinguishable.
 An example is shown in Fig.
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Variance-spectra-UXVY"

\end_inset

.
\begin_inset Index var
status open

\begin_layout Plain Layout
UXKF: longitudinal wind, Kalman filter
\end_layout

\end_inset


\begin_inset Index var
status open

\begin_layout Plain Layout
VYKF: lateral wind, Kalman filter
\end_layout

\end_inset


\begin_inset Index var
status open

\begin_layout Plain Layout
VYC: lateral wind, GPS corrected
\end_layout

\end_inset


\begin_inset Index var
status open

\begin_layout Plain Layout
UXC: longitudinal wind, GPS corrected
\end_layout

\end_inset

 Nevertheless, Fig.
\begin_inset space ~
\end_inset


\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
ref{fig:hw-plot}
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!measurement!conventional
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!Kalman filter
\end_layout

\end_inset

 and the standard deviations
\begin_inset Index idx
status open

\begin_layout Plain Layout
deviation, standard!difference in wind
\end_layout

\end_inset

 quoted above indicate that there are significant differences and that the
 Kalman-filter reduces 
\begin_inset Index idx
status open

\begin_layout Plain Layout
error!wind, effect of Kalman filter
\end_layout

\end_inset

errors in the horizontal wind by an amount that is significant in comparison
 to the estimated uncertainty.
 The reduction in uncertainty arises from the reduced uncertainty in heading,
 from about 0.10
\begin_inset Formula $^{\circ}$
\end_inset

 to about 0.01
\begin_inset Formula $^{\circ}$
\end_inset

, leaves heading as an insignificant source of uncertainty in the lateral
 component of the horizontal wind and reduces the standard uncertainty from
 0.44
\begin_inset space ~
\end_inset

m/s to 0.22
\begin_inset space ~
\end_inset

m/s, using the elemental contributions to uncertainty in 
\begin_inset CommandInset citation
LatexCommand citet
key "Cooper2016ncartn"

\end_inset

, Table 8 and the summary in that reference on p.
\begin_inset space ~
\end_inset

51.
 The remaining uncertainty is now dominated by the uncertainty in meassurement
 of sideslip, and recent studies of the sideslip using a laser air-motion
 sensor suggest that there is still opportunity to improve that measurement
 also.
\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<GS-comparison, include=FALSE, eval=FALSE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

DT <- getNetCDF (fname, c('VEWC', 'VNSC'))
\end_layout

\begin_layout Plain Layout

D1$VEWC <- DT$VEWC
\end_layout

\begin_layout Plain Layout

D1$VNSC <- DT$VNSC
\end_layout

\begin_layout Plain Layout

layout(matrix(1:2, ncol = 1), widths = 1,  heights = c(5,6))
\end_layout

\begin_layout Plain Layout

op <- par (mar=c(2,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout

with(D1[r,], plotWAC (data.frame(Time, VEWKF-GGVEW)))
\end_layout

\begin_layout Plain Layout

op <- par (mar=c(5,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout

with(D1[r,], plotWAC (data.frame(Time, VNSKF-GGVNS)))
\end_layout

\begin_layout Plain Layout

op <- par (mfrow=c(1,1), mar=c(5,5,2,2)+0.1)  # reset
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<hw-plot, include=TRUE, fig.scap="Differences between the conventional measureme
nts of horizontal wind and the results from the Kalman filter.", fig.cap='Differen
ces between the conventional measurements of horizontal wind (variables
 WDC and WSC) and the results from the Kalman filter (variables WDKF and
 WSKF).', cache=CACHE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# layout(matrix(1:2, ncol = 1), widths = 1,  heights = c(5,6))
\end_layout

\begin_layout Plain Layout

# op <- par (mar=c(2,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout

# with(D1[r,], plotWAC (data.frame(Time, WDKF-WDCC), ylab='WDKF-WDC'))
\end_layout

\begin_layout Plain Layout

# op <- par (mar=c(5,4,1,1)+0.1)
\end_layout

\begin_layout Plain Layout

# with(D1[r,], plotWAC (data.frame(Time, WSKF-WSCC), ylab='WSKF-WSC'))
\end_layout

\begin_layout Plain Layout

# op <- par (mfrow=c(1,1), mar=c(5,5,2,2)+0.1)  # reset
\end_layout

\begin_layout Plain Layout

ggplotWAC(
\end_layout

\begin_layout Plain Layout

  with(D1[r, ], 
\end_layout

\begin_layout Plain Layout

       data.frame (Time, 'direction'=WDKF-WDCC, 'speed'=WSKF-WSCC)),
\end_layout

\begin_layout Plain Layout

       ylab=expression(paste('KF correction [', degree, ' (top) or m ',
 s^-1, ' (bottom)]')),
\end_layout

\begin_layout Plain Layout

       panels=2,
\end_layout

\begin_layout Plain Layout

       labelL=c('Kalman correction'),
\end_layout

\begin_layout Plain Layout

       labelP=c('direction', 'speed'),
\end_layout

\begin_layout Plain Layout

       legend.position=c(0.8,0.94), theme.version=1
\end_layout

\begin_layout Plain Layout

)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename UXVYMEMPlot.png
	lyxscale 50
	width 85text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
caption[Variance spectra for the standard measurements of the longitudinal
 and lateral components of the horizontal wind and for the corresponding
 results after correction by the Kalman filter.]{
\backslash
index{spectrum!variance!horizontal wind}Variance 
\backslash
index{spectrum!variance}spectra for the standard variables UXC and VYC,
 which are measurements of the longitudinal and lateral components of the
 horizontal wind
\backslash
index{wind!lateral} relative to the orientation of the aircraft, and the
 corresponding results for the winds produced after correction by the Kalman
 filter (UXKF and VYKF).
 The thin red line shows the spectrum without smoothing for UXKF; the other
 lines have been smoothed in 50 logarithmic bins in frequency.
 Data are from 
\backslash
index{DEEPWAVE research project}DEEPWAVE flight 16, 4 July 2014, in waves
 over New Zealand.
\backslash
label{fig:Variance-spectra-UXVY}} 
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset Index idx
status open

\begin_layout Plain Layout
spectrum!variance!horizontal wind
\end_layout

\end_inset

Variance 
\begin_inset Index idx
status open

\begin_layout Plain Layout
spectrum!variance
\end_layout

\end_inset

spectra for the standard variables UXC and VYC, which are measurements of
 the longitudinal and lateral components of the horizontal wind
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!lateral
\end_layout

\end_inset

 relative to the orientation of the aircraft, and the corresponding results
 for the winds produced after the Kalman filter (UXKF and VYKF).
 The thin red line shows the spectrum without smoothing for UXKF; the other
 lines have been smoothed in 50 logarithmic bins in frequency.
 Data are from 
\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset

DEEPWAVE flight 16, 4 July 2014, in waves over New Zealand.
\begin_inset CommandInset label
LatexCommand label
name "fig:Variance-spectra-UXVY"

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<create-new-netcdf, cache=FALSE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# source ('chunks/create-new-netcdf.R')
\end_layout

\begin_layout Plain Layout

## create-new-netcdf.R
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

fnew <- sub ('.nc', 'KF.nc', fname)
\end_layout

\begin_layout Plain Layout

## beware: overwrites without warning!!
\end_layout

\begin_layout Plain Layout

Z <- file.copy (fname, fnew, overwrite=TRUE)  ## BEWARE: overwrites without
 warning!!
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# function to copy attributes from old variable (e.g., PITCH) to new one (e.g.,
 PITCHKF)
\end_layout

\begin_layout Plain Layout

copy_attributes <- function (atv, v, nfile) {
\end_layout

\begin_layout Plain Layout

  for (i in 1:length(atv)) {
\end_layout

\begin_layout Plain Layout

    aname <- names(atv[i])
\end_layout

\begin_layout Plain Layout

    if (grepl ('name', aname)) {next}  # skips long and standard names
\end_layout

\begin_layout Plain Layout

    if (grepl ('units', aname)) {next}
\end_layout

\begin_layout Plain Layout

    if (grepl ('Dependencies', aname)) {next}
\end_layout

\begin_layout Plain Layout

    if (grepl ('actual_range', aname)) {next}
\end_layout

\begin_layout Plain Layout

    if (is.numeric (atv[[i]])) {
\end_layout

\begin_layout Plain Layout

      ncatt_put (nfile, v, attname=aname, attval=as.numeric(atv[[i]]))
\end_layout

\begin_layout Plain Layout

    } else {
\end_layout

\begin_layout Plain Layout

      ncatt_put (nfile, v, attname=aname, attval=as.character (atv[[i]]))
\end_layout

\begin_layout Plain Layout

    }
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Adding the new variables to the netCDF file
\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
netCDF file
\end_layout

\end_inset

The code shown in the box that follows adds one variable to an existing
 newCDF 
\begin_inset Index idx
status open

\begin_layout Plain Layout
file!data
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
file!netCDF
\end_layout

\end_inset

file, renaming the resulting file with a name like PROJECTrf01KF.nc if the
 original file was PROJECTrf01.nc.
 This can serve as a 
\begin_inset Index idx
status open

\begin_layout Plain Layout
netCDF variable!model for new
\end_layout

\end_inset

model for adding such variables.
 See the 
\begin_inset Quotes eld
\end_inset

.Rnw
\begin_inset Quotes erd
\end_inset

 file
\begin_inset Index idx
status open

\begin_layout Plain Layout
program!file
\end_layout

\end_inset

 for the actual code, which has additional statements to protect against
 missing variables or substitute variables when some are missing and to
 handle high-rate data files.
 This example
\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!code to add variable!example
\end_layout

\end_inset

 is included to serve as a template for other scripts that might want to
 add variables to a netCDF file.
 The processing script 
\begin_inset Quotes eld
\end_inset

KalmanFilter.R
\begin_inset Quotes erd
\end_inset

 adds these variables in a similar way: 
\begin_inset Index var
status open

\begin_layout Plain Layout
LATKF: latitude, Kalman filter
\end_layout

\end_inset

LATKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
LONKF: longitude, Kalman filter
\end_layout

\end_inset

LONKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
ALTKF: altitude, Kalman filter
\end_layout

\end_inset

ALTKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
VEWKF: ground speed eastward, Kalman filter
\end_layout

\end_inset

VEWKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
VNSKF: ground speed northward, Kalman filter
\end_layout

\end_inset

VNSKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
ROCKF: rate of climb, Kalman filter
\end_layout

\end_inset

ROCKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
PITCHKF: pitch angle, Kalman filter
\end_layout

\end_inset

PITCHKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
ROLLKF: roll angle, Kalman filter
\end_layout

\end_inset

ROLLKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
THDGKF: heading, Kalman filter
\end_layout

\end_inset

THDGKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
WDKF: wind direction, Kalman filter
\end_layout

\end_inset

WDKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
WSKF: wind speed, Kalman filter
\end_layout

\end_inset

WSKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
WIKF: vertical wind, Kalman filter
\end_layout

\end_inset

WIKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
WICC: WIC recalculated
\end_layout

\end_inset

WICC, 
\begin_inset Index var
status open

\begin_layout Plain Layout
WDCC: WDC recalculated
\end_layout

\end_inset

WDCC, 
\begin_inset Index var
status open

\begin_layout Plain Layout
WSCC: WSC recalculated
\end_layout

\end_inset

WSCC, 
\begin_inset Index var
status open

\begin_layout Plain Layout
UXKF: longitudinal wind, Kalman filter
\end_layout

\end_inset

UXKF, 
\begin_inset Index var
status open

\begin_layout Plain Layout
VYKF: lateral wind, Kalman filter
\end_layout

\end_inset

VYKF.
 All ending in KF are the same as the original name without KF but after
 applying the correction from the Kalman filter.
 Three other variables ending in CC are those calculated in the standard
 way but with measurements from the GPS receiver corrected for the rotation
 of the aircraft, which was not included in the original processing.
 The table of variable names at the end of this technical note includes
 definitions for these and the other netCDF variables that have been used.
\end_layout

\begin_layout Subsubsection*
Example of code to add a variable:
\end_layout

\begin_layout LyX-Code

\family typewriter
\begin_inset Box Boxed
position "t"
hor_pos "c"
has_inner_box 1
inner_pos "t"
use_parbox 0
use_makebox 0
width "100col%"
special "none"
height "1in"
height_special "totalheight"
thickness "0.4pt"
separation "3pt"
shadowsize "4pt"
framecolor "black"
backgroundcolor "none"
status open

\begin_layout LyX-Code

\family typewriter
## get the old netCDF variables:
\end_layout

\begin_layout LyX-Code

\family typewriter
D <- getNetCDF (fname, VarList)    
\end_layout

\begin_layout LyX-Code

\family typewriter
## open the copy of the old file for writing:
\end_layout

\begin_layout LyX-Code

\family typewriter
netCDFfile <- nc_open (fnew, write=TRUE) 
\end_layout

\begin_layout LyX-Code

\family typewriter
Rate <- 1  ## the data rate of this file
\end_layout

\begin_layout LyX-Code

\family typewriter
## retrieve dimension info from the old file
\end_layout

\begin_layout LyX-Code

\family typewriter
Dimensions <- attr (D, "Dimensions")
\end_layout

\begin_layout LyX-Code

\family typewriter
Dim <- Dimensions[["Time"]]
\end_layout

\begin_layout LyX-Code

\end_layout

\begin_layout LyX-Code

\family typewriter
## variables to add to the netCDF file: (add more)
\end_layout

\begin_layout LyX-Code

\family typewriter
VarNew <- c("LATKF")   
\end_layout

\begin_layout LyX-Code

\family typewriter
VarOld <- c("LAT")
\end_layout

\begin_layout LyX-Code

\family typewriter
VarUnits <- c("degrees")
\end_layout

\begin_layout LyX-Code

\family typewriter
VarLongName <- c("latitude, KF")
\end_layout

\begin_layout LyX-Code

\family typewriter
VarStdName <- c("INS latitude, Kalman-filter-corrected")
\end_layout

\begin_layout LyX-Code

\end_layout

\begin_layout LyX-Code

\family typewriter
## create the new variables
\end_layout

\begin_layout LyX-Code

\family typewriter
varCDF <- list ()
\end_layout

\begin_layout LyX-Code

\family typewriter
for (i in 1:length(VarNew)) {  ## only one in this example
\end_layout

\begin_layout LyX-Code

\family typewriter
  ## create the new variable and add it to the netCDF file
\end_layout

\begin_layout LyX-Code

\family typewriter
  varCDF[[i]] <- ncvar_def (VarNew[i],  
\end_layout

\begin_layout LyX-Code

\family typewriter
                    units=VarUnits[i], 
\end_layout

\begin_layout LyX-Code

\family typewriter
                    dim=Dim, 
\end_layout

\begin_layout LyX-Code

\family typewriter
                    missval=as.single(-32767.), prec="float", 
\end_layout

\begin_layout LyX-Code

\family typewriter
                    longname=VarLongName[i])
\end_layout

\begin_layout LyX-Code

\family typewriter
  if (i == 1) {
\end_layout

\begin_layout LyX-Code

\family typewriter
    newfile <- ncvar_add (netCDFfile, varCDF[[i]])
\end_layout

\begin_layout LyX-Code

\family typewriter
  } else {
\end_layout

\begin_layout LyX-Code

\family typewriter
    newfile <- ncvar_add (newfile, varCDF[[i]])
\end_layout

\begin_layout LyX-Code

\family typewriter
  }
\end_layout

\begin_layout LyX-Code

\family typewriter
  ## transfer attributes from the old variable and add new ones
\end_layout

\begin_layout LyX-Code

\family typewriter
  ATV <- ncatt_get (netCDFfile, VarOld[i])
\end_layout

\begin_layout LyX-Code

\family typewriter
  copy_attributes (ATV, VarNew[i], newfile)
\end_layout

\begin_layout LyX-Code

\family typewriter
  ncatt_put (newfile, VarNew[i], attname="standard_name", 
\end_layout

\begin_layout LyX-Code

\family typewriter
             attval=VarStdName[i])
\end_layout

\begin_layout LyX-Code

\family typewriter
  ## add the measurements for the new variable
\end_layout

\begin_layout LyX-Code

\family typewriter
  ncvar_put (newfile, varCDF[[i]], D1[, VarNew[i]])
\end_layout

\begin_layout LyX-Code

\family typewriter
}
\end_layout

\begin_layout LyX-Code

\family typewriter
## then close to write the new file
\end_layout

\begin_layout LyX-Code

\family typewriter
nc_close (newfile)
\end_layout

\end_inset


\family default

\begin_inset Index idx
status open

\begin_layout Plain Layout
latitude!Kalman filter
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

<<modify-new-netcdf, include=TRUE>>=
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

# source ('chunks/modify-new-netcdf.R')
\end_layout

\begin_layout Plain Layout

## modify-new-netcdf.R
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## variables needed for attributes and new wind calculation:
\end_layout

\begin_layout Plain Layout

VarList <- c('TASX', 'ATTACK', 'SSLIP', 'GGVEW', 'GGVNS', VROC, 'VEW', 'VNS',
 'THDG', 'ROLL', 'PITCH',
\end_layout

\begin_layout Plain Layout

             'LAT', 'LON', 'VSPD')
\end_layout

\begin_layout Plain Layout

VarListRef <- VarList
\end_layout

\begin_layout Plain Layout

FI <- DataFileInfo (fname)
\end_layout

\begin_layout Plain Layout

VarList <- VarListRef
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

if (!('GGVSPD' %in% FI$Variables)) {
\end_layout

\begin_layout Plain Layout

  if ('GGVSPDB' %in% FI$Variables) {
\end_layout

\begin_layout Plain Layout

    VarList [which (VarList == 'GGVSPD')] <- 'GGVSPDB'
\end_layout

\begin_layout Plain Layout

  } else if ('VSPD_A' %in% FI$Variables) {
\end_layout

\begin_layout Plain Layout

    VarList [which (VarList == 'GGVSPD')] <- 'VSPD_A'
\end_layout

\begin_layout Plain Layout

  } else if ('VSPD_G' %in% FI$Variables) {
\end_layout

\begin_layout Plain Layout

    VarList [which (VarList == 'GGVSPD')] <- 'VSPD_G'
\end_layout

\begin_layout Plain Layout

  } else {
\end_layout

\begin_layout Plain Layout

    print ('ERROR: no VSPD variable found')
\end_layout

\begin_layout Plain Layout

    exit()
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

for (Var in VarList) {
\end_layout

\begin_layout Plain Layout

  if (!(Var %in% FI$Variables)) {
\end_layout

\begin_layout Plain Layout

    print (sprintf (' required variable %s not found in file %s; skipping...',
 Var, fname))
\end_layout

\begin_layout Plain Layout

    exit()
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

netCDFfile <- nc_open (fnew, write=TRUE) 
\end_layout

\begin_layout Plain Layout

Rate <- 1
\end_layout

\begin_layout Plain Layout

Dimensions <- attr (D1, "Dimensions")
\end_layout

\begin_layout Plain Layout

Dim <- Dimensions[["Time"]]
\end_layout

\begin_layout Plain Layout

if ("sps25" %in% names (Dimensions)) {
\end_layout

\begin_layout Plain Layout

  Rate <- 25
\end_layout

\begin_layout Plain Layout

  Dim <- list(Dimensions[["sps25"]], Dimensions[["Time"]])
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

if ("sps50" %in% names (Dimensions)) {
\end_layout

\begin_layout Plain Layout

  Rate <- 50
\end_layout

\begin_layout Plain Layout

  Dim <- list(Dimensions[["sps50"]], Dimensions[["Time"]])
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

DATT <- D1  ## save to ensure that attributes are preserved
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## variables to add to the netCDF file:
\end_layout

\begin_layout Plain Layout

VarNew <- c('LATKF', 'LONKF', 'ALTKF', 'VEWKF', 'VNSKF', 'ROCKF', 'PITCHKF',
 'ROLLKF', 'THDGKF',
\end_layout

\begin_layout Plain Layout

            'WDKF', 'WSKF', 'WIKF', 'WICC', 'WDCC', 'WSCC', 'UXKF', 'VYKF')
\end_layout

\begin_layout Plain Layout

VarOld <- c('LAT', 'LON', 'ALT', 'VEW', 'VNS', 'VSPD', 'PITCH', 'ROLL',
 'THDG', 
\end_layout

\begin_layout Plain Layout

            'WD', 'WS', 'WI', 'WIC', 'WDC', 'WSC', 'UXC', 'VYC')
\end_layout

\begin_layout Plain Layout

VarUnits <- c('degrees', 'degrees', 'm', 'm/s', 'm/s', 'm/s', 'degrees',
 'degrees', 'degrees',
\end_layout

\begin_layout Plain Layout

              'degrees', 'm/s', 'm/s', 'm/s', 'degrees', 'm/s', 'm/s', 'm/s')
\end_layout

\begin_layout Plain Layout

VarLongName <- c('latitude, KF', 'longitude, KF', 'altitude MSL, KF',
\end_layout

\begin_layout Plain Layout

                 'eastward groundspeed, KF', 'northward groundspeed, KF',
 'rate of climb, KF',
\end_layout

\begin_layout Plain Layout

                 'pitch, KF', 'roll, KF', 'heading, KF',
\end_layout

\begin_layout Plain Layout

                 'wind direction, KF', 'wind speed, KF', 'vertical wind,
 KF', 
\end_layout

\begin_layout Plain Layout

                 'vertical wind, KF and GGVSPD', 'WIC recalc', 'WDC recalc',
 'WSC recalc',
\end_layout

\begin_layout Plain Layout

                 'longitudinal wind, KF', 'lateral wind, KF')
\end_layout

\begin_layout Plain Layout

VarStdName <- c('INS latitude, Kalman-filter-corrected',
\end_layout

\begin_layout Plain Layout

                'INS longitude, Kalman-filter-corrected',
\end_layout

\begin_layout Plain Layout

                'INS altitude, Kalman-filter-corrected',
\end_layout

\begin_layout Plain Layout

                'INS eastward ground speed, Kalman-filter-corrected',
\end_layout

\begin_layout Plain Layout

                'INS northward ground speed, Kalman-filter-corrected',
\end_layout

\begin_layout Plain Layout

                'INS rate of climb, Kalman-filter-corrected',
\end_layout

\begin_layout Plain Layout

                'INS aircraft pitch angle, Kalman-filter-corrected',
\end_layout

\begin_layout Plain Layout

                'INS aircraft roll angle, Kalman-filter-corrected',
\end_layout

\begin_layout Plain Layout

                'INS aircraft true heading angle, Kalman-filter-corrected',
\end_layout

\begin_layout Plain Layout

                'horizontal wind direction, Kalman-filter-corrected',
\end_layout

\begin_layout Plain Layout

                'horizontal wind speed, Kalman-filter-corrected',
\end_layout

\begin_layout Plain Layout

                'vertical wind speed, Kalman-filter-corrected',
\end_layout

\begin_layout Plain Layout

                'original WIC, recalculated',
\end_layout

\begin_layout Plain Layout

                'original WDC, recalculated',
\end_layout

\begin_layout Plain Layout

                'original WSC, recalculated',
\end_layout

\begin_layout Plain Layout

                'longitudinal component of the horizontal wind, Kalman-filter-co
rrected',
\end_layout

\begin_layout Plain Layout

                'lateral component of the horizontal wind, Kalman-filter-correct
ed')
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

## create the new variables
\end_layout

\begin_layout Plain Layout

varCDF <- list ()
\end_layout

\begin_layout Plain Layout

for (i in 1:length(VarNew)) {
\end_layout

\begin_layout Plain Layout

  varCDF[[i]] <- ncvar_def (VarNew[i],  
\end_layout

\begin_layout Plain Layout

                            units=VarUnits[i], 
\end_layout

\begin_layout Plain Layout

                            dim=Dim, 
\end_layout

\begin_layout Plain Layout

                            missval=as.single(-32767.), prec='float', 
\end_layout

\begin_layout Plain Layout

                            longname=VarLongName[i])
\end_layout

\begin_layout Plain Layout

  if (i == 1) {
\end_layout

\begin_layout Plain Layout

    newfile <- ncvar_add (netCDFfile, varCDF[[i]])
\end_layout

\begin_layout Plain Layout

  } else {
\end_layout

\begin_layout Plain Layout

    newfile <- ncvar_add (newfile, varCDF[[i]])
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

  ATV <- ncatt_get (netCDFfile, VarOld[i])
\end_layout

\begin_layout Plain Layout

  copy_attributes (ATV, VarNew[i], newfile)
\end_layout

\begin_layout Plain Layout

  ncatt_put (newfile, VarNew[i], attname="standard_name", 
\end_layout

\begin_layout Plain Layout

             attval=VarStdName[i])
\end_layout

\begin_layout Plain Layout

  if (Rate == 1) {
\end_layout

\begin_layout Plain Layout

    ncvar_put (newfile, varCDF[[i]], D1[, VarNew[i]])
\end_layout

\begin_layout Plain Layout

  } else if (Rate == 25) {
\end_layout

\begin_layout Plain Layout

    ncvar_put (newfile, varCDF[[i]], D1[, VarNew[i]], count=c(25, nrow(D1)/25))
\end_layout

\begin_layout Plain Layout

  }
\end_layout

\begin_layout Plain Layout

}
\end_layout

\begin_layout Plain Layout

nc_close (newfile)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

@
\end_layout

\end_inset


\end_layout

\begin_layout Section
Summary and conclusions
\end_layout

\begin_layout Standard
An application of an 
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!error-state
\end_layout

\end_inset

error-state Kalman filter
\begin_inset Index idx
status open

\begin_layout Plain Layout
Kalman filter!primary value
\end_layout

\end_inset

 has been developed to improve the measurements of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
wind!**
\end_layout

\end_inset

wind provided by the NSF/NCAR GV
\begin_inset Index idx
status open

\begin_layout Plain Layout
aircraft!NSF/NCAR GV
\end_layout

\end_inset

 research aircraft.
 The primary advantage provided by the corrected measurements is 
\begin_inset Index idx
status open

\begin_layout Plain Layout
uncertainty!reduction in
\end_layout

\end_inset

reduction in the uncertainty associated with the measurements of pitch and
 heading, which without correction are the largest sources of uncertainty
 in the measurements.
 The corrected measurements reduce the standard uncertainty in measured
 vertical wind and the lateral component of the horizontal wind to about
 50% of their previous values, to about 0.07 and 0.22
\begin_inset space ~
\end_inset

m
\begin_inset space \thinspace{}
\end_inset

s
\begin_inset Formula $^{-1}$
\end_inset

.
 The Kalman filter has a much smaller effect on the longitudinal component
 of the horizontal wind because that uncertainty is determined mostly by
 elemental contributions from the measurement of airspeed and temperature,
 which are not affected by the Kalman filter, and only to a small extent
 by the ground speed which is measured well by GPS without the Kalman filter.
 The program that implements this procedure for correction of the measurements
 can be used with data archives from past projects as long as the measurements
 in those archived files include the aircraft velocity from INS and GPS
 sources and the INS-based attitude angles.
\end_layout

\begin_layout Section
\start_of_appendix
Appendix: Reproducibility
\end_layout

\begin_layout Standard
\begin_inset Index idx
status open

\begin_layout Plain Layout
reproducibility
\end_layout

\end_inset

This document is constructed in ways that support duplication of the study.
 The code that generates the plots and implements the Kalman filter is incorpora
ted into the same 
\begin_inset Index idx
status open

\begin_layout Plain Layout
program!file
\end_layout

\end_inset

file that generated this document via 
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
LaTeX
\end_layout

\end_inset

, using principles and techniques described by 
\begin_inset CommandInset citation
LatexCommand citet
key "Xie2014a"

\end_inset

 as implemented in the R 
\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!package!knitr
\end_layout

\end_inset

package
\begin_inset Index idx
status open

\begin_layout Plain Layout
knitr
\end_layout

\end_inset

 'knitr' (
\begin_inset CommandInset citation
LatexCommand citet
key "Xie2014b"

\end_inset

).
 The program, 'KalmanFilterTechNote.Rnw', is archived on 'GitHub' 
\begin_inset Index idx
status open

\begin_layout Plain Layout
GitHub repository
\end_layout

\end_inset

in the 
\begin_inset Index idx
status open

\begin_layout Plain Layout
repository!github
\end_layout

\end_inset

directory
\begin_inset Index idx
status open

\begin_layout Plain Layout
archive!for this document
\end_layout

\end_inset

 at 
\begin_inset CommandInset href
LatexCommand href
name "this URL"
target "https://github.com/WilliamCooper/KalmanFilterTechNote.git"

\end_inset

.
 There is some 
\begin_inset Index idx
status open

\begin_layout Plain Layout
supplemental material
\end_layout

\end_inset

supplemental material in that directory, including the workflow document
\begin_inset Index idx
status open

\begin_layout Plain Layout
workflow document
\end_layout

\end_inset

, the bibliography and many code segments saved in the 
\begin_inset Quotes eld
\end_inset

chunks
\begin_inset Quotes erd
\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!program chunks
\end_layout

\end_inset

 subdirectory, so the full directory should be downloaded in order to run
 the program.
 The calculations use the programming 
\begin_inset Index idx
status open

\begin_layout Plain Layout
R language
\end_layout

\end_inset

language 
\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!program
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
RStudio
\end_layout

\end_inset

R (
\begin_inset CommandInset citation
LatexCommand citet
key "Rlanguage"

\end_inset

) and were run within 
\begin_inset Index idx
status open

\begin_layout Plain Layout
RStudio
\end_layout

\end_inset

RStudio (
\begin_inset CommandInset citation
LatexCommand citet
key "RStudio2012"

\end_inset

), so this is the most straightforward way to replicate the calculations
 and the generation of this 
\begin_inset Index idx
status open

\begin_layout Plain Layout
program!generating this document
\end_layout

\end_inset

document.
\end_layout

\begin_layout Standard
A 
\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!package!Ranadu
\end_layout

\end_inset

package named Ranadu,
\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!package!Ranadu
\end_layout

\end_inset

 containing auxillary 
\begin_inset Index idx
status open

\begin_layout Plain Layout
function!Ranadu
\end_layout

\end_inset

functions, is used extensively in the R code.
 It is available on GitHub
\begin_inset Index idx
status open

\begin_layout Plain Layout
GitHub repository
\end_layout

\end_inset

 as 
\begin_inset CommandInset href
LatexCommand href
target "https://github.com/WilliamCooper/Ranadu.git"

\end_inset

.
 The version used for calculations in this technical note is included in
 the 'zip' archive listed below.
\end_layout

\begin_layout Standard
The 
\begin_inset Index idx
status open

\begin_layout Plain Layout
file!data
\end_layout

\end_inset

data files used are also preserved in the NCAR High Performance Storage
 System (HPSS)
\begin_inset Index idx
status open

\begin_layout Plain Layout
HPSS archives
\end_layout

\end_inset

 in files that are available, and they can be provided via a 
\begin_inset Index idx
status open

\begin_layout Plain Layout
data!requesting
\end_layout

\end_inset

request to 
\begin_inset Flex URL
status collapsed

\begin_layout Plain Layout

mailto:raf-dm@eol.ucar.edu
\end_layout

\end_inset

.
 The original files containing the data as produced by the NCAR Earth Observing
 Laboratory, Research Aviation Facility, were in 
\begin_inset Index idx
status open

\begin_layout Plain Layout
netCDF format
\end_layout

\end_inset

netCDF format (cf.
\begin_inset space ~
\end_inset


\begin_inset CommandInset href
LatexCommand href
name "this URL"
target "http://www.unidata.ucar.edu/software/netcdf/"

\end_inset

), but in many cases data archives were reprocessed and the files may change
 after reprocessing so a separate archive
\begin_inset Index idx
status open

\begin_layout Plain Layout
archive!for this document!data
\end_layout

\end_inset

 is maintained for this document.
 The data files
\begin_inset Index idx
status open

\begin_layout Plain Layout
file!data!archive
\end_layout

\end_inset

 in this archive contain 
\begin_inset Index idx
status open

\begin_layout Plain Layout
R language!data.frames
\end_layout

\end_inset

R data.frames and are preserved as binary-format 'Rdata' files via R 'save'
 commands.
 The code in the GitHub archive has appropriate 'load' commands to read
 these data files from a subdirectory named 'Data' (/Data or ~/Data or /home/Dat
a) but this is not part of the GitHub repository because it is too large
 to be appropriate there.
 To reproduce this research, those data files have to be transferred separately
 from the NCAR HPSS to the 'Data' 
\begin_inset Index idx
status open

\begin_layout Plain Layout
repository!data used
\end_layout

\end_inset

directory.
\end_layout

\begin_layout Standard
Extensive use has been made of 
\begin_inset Index idx
status open

\begin_layout Plain Layout
attributes!data.frame
\end_layout

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
attributes!variable
\end_layout

\end_inset

attributes assigned to the data.frames and the variables in those data.frames.
 All the attributes from the original netCDF 
\begin_inset Index idx
status open

\begin_layout Plain Layout
file!netCDF
\end_layout

\end_inset

files have been transferred, so there is a record of how the original data
 were processed, for example recording 
\begin_inset Index idx
status open

\begin_layout Plain Layout
calibration!coefficients!used in processing
\end_layout

\end_inset

calibration coefficients and processing chains for the variables.
 Once the data.frames are loaded into R, these attributes can be viewed and
 provide additional documentation of what data were used.
 Key information like the processing date, the program version that produced
 the archive, and the selection of primary variables for various measurements
 thus is preserved.
\end_layout

\begin_layout Standard
\begin_inset Tabular
<lyxtabular version="3" rows="6" columns="2">
<features tabularvalignment="middle">
<column alignment="left" valignment="top">
<column alignment="left" valignment="top">
<row>
<cell alignment="left" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family sans
\shape smallcaps
\color blue
Project:
\family default
\shape default
\color inherit
 
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
KalmanFilterTechNote
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="left" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family sans
\shape smallcaps
\color blue
Archive package:
\family default
\shape default
\color inherit
 
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
KalmanFilterTechNote.zip
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="left" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family sans
\shape smallcaps
\color blue
Contains:
\family default
\shape default
\color inherit
 
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
attachment list below
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="left" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family sans
\shape smallcaps
\color blue
Program:
\family default
\shape default
\color inherit
 
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
KalmanFilterTechNote.Rnw
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="left" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family sans
\shape smallcaps
\color blue
Original Data:
\family default
\shape default
\color inherit
 
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
/scr/raf_data/DEEPWAVE/
\begin_inset Index idx
status open

\begin_layout Plain Layout
DEEPWAVE research project
\end_layout

\end_inset

 
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="left" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout

\family sans
\shape smallcaps
\color blue
Git:
\family default
\shape default
\color inherit
 
\end_layout

\end_inset
</cell>
<cell alignment="left" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Index idx
status open

\begin_layout Plain Layout
GitHub repository
\end_layout

\end_inset

https://github.com/WilliamCooper/KalmanFilterTechNote.git
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset ERT
status collapsed

\begin_layout Plain Layout


\backslash
attachm{
\end_layout

\end_inset

WindUncertainty.Rnw
\begin_inset Newline newline
\end_inset

WindUncertainty.pdf
\begin_inset Newline newline
\end_inset

chunks/*
\begin_inset Newline newline
\end_inset

SessionInfo
\begin_inset Newline newline
\end_inset

Ranadu_2.1-15-3-8.tar.gz
\begin_inset ERT
status collapsed

\begin_layout Plain Layout

}
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
clearpage
\end_layout

\begin_layout Plain Layout


\backslash
phantomsection 
\backslash
addcontentsline{toc}{section}{References}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset CommandInset label
LatexCommand label
name "sec:bibliography"

\end_inset

 
\end_layout

\begin_layout Standard
\begin_inset CommandInset bibtex
LatexCommand bibtex
bibfiles "WAC"
options "plainnat"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
clearpage
\end_layout

\begin_layout Plain Layout


\backslash
phantomsection 
\backslash
addcontentsline{toc}{section}{Variable Names and Acronyms}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset CommandInset index_print
LatexCommand printindex
type "var"

\end_inset


\begin_inset Index idx
status open

\begin_layout Plain Layout
Variable Names
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
clearpage
\end_layout

\begin_layout Plain Layout


\backslash
phantomsection 
\backslash
addcontentsline{toc}{section}{Index}
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
\begin_inset Foot
status collapsed

\begin_layout Plain Layout
** indicates that many similar entries are omitted.
\end_layout

\end_inset


\end_layout

\end_inset


\begin_inset CommandInset index_print
LatexCommand printindex
type "idx"

\end_inset


\end_layout

\begin_layout Standard
\begin_inset ERT
status open

\begin_layout Plain Layout

%
\backslash
centerline{-- Blank Page, End of this Technical Report --}
\end_layout

\begin_layout Plain Layout


\backslash
vfill
\backslash
eject
\end_layout

\begin_layout Plain Layout


\backslash
clearpage
\end_layout

\begin_layout Plain Layout


\backslash
addcontentsline{toc}{section}{End}
\end_layout

\end_inset


\end_layout

\end_body
\end_document
